<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ToyLAND 国家管理システム</title>
<style>
  body { margin:0; font-family: sans-serif; display:flex; height:100vh; }
  #map-container { flex:1; position:relative; }
  canvas, svg { width:100%; height:100%; display:block; }
  #side-panel { width:300px; background:#f0f0f0; padding:10px; overflow-y:auto; }
  .section { margin-bottom:20px; border:1px solid #ccc; padding:10px; border-radius:5px; }
  label { display:block; margin-top:5px; }
  input[type="text"], input[type="number"], select { width:100%; margin-top:3px; }
  button { margin-top:5px; width:100%; }
  #popup { display:none; position:absolute; background:white; border:1px solid #333; padding:10px; border-radius:5px; z-index:10; }
</style>
</head>
<body>
<div id="map-container">
  <canvas id="map-canvas"></canvas>
  <div id="popup"></div>
</div>
<div id="side-panel">
  <div class="section">
    <h3>国家情報</h3>
    <label>国名: <input type="text" id="countryName" value="ToyLAND"></label>
    <label>主義: <input type="text" id="ideology" value="民主主義"></label>
    <label>国家方針: <input type="text" id="policy" value="平和的開発"></label>
  </div>
  <div class="section">
    <h3>軍事</h3>
    <label>陸軍: <input type="number" id="army" value="1000"></label>
    <label>海軍: <input type="number" id="navy" value="500"></label>
    <label>空軍: <input type="number" id="airforce" value="300"></label>
    <label>徴兵人数: <input type="number" id="conscription" value="50"></label>
  </div>
  <div class="section">
    <h3>経済</h3>
    <label>税率(%): <input type="number" id="tax" value="10"></label>
    <label>通貨名: <input type="text" id="currency" value="ToyDollar"></label>
    <label>技術開発: <input type="text" id="tech" value="基礎技術"></label>
  </div>
  <div class="section">
    <h3>法律・議会</h3>
    <label>法律名: <input type="text" id="law" value="平和法"></label>
    <label>議会承認: <select id="lawApproved"><option value="true">承認</option><option value="false">未承認</option></select></label>
  </div>
  <div class="section">
    <h3>領土塗装</h3>
    <label>塗る色: <input type="color" id="fillColor" value="#00ff00"></label>
  </div>
  <button id="saveBtn">セーブ (JSON)</button>
  <button id="loadBtn">ロード (JSON)</button>
</div>

<script>
// ---- 変数 ----
const canvas = document.getElementById('map-canvas');
const ctx = canvas.getContext('2d');
const popup = document.getElementById('popup');
let fillColor = document.getElementById('fillColor').value;
let mapImage = new Image();
mapImage.src = 'https://kyouyuuno-to.f5.si/img/0001.svg'; // SVGでもPNGでも対応
mapImage.onload = () => { resizeCanvas(); ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height); };
window.addEventListener('resize', () => { resizeCanvas(); redrawMap(); });
canvas.addEventListener('click', canvasClick);
document.getElementById('fillColor').addEventListener('input', e => fillColor = e.target.value);

// ---- キャンバスサイズ調整 ----
function resizeCanvas() {
  canvas.width = canvas.parentElement.clientWidth;
  canvas.height = canvas.parentElement.clientHeight;
}

// ---- Flood Fill ----
function canvasClick(e) {
  const rect = canvas.getBoundingClientRect();
  const x = Math.floor(e.clientX - rect.left);
  const y = Math.floor(e.clientY - rect.top);
  const imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
  const targetColor = getPixel(imgData, x, y);
  const boundaryColors = [[128,128,128,255], [0,0,0,255]]; // 灰色と黒
  if (boundaryColors.some(c => colorMatch(c, targetColor))) return;
  floodFill(imgData, x, y, hexToRgba(fillColor), boundaryColors);
  ctx.putImageData(imgData, 0, 0);
}

// ---- Pixel操作 ----
function getPixel(imgData, x, y) {
  const i = (y*imgData.width + x)*4;
  return [imgData.data[i], imgData.data[i+1], imgData.data[i+2], imgData.data[i+3]];
}
function setPixel(imgData, x, y, color) {
  const i = (y*imgData.width + x)*4;
  [imgData.data[i], imgData.data[i+1], imgData.data[i+2], imgData.data[i+3]] = color;
}
function colorMatch(c1, c2) {
  return c1[0]===c2[0] && c1[1]===c2[1] && c1[2]===c2[2] && c1[3]===c2[3];
}
function hexToRgba(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return [r,g,b,255];
}

// ---- Flood Fillアルゴリズム ----
function floodFill(imgData, x, y, fillColor, boundaryColors) {
  const width = imgData.width, height = imgData.height;
  const stack = [[x,y]];
  const visited = new Uint8Array(width*height);
  const targetColor = getPixel(imgData,x,y);
  while(stack.length) {
    const [cx, cy] = stack.pop();
    const idx = cy*width + cx;
    if (cx<0||cy<0||cx>=width||cy>=height) continue;
    if (visited[idx]) continue;
    visited[idx] = 1;
    const color = getPixel(imgData,cx,cy);
    if(boundaryColors.some(c=>colorMatch(c,color))) continue;
    if(colorMatch(color,targetColor)) {
      setPixel(imgData,cx,cy,fillColor);
      stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
    }
  }
}

// ---- 再描画 ----
function redrawMap() {
  ctx.drawImage(mapImage,0,0,canvas.width,canvas.height);
}

// ---- JSONセーブ/ロード ----
document.getElementById('saveBtn').addEventListener('click',()=>{
  const data = {
    countryName: document.getElementById('countryName').value,
    ideology: document.getElementById('ideology').value,
    policy: document.getElementById('policy').value,
    army: document.getElementById('army').value,
    navy: document.getElementById('navy').value,
    airforce: document.getElementById('airforce').value,
    conscription: document.getElementById('conscription').value,
    tax: document.getElementById('tax').value,
    currency: document.getElementById('currency').value,
    tech: document.getElementById('tech').value,
    law: document.getElementById('law').value,
    lawApproved: document.getElementById('lawApproved').value,
    mapImage: canvas.toDataURL()
  };
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='save.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('loadBtn').addEventListener('click',()=>{
  const input = document.createElement('input'); input.type='file';
  input.onchange = e=>{
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev=>{
      const data = JSON.parse(ev.target.result);
      document.getElementById('countryName').value = data.countryName;
      document.getElementById('ideology').value = data.ideology;
      document.getElementById('policy').value = data.policy;
      document.getElementById('army').value = data.army;
      document.getElementById('navy').value = data.navy;
      document.getElementById('airforce').value = data.airforce;
      document.getElementById('conscription').value = data.conscription;
      document.getElementById('tax').value = data.tax;
      document.getElementById('currency').value = data.currency;
      document.getElementById('tech').value = data.tech;
      document.getElementById('law').value = data.law;
      document.getElementById('lawApproved').value = data.lawApproved;
      const img = new Image();
      img.onload = ()=>{ ctx.drawImage(img,0,0,canvas.width,canvas.height); };
      img.src = data.mapImage;
    };
    reader.readAsText(file);
  };
  input.click();
});
</script>
</body>
</html>
