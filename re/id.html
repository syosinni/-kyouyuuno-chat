<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å›½å®¶é‹å–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ å®Œå…¨ç‰ˆ</title>
<style>
body { display:flex; margin:0; font-family:sans-serif; overflow:hidden; }
#mapArea { flex:3; border:1px solid #333; position:relative; overflow:hidden; min-width:600px; }
#countryList { flex:1; border-left:2px solid #666; padding:10px; overflow-y:auto; min-width:300px; }
.country-item { border:1px solid #ccc; margin:5px; padding:5px; border-radius:8px; background:#f9f9f9; }
.troop { position:absolute; border:2px solid #000; cursor:pointer; }
#controls { position:absolute; top:10px; left:10px; background:#fff; padding:5px; border-radius:8px; z-index:10; }
button { margin:2px; padding:6px 12px; font-size:14px; }
.diplomacyLine { position:absolute; height:3px; z-index:0; pointer-events:none; }
.tab { margin-top:10px; border-top:1px solid #aaa; padding-top:5px; }
.tab h4 { margin:2px 0; }
</style>
</head>
<body>
<div id="mapArea">
  <div id="controls">
    <button id="zoomIn">ï¼‹</button>
    <button id="zoomOut">ï¼</button>
    <button id="nextMonth">â–¶ æ¬¡ã®æœˆ</button>
    <button id="saveBtn">ğŸ’¾ä¿å­˜</button>
    <input type="file" id="loadFile" style="display:none"/>
    <button id="loadBtn">ğŸ“‚èª­ã¿è¾¼ã¿</button>
    <div id="timeDisplay">å¹´:2000 æœˆ:1</div>
    <button onclick="requestNewCountry()">ï¼‹å›½ç”³è«‹</button>
  </div>
  <svg id="map" xmlns="http://www.w3.org/2000/svg" width="100%" height="100%">
    <image href="https://kyouyuuno-to.f5.si/img/0001.svg" width="100%" height="100%"/>
  </svg>
</div>
<div id="countryList"><h3>å›½å®¶ãƒªã‚¹ãƒˆ</h3></div>

<script>
let countryData=[], scale=1, year=2000, month=1;
let selectedCountry=null, movingTroop=null;
let troopElements=[], diplomacyLines=[];

const resourceList=["é‰„","çŸ³æ²¹","å°éº¦","æœ¨æ","é‡‘","éŠ€","éŠ…","å¸Œå°‘é‡‘å±","çŸ³ç‚­","æ°´"];
const ministryTemplates=["å›½é˜²çœ","çµŒæ¸ˆçœ","å¤–äº¤çœ","è¾²æ¥­çœ","ç§‘å­¦çœ","å†…å‹™çœ","å¤–å‹™çœ","è²¡å‹™çœ","æ•™è‚²çœ","åŒ»ç™‚çœ",
"é˜²ç½çœ","å·¥æ¥­çœ","é‹è¼¸çœ","ã‚¨ãƒãƒ«ã‚®ãƒ¼çœ","åŠ´åƒçœ","æƒ…å ±çœ","æ²»å®‰çœ","è¦³å…‰çœ","ç’°å¢ƒçœ","æŠ€è¡“çœ"];
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

// --- å›½å®¶ç”³è«‹ ---
function requestNewCountry(){
  const name=prompt("å›½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  if(!name) return;
  const ideology=prompt("ä¸»ç¾©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
  const population=rand(10000,1000000);
  const currency=name.slice(0,3).toUpperCase()+"$";
  const rate=parseFloat((Math.random()*5).toFixed(2)); 
  const country={ name, ideology, population, soldiers:0, budget:1000, taxRate:10,
    diplomacy:{}, resources:{}, currency, rate,
    troops:[], ministries:[], laws:[], parliament:[] };
  resourceList.forEach(r=>{ country.resources[r]=rand(50,200); });
  ministryTemplates.forEach(m=>{ country.ministries.push({name:m,effect:1.0,minister:"æœªä»»å‘½"}); });
  countryData.push(country);
  updateCountryList();
  drawDiplomacy();
}

// --- å›½ãƒªã‚¹ãƒˆæ›´æ–° ---
function updateCountryList(){
  const div=document.getElementById('countryList');
  div.innerHTML="<h3>å›½å®¶ãƒªã‚¹ãƒˆ</h3>";
  countryData.forEach(c=>{
    const d=document.createElement('div');
    d.className="country-item";
    d.innerHTML=`<b>${c.name}</b><br>
    ä¸»ç¾©:${c.ideology}<br>
    äººå£:${c.population.toLocaleString()}<br>
    å…µå£«:${c.soldiers}<br>
    äºˆç®—:${c.budget.toLocaleString()}<br>
    é€šè²¨:${c.currency} (1å††=${c.rate.toFixed(2)}${c.currency})<br>
    <button onclick="recruit('${c.name}')">å¾´å…µ</button>
    <button onclick="setTax('${c.name}')">ç¨ç‡å¤‰æ›´</button>
    <button onclick="addTroop('${c.name}')">å…µé…ç½®</button>
    <button onclick="trade('${c.name}')">è²¿æ˜“</button>
    <button onclick="diplomacy('${c.name}')">å¤–äº¤</button>
    <button onclick="viewMinistries('${c.name}')">çœåº</button>
    <button onclick="parliament('${c.name}')">è­°ä¼š</button>`;
    div.appendChild(d);
  });
}

// --- å¾´å…µ ---
function recruit(name){
  const c=countryData.find(x=>x.name===name);
  const num=rand(50,500);
  if(c.budget>=num*10){ c.budget-=num*10; c.soldiers+=num; alert(`${name} ã¯${num}äººå¾´å…µã—ã¾ã—ãŸ`);}
  else alert("äºˆç®—ä¸è¶³");
  updateCountryList();
}

// --- ç¨ç‡å¤‰æ›´ ---
function setTax(name){
  const c=countryData.find(x=>x.name===name);
  const t=parseInt(prompt("æ–°ã—ã„ç¨ç‡(0-100%)",c.taxRate));
  if(!isNaN(t) && t>=0 && t<=100) c.taxRate=t;
  updateCountryList();
}

// --- å…µå£«é…ç½® ---
function addTroop(name){ selectedCountry=name; alert("å…µå£«ã‚’é…ç½®ã™ã‚‹å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯"); }

document.getElementById('map').addEventListener('click',e=>{
  if(!selectedCountry && !movingTroop) return;
  const rect=document.getElementById('mapArea').getBoundingClientRect();
  const x=(e.clientX-rect.left)/scale, y=(e.clientY-rect.top)/scale;

  if(selectedCountry){
    const c=countryData.find(x=>x.name===selectedCountry);
    if(c.soldiers<=0){alert("å…µå£«ãŒã„ã¾ã›ã‚“"); return;}
    const t={x,y,size:20}; c.troops.push(t);
    drawTroops(); selectedCountry=null; updateCountryList();
  } else if(movingTroop){
    const {country,troopIndex}=movingTroop;
    const c=countryData.find(x=>x.name===country);
    if(c){ c.troops[troopIndex].x=x; c.troops[troopIndex].y=y; }
    drawTroops(); movingTroop=null;
  }
});

// --- é•·æŠ¼ã—(ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç”³è«‹) ---
let touchTimer;
document.getElementById('map').addEventListener('touchstart',e=>{
  touchTimer=setTimeout(()=>{ requestNewCountry(); },600);
});
document.getElementById('map').addEventListener('touchend',()=>{ clearTimeout(touchTimer); });

// --- å…µå£«æç”» ---
function drawTroops(){
  troopElements.forEach(el=>el.remove()); troopElements=[];
  countryData.forEach(c=>{
    c.troops.forEach((t,i)=>{
      const el=document.createElement('div');
      el.className="troop";
      const size=20+Math.sqrt(c.soldiers)/2;
      el.style.left=(t.x*scale)+"px"; el.style.top=(t.y*scale)+"px";
      el.style.width=size+"px"; el.style.height=size+"px";
      el.style.background=c.ideology.includes("æˆ¦")?"red":"blue";
      el.title=c.name+"è»";
      el.addEventListener('mousedown',()=>{ movingTroop={country:c.name,troopIndex:i}; });
      document.getElementById('mapArea').appendChild(el);
      troopElements.push(el);
    });
  });
}

// --- è²¿æ˜“ ---
function trade(name){
  const c=countryData.find(x=>x.name===name);
  const r=prompt("è³‡æºã‚’é¸æŠ:\n"+resourceList.join(","));
  if(!r||!resourceList.includes(r)) return;
  const q=parseInt(prompt("æ•°é‡"));
  if(isNaN(q)||q<=0) return;
  const price=rand(5,50);
  const cost=q*price;
  if(confirm(`${r}${q}ã‚’å–å¼•ã—ã¾ã™(å˜ä¾¡:${price})`)){
    if(Math.random()>0.5){ if(c.resources[r]>=q){ c.resources[r]-=q; c.budget+=cost; } else alert("è³‡æºä¸è¶³");}
    else { if(c.budget>=cost){ c.resources[r]+=q; c.budget-=cost; } else alert("äºˆç®—ä¸è¶³"); }
  }
  updateCountryList();
}

// --- å¤–äº¤ ---
function diplomacy(name){
  const c=countryData.find(x=>x.name===name);
  const other=prompt("å¤–äº¤ç›¸æ‰‹å›½åã‚’å…¥åŠ›");
  if(!other||!countryData.find(x=>x.name===other)) return;
  const rel=prompt("é–¢ä¿‚ã‚’å…¥åŠ›: ä¸­ç«‹/å‹å¥½/åŒç›Ÿ/è»äº‹åŒç›Ÿ/çµŒæ¸ˆåŒç›Ÿ/å¾“å±å›½/å®£æˆ¦å¸ƒå‘Š/è²¿æ˜“å”å®š");
  c.diplomacy[other]=rel;
  drawDiplomacy(); updateCountryList();
}

// --- å¤–äº¤ç·šè¡¨ç¤º ---
function drawDiplomacy(){
  diplomacyLines.forEach(el=>el.remove()); diplomacyLines=[];
  countryData.forEach(c=>{
    for(const [other,rel] of Object.entries(c.diplomacy)){
      const oc=countryData.find(x=>x.name===other); if(!oc) continue;
      c.troops.forEach(t1=>{ oc.troops.forEach(t2=>{
        const line=document.createElement('div');
        line.className="diplomacyLine";
        line.style.left=Math.min(t1.x,t2.x)*scale+"px";
        line.style.top=Math.min(t1.y,t2.y)*scale+"px";
        line.style.width=Math.abs(t1.x-t2.x)*scale+"px";
        line.style.background=rel.includes("æ•µ")?"red":"green";
        document.getElementById('mapArea').appendChild(line); diplomacyLines.push(line);
      })})
    }
  });
}

// --- çœåº ---
function viewMinistries(name){
  const c=countryData.find(x=>x.name===name);
  let txt="çœåºæƒ…å ±:\n";
  c.ministries.forEach(m=>{ txt+=`${m.name} åŠ¹æœ:${m.effect} å¤§è‡£:${m.minister}\n`; });
  alert(txt);
}

// --- è­°ä¼š ---
function parliament(name){
  const c=countryData.find(x=>x.name===name);
  let txt="è­°ä¼š:\n1. æ³•å¾‹åˆ¶å®š\n2. ç¨ç‡å¤‰æ›´\n3. å¾´å…µæ³•\n4. æ¡ç´„æ‰¿èª\nç•ªå·å…¥åŠ›ã§é¸æŠ";
  const choice=prompt(txt);
  if(choice=="1"){ const law=prompt("æ³•å¾‹å"); c.laws.push(law); alert("æ³•å¾‹åˆ¶å®š:"+law);}
  else if(choice=="2"){ setTax(name);}
  else if(choice=="3"){ recruit(name);}
  else if(choice=="4"){ diplomacy(name);}
}

// --- æ™‚é–“çµŒé ---
document.getElementById('nextMonth').addEventListener('click',()=>{
  month++; if(month>12){month=1;year++;}
  countryData.forEach(c=>{
    const growth=Math.floor(c.population*0.005); c.population+=growth;
    const income=Math.floor(c.population*c.taxRate/1000); c.budget+=income;
    resourceList.forEach(r=>{c.resources[r]=(c.resources[r]||0)+rand(10,50);});
    c.rate+=(Math.random()-0.5)*0.1; if(c.rate<0.1)c.rate=0.1;
  });
  document.getElementById('timeDisplay').textContent=`å¹´:${year} æœˆ:${month}`;
  updateCountryList(); drawTroops(); drawDiplomacy();
});

// --- ä¿å­˜/èª­ã¿è¾¼ã¿ ---
document.getElementById('saveBtn').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(countryData)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
  a.download="countries.json"; a.click();
});
document.getElementById('loadBtn').addEventListener('click',()=>{document.getElementById('loadFile').click();});
document.getElementById('loadFile').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ countryData=JSON.parse(reader.result); updateCountryList(); drawTroops(); drawDiplomacy(); };
  reader.readAsText(file);
});

// --- ã‚ºãƒ¼ãƒ  ---
document.getElementById('zoomIn').addEventListener('click',()=>{ scale*=1.2; document.getElementById('map').style.transform=`scale(${scale})`; drawTroops(); drawDiplomacy(); });
document.getElementById('zoomOut').addEventListener('click',()=>{ scale/=1.2; document.getElementById('map').style.transform=`scale(${scale})`; drawTroops(); drawDiplomacy(); });

</script>
</body>
</html>
