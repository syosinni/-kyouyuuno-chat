<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界地図バケツ塗り</title>
<style>
  body { text-align: center; }
  canvas { border:1px solid #000; cursor: crosshair; }
</style>
</head>
<body>

<h3>色と国名を選択してクリックで塗る</h3>
<label>色: <input type="color" id="colorPicker" value="#ff0000"></label>
<label>国名: <input type="text" id="countryName" value="国名"></label>
<br><br>
<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let scale = 1; // ズーム倍率
const img = new Image();
img.crossOrigin = "anonymous";
img.src = "https://kyouyuuno-to.f5.si/img/0001.svg";

// 描画サイズ調整
img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    draw();
}

// 描画関数（ズーム対応）
function draw() {
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);
    drawLabels();
}

// ラベル管理
let labels = []; // {x,y,text,color}

// ラベル描画
function drawLabels(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.font = "14px sans-serif";
    ctx.fillStyle = "black";
    ctx.textAlign = "center";
    labels.forEach(l=>{
        ctx.fillStyle = l.color;
        ctx.fillText(l.text, l.x, l.y);
    });
}

// Flood Fill
function floodFill(x,y,fillColor){
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imgData.data;
    const width = canvas.width;
    const idx = (x + y*width)*4;
    const targetColor = [data[idx], data[idx+1], data[idx+2]];

    if(targetColor[0]===fillColor.r && targetColor[1]===fillColor.g && targetColor[2]===fillColor.b) return;

    const stack = [[x,y]];
    while(stack.length){
        const [cx,cy] = stack.pop();
        const i = (cx + cy*width)*4;
        const c = [data[i], data[i+1], data[i+2]];

        if(c[0]===255 && c[1]===255 && c[2]===255){ // 白だけ塗る
            data[i] = fillColor.r;
            data[i+1] = fillColor.g;
            data[i+2] = fillColor.b;
            data[i+3] = 255;

            if(cx>0) stack.push([cx-1,cy]);
            if(cx<width-1) stack.push([cx+1,cy]);
            if(cy>0) stack.push([cx,cy-1]);
            if(cy<height-1) stack.push([cx,cy+1]);
        }
    }
    ctx.putImageData(imgData,0,0);
}

// クリック処理
canvas.addEventListener('click', e=>{
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left)/scale);
    const y = Math.floor((e.clientY - rect.top)/scale);
    const colorHex = document.getElementById('colorPicker').value;
    const country = document.getElementById('countryName').value || "国名";

    // RGB変換
    const fillColor = {
        r: parseInt(colorHex.slice(1,3),16),
        g: parseInt(colorHex.slice(3,5),16),
        b: parseInt(colorHex.slice(5,7),16)
    };

    floodFill(x,y,fillColor);
    labels.push({x:x, y:y, text:country, color: colorHex});
    draw();
});

// ホイールでズーム
canvas.addEventListener('wheel', e=>{
    e.preventDefault();
    const delta = e.deltaY>0 ? 0.9 : 1.1;
    scale *= delta;
    draw();
});
</script>

</body>
</html>
