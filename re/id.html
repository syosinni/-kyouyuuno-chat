<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界地図シミュレーション 超完全版</title>
<style>
body { margin:0; font-family:sans-serif; display:flex; height:100vh; }
#mapContainer { flex:1; display:flex; flex-direction:column; align-items:center; padding:10px; }
canvas { border:1px solid #000; cursor:crosshair; }
.controls { margin:10px; display:flex; flex-wrap:wrap; gap:10px; }
#countryList { width:400px; border-left:1px solid #ccc; overflow-y:auto; padding:5px; background:#f9f9f9; }
.countryItem { border-bottom:1px solid #ccc; padding:5px; font-size:14px; }
.countryItem button { margin-left:5px; }
.colorBox { width:20px; height:20px; display:inline-block; margin-right:5px; border:1px solid #000; vertical-align:middle; }
</style>
</head>
<body>

<div id="mapContainer">
  <div class="controls">
    <label>塗る色: <input type="color" id="colorPicker" value="#ff0000"></label>
    <label>国名: <input type="text" id="countryName" placeholder="国名"></label>
    <label>主義: <input type="text" id="ideology" placeholder="主義"></label>
    <label>代表: <input type="text" id="leader" placeholder="代表"></label>
    <label>税率(0~100%): <input type="number" id="taxRate" min="0" max="100" step="1" value="0"></label>
    <button id="zoomIn">拡大</button>
    <button id="zoomOut">縮小</button>
    <button id="nextMonth">1か月進める</button>
    <span id="timeDisplay">年:0 月:1</span>
  </div>
  <canvas id="canvas"></canvas>
</div>

<div id="countryList"></div>

<script>
const svgUrl = "https://kyouyuuno-to.f5.si/img/0001.svg";
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let scale = 1;
let mapImg = new Image();
mapImg.crossOrigin = "anonymous";
mapImg.onload = () => { canvas.width=mapImg.width; canvas.height=mapImg.height; drawMap(); };
mapImg.src = svgUrl;

let countryData = [];
let month=1, year=0;
const resourceList = ["木材","石油","鉄鉱石","金","食料"];
const ministryTemplates = [
    {name:"財務省",effect:{budget:0.1},minister:""},
    {name:"国防省",effect:{soldierBoost:0.05},minister:""},
    {name:"外務省",effect:{diplomacyBonus:0.1},minister:""},
    {name:"農林水産省",effect:{foodBoost:0.1},minister:""},
    {name:"経済産業省",effect:{resourceBoost:0.1},minister:""},
    {name:"環境省",effect:{resourceBoost:0.05},minister:""},
    {name:"厚生労働省",effect:{populationGrowth:0.05},minister:""},
    {name:"文部科学省",effect:{educationBonus:0.05},minister:""},
    {name:"運輸省",effect:{transportBoost:0.05},minister:""},
    {name:"警察庁",effect:{internalSecurity:0.05},minister:""},
    {name:"海上保安庁",effect:{navyBoost:0.05},minister:""},
    {name:"原子力規制委員会",effect:{energyBoost:0.1},minister:""},
    {name:"情報通信省",effect:{techBoost:0.05},minister:""},
    {name:"観光庁",effect:{incomeBoost:0.05},minister:""},
    {name:"文化庁",effect:{cultureBoost:0.05},minister:""},
    {name:"消費者庁",effect:{resourceBoost:0.05},minister:""},
    {name:"総務省",effect:{adminBoost:0.05},minister:""},
    {name:"科学技術省",effect:{techBoost:0.1},minister:""},
    {name:"復興庁",effect:{budgetBoost:0.05},minister:""},
    {name:"宇宙開発省",effect:{techBoost:0.1},minister:""}
];

// HEX→RGBA
function hexToRGBA(hex){ return {r:parseInt(hex.slice(1,3),16), g:parseInt(hex.slice(3,5),16), b:parseInt(hex.slice(5,7),16), a:255}; }

// Flood Fill
function getRegionPixels(x,y){
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const data=imgData.data;
    const width=canvas.width;
    const stack=[[x,y]];
    const visited=new Set();
    const pixels=[];
    const key=(x,y)=>`${x},${y}`;
    while(stack.length){
        const [cx,cy]=stack.pop();
        if(cx<0||cy<0||cx>=width||cy>=canvas.height) continue;
        if(visited.has(key(cx,cy))) continue;
        const i=(cx+cy*width)*4;
        const c=[data[i],data[i+1],data[i+2]];
        if(c[0]===255 && c[1]===255 && c[2]===255){
            pixels.push({x:cx,y:cy});
            visited.add(key(cx,cy));
            stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
        }
    }
    return pixels;
}

// 塗る
function fillRegion(pixels,colorHex){
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const data=imgData.data;
    const col=hexToRGBA(colorHex);
    pixels.forEach(p=>{
        const i=(p.x + p.y*canvas.width)*4;
        data[i]=col.r; data[i+1]=col.g; data[i+2]=col.b; data[i+3]=col.a;
    });
    ctx.putImageData(imgData,0,0);
}

// 描画
function drawMap(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(mapImg,0,0);
    countryData.forEach(c=>c.regions.forEach(r=>fillRegion(r.pixels,c.colorHex)));
    // 兵士表示
    countryData.forEach(c=>{
        if(c.troops){
            c.troops.forEach(t=>{
                ctx.fillStyle='black';
                ctx.beginPath();
                ctx.arc(t.x,t.y,4,0,Math.PI*2);
                ctx.fill();
            });
        }
    });
}

// 国家リスト更新
function updateCountryList(){
    const listDiv=document.getElementById('countryList'); listDiv.innerHTML='';
    countryData.forEach((c,i)=>{
        const div=document.createElement('div');
        div.className='countryItem';
        const resStr = Object.entries(c.resources).map(([k,v])=>`${k}:${v}`).join(", ");
        const ministries=c.ministries?c.ministries.map(m=>m.name).join(", "):"なし";
        div.innerHTML=`
        <div>
            <span class="colorBox" style="background:${c.colorHex}"></span>${c.name}<br>
            主義:${c.ideology} 代表:${c.leader}<br>
            人口:${c.population.toLocaleString()} 兵士:${c.soldiers} 予算:${(c.budget||0).toLocaleString()}<br>
            税率:${c.taxRate}% 外交:${c.diplomacy||'なし'}<br>
            資源:${resStr}<br>
            省庁:${ministries}<br>
            <button data-index="${i}" class="editBtn">編集</button>
            <button data-index="${i}" class="consBtn">徴兵</button>
            <button data-index="${i}" class="troopBtn">兵配置</button>
            <button data-index="${i}" class="tradeBtn">貿易</button>
            <button data-index="${i}" class="diplomacyBtn">外交</button>
            <button data-index="${i}" class="ministryBtn">省庁管理</button>
        </div>`;
        listDiv.appendChild(div);
    });
}

// 省庁管理
function manageMinistry(country){
    let templateNames = ministryTemplates.map(t=>t.name).join(", ");
    let choice = prompt(`省庁を追加/編集: テンプレートから選択\n${templateNames}`);
    const template = ministryTemplates.find(t=>t.name===choice);
    if(!template) return;
    if(!country.ministries) country.ministries=[];
    const ministerName = prompt("大臣の名前を入力", template.minister);
    country.ministries.push({...template, minister:ministerName});
    updateCountryList();
}

// 左クリックで塗り＋ステート追加
canvas.addEventListener('click',e=>{
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/scale);
    const y=Math.floor((e.clientY-rect.top)/scale);

    const colorHex=document.getElementById('colorPicker').value;
    const countryName=document.getElementById('countryName').value.trim()||'名前なし';
    const ideology=document.getElementById('ideology').value.trim()||'なし';
    const leader=document.getElementById('leader').value.trim()||'なし';
    const taxRate=parseInt(document.getElementById('taxRate').value)||0;

    const pixels=getRegionPixels(x,y); if(pixels.length===0) return;
    fillRegion(pixels,colorHex);

    let country=countryData.find(c=>c.name===countryName);
    const randPop=Math.floor(Math.random()*(50000000-1000000+1))+1000000;
    const newResources = {};
    resourceList.forEach(r=>{ newResources[r]=Math.floor(Math.random()*1000)+100; });

    if(country){
        country.regions.push({pixels:pixels});
        country.population+=randPop;
        country.ideology=ideology;
        country.leader=leader;
        country.colorHex=colorHex;
        country.resources={...country.resources,...newResources};
        country.taxRate=taxRate;
    } else {
        countryData.push({
            name:countryName,colorHex:colorHex,ideology:ideology,leader:leader,
            population:randPop,soldiers:0,regions:[{pixels:pixels}],
            resources:newResources,taxRate:taxRate,budget:0,troops:[],ministries:[]
        });
    }
    drawMap(); updateCountryList();
});

// 右クリックで情報表示
canvas.addEventListener('contextmenu', e=>{
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/scale);
    const y=Math.floor((e.clientY-rect.top)/scale);
    let found=false;
    for(const country of countryData){
        for(const region of country.regions){
            if(region.pixels.some(p=>p.x===x && p.y===y)){
                const resStr = Object.entries(country.resources).map(([k,v])=>`${k}:${v}`).join(", ");
                const troopCount=country.troops?country.troops.length:0;
                const ministries=country.ministries?country.ministries.map(m=>`${m.name}(${m.minister})`).join(", "):"なし";
                alert(`国名: ${country.name}\n主義: ${country.ideology}\n代表: ${country.leader}\n人口: ${country.population.toLocaleString()}\n兵士:${country.soldiers} 配置済み:${troopCount}\n予算:${(country.budget||0).toLocaleString()}\n税率:${country.taxRate}%\n外交:${country.diplomacy||'なし'}\n資源:${resStr}\n省庁:${ministries}`);
                found=true; break;
            }
        }
        if(found) break;
    }
    if(!found) alert("ここには国情報はありません");
});

// 国家リスト操作（編集・徴兵・兵配置・貿易・外交・省庁）
document.getElementById('countryList').addEventListener('click',e=>{
    const idx=parseInt(e.target.dataset.index);
    if(isNaN(idx)) return;
    const c=countryData[idx];
    if(e.target.classList.contains('editBtn')){
        const newName=prompt("国名を変更",c.name); if(newName)c.name=newName;
        const newColor=prompt("色をHEXで変更",c.colorHex); if(newColor)c.colorHex=newColor;
        const newIdeology=prompt("主義を変更",c.ideology); if(newIdeology)c.ideology=newIdeology;
        const newLeader=prompt("代表を変更",c.leader); if(newLeader)c.leader=newLeader;
        const newPop=parseInt(prompt("人口を変更",c.population)); if(newPop>0)c.population=newPop;
        const newTax=parseInt(prompt("税率(0~100%)",c.taxRate||0)); if(!isNaN(newTax)&&newTax>=0 && newTax<=100)c.taxRate=newTax;
        drawMap(); updateCountryList();
    }
    if(e.target.classList.contains('consBtn')){
        const num=parseInt(prompt("徴兵する人数を入力",Math.floor(c.population*0.1)));
        if(num>0){
            const max=Math.floor(c.population*0.1);
            const actual=Math.min(num,max);
            c.population-=actual; c.soldiers+=actual;
            updateCountryList();
        }
    }
    if(e.target.classList.contains('troopBtn')){
        const num=parseInt(prompt("配置する兵士数を入力",Math.min(c.soldiers,1)));
        for(let i=0;i<num;i++){
            canvas.addEventListener('click', function handler(ev){
                const rect=canvas.getBoundingClientRect();
                const x=Math.floor((ev.clientX-rect.left)/scale);
                const y=Math.floor((ev.clientY-rect.top)/scale);
                // 配置可否チェック
                let targetCountry=null;
                for(const ct of countryData){
                    for(const region of ct.regions){
                        if(region.pixels.some(p=>p.x===x && p.y===y)){ targetCountry=ct; break;}
                    }
                    if(targetCountry) break;
                }
                if(targetCountry && (targetCountry.name===c.name || targetCountry.diplomacy==='同盟')){
                    if(!c.troops)c.troops=[];
                    c.troops.push({x:x,y:y});
                    c.soldiers-=1;
                    drawMap(); updateCountryList();
                    canvas.removeEventListener('click',handler);
                } else {
                    alert("ここには兵を配置できません");
                }
            });
        }
    }
    if(e.target.classList.contains('tradeBtn')){
        const targetName=prompt("貿易相手国名を入力"); 
        const target=countryData.find(t=>t.name===targetName);
        if(!target){ alert("存在しません"); return;}
        const resName=prompt("資源名を入力");
        if(!c.resources[resName]||c.resources[resName]<=0){alert("資源不足"); return;}
        const amount=parseInt(prompt("数量を入力",1));
        const price=amount*10;
        if(c.resources[resName]<amount){ alert("資源不足"); return;}
        c.resources[resName]-=amount; c.budget=(c.budget||0)+price;
        target.resources[resName]=(target.resources[resName]||0)+amount;
        target.budget=(target.budget||0)-price;
        updateCountryList();
        alert(`取引成功: ${amount} ${resName} を ${target.name}に販売`);
    }
    if(e.target.classList.contains('diplomacyBtn')){
        const status=prompt("外交関係を設定（友好/同盟/敵対）","友好");
        c.diplomacy=status;
        updateCountryList();
    }
    if(e.target.classList.contains('ministryBtn')){
        manageMinistry(c);
    }
});

// ズーム
document.getElementById('zoomIn').addEventListener('click',()=>{scale*=1.2; drawMap();});
document.getElementById('zoomOut').addEventListener('click',()=>{scale/=1.2; drawMap();});

// 時間経過
document.getElementById('nextMonth').addEventListener('click',()=>{
    month++; if(month>12){ month=1; year++; }
    countryData.forEach(c=>{
        const growth=Math.floor(c.population*0.01); c.population+=growth;
        const taxIncome=Math.floor(c.population*c.taxRate/100);
        c.budget=(c.budget||0)+taxIncome;
        // 資源自動生成
        resourceList.forEach(r=>{ c.resources[r]=(c.resources[r]||0)+Math.floor(Math.random()*100+50); });
        // 戦闘解決
        if(c.troops && c.troops.length>0){
            // 簡易戦闘: 他国兵士と衝突で勝敗判定
            for(let t of c.troops){
                for(const other of countryData){
                    if(other===c) continue;
                    if(other.troops && other.troops.some(ot=>Math.abs(ot.x-t.x)<5 && Math.abs(ot.y-t.y)<5)){
                        if(c.soldiers>other.soldiers){
                            other.soldiers= Math.max(0, other.soldiers- Math.floor(c.soldiers*0.5));
                        } else {
                            c.soldiers= Math.max(0, c.soldiers- Math.floor(other.soldiers*0.5));
                        }
                    }
                }
            }
        }
    });
    document.getElementById('timeDisplay').textContent=`年:${year} 月:${month}`;
    drawMap(); updateCountryList();
});
</script>
</body>
</html>
