<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界地図シミュレーション完全版</title>
<style>
body { display:flex; flex-direction:column; align-items:center; margin:20px; font-family:sans-serif; }
canvas { border:1px solid #000; cursor:crosshair; margin-top:10px; }
.controls { margin:10px; }
#countryList { margin-top:10px; max-height:300px; overflow:auto; border:1px solid #ccc; width:600px; padding:5px;}
.countryItem { display:flex; justify-content:space-between; padding:2px 5px; cursor:pointer; align-items:center; font-size:14px; }
.colorBox { width:20px; height:20px; display:inline-block; margin-right:5px; border:1px solid #000; vertical-align:middle; }
</style>
</head>
<body>

<div class="controls">
  <label>塗る色: <input type="color" id="colorPicker" value="#ff0000"></label>
  <label>国名: <input type="text" id="countryName" placeholder="国名"></label>
  <label>主義: <input type="text" id="ideology" placeholder="主義"></label>
  <label>代表: <input type="text" id="leader" placeholder="代表"></label>
  <button id="zoomIn">拡大</button>
  <button id="zoomOut">縮小</button>
  <button id="nextMonth">1か月進める</button>
  <span id="timeDisplay">年:0 月:1</span>
</div>

<canvas id="canvas"></canvas>
<div id="countryList"></div>

<script>
const svgUrl = "https://kyouyuuno-to.f5.si/img/0001.svg";
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let scale = 1;

let mapImg = new Image();
mapImg.crossOrigin = "anonymous";
mapImg.onload = () => { canvas.width=mapImg.width; canvas.height=mapImg.height; drawMap(); };
mapImg.src = svgUrl;

let countryData = [];
let month=1, year=0;

const resourceList = ["木材","石油","鉄鉱石","金","食料"];

// HEX→RGBA
function hexToRGBA(hex){ return {r:parseInt(hex.slice(1,3),16), g:parseInt(hex.slice(3,5),16), b:parseInt(hex.slice(5,7),16), a:255}; }

// Flood Fillで領域ピクセル取得
function getRegionPixels(x,y){
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const data=imgData.data;
    const width=canvas.width;
    const stack=[[x,y]];
    const visited=new Set();
    const pixels=[];
    const key=(x,y)=>`${x},${y}`;

    while(stack.length){
        const [cx,cy]=stack.pop();
        if(cx<0||cy<0||cx>=width||cy>=canvas.height) continue;
        if(visited.has(key(cx,cy))) continue;

        const i=(cx+cy*width)*4;
        const c=[data[i],data[i+1],data[i+2]];
        if(c[0]===255 && c[1]===255 && c[2]===255){
            pixels.push({x:cx,y:cy});
            visited.add(key(cx,cy));
            stack.push([cx+1,cy]);
            stack.push([cx-1,cy]);
            stack.push([cx,cy+1]);
            stack.push([cx,cy-1]);
        }
    }
    return pixels;
}

// 領域塗り
function fillRegion(pixels,colorHex){
    const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
    const data=imgData.data;
    const col=hexToRGBA(colorHex);
    pixels.forEach(p=>{
        const i=(p.x + p.y*canvas.width)*4;
        data[i]=col.r; data[i+1]=col.g; data[i+2]=col.b; data[i+3]=col.a;
    });
    ctx.putImageData(imgData,0,0);
}

// 描画
function drawMap(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(mapImg,0,0);
    countryData.forEach(c=>c.regions.forEach(r=>fillRegion(r.pixels,c.colorHex)));
}

// 国リスト更新
function updateCountryList(){
    const listDiv=document.getElementById('countryList'); listDiv.innerHTML='';
    countryData.forEach((c,i)=>{
        const div=document.createElement('div');
        div.className='countryItem';
        const resStr = Object.entries(c.resources).map(([k,v])=>`${k}:${v}`).join(", ");
        div.innerHTML=`<span><span class="colorBox" style="background:${c.colorHex}"></span>${c.name}</span>
        <span>${c.ideology}</span><span>${c.leader}</span>
        <span>人口:${c.population.toLocaleString()}</span>
        <span>兵士:${c.soldiers}</span>
        <span>資源:${resStr}</span>
        <span>税率:${(c.taxRate*100||0)}%</span>
        <button data-index="${i}">編集</button>`;
        listDiv.appendChild(div);
    });
}

// 編集ボタン
document.getElementById('countryList').addEventListener('click',e=>{
    if(e.target.tagName==='BUTTON'){
        const idx=parseInt(e.target.dataset.index);
        const c=countryData[idx];
        const newName=prompt("国名を変更",c.name); if(newName)c.name=newName;
        const newColor=prompt("色をHEXで変更",c.colorHex); if(newColor)c.colorHex=newColor;
        const newIdeology=prompt("主義を変更",c.ideology); if(newIdeology)c.ideology=newIdeology;
        const newLeader=prompt("代表を変更",c.leader); if(newLeader)c.leader=newLeader;
        const newPop=parseInt(prompt("人口を変更",c.population)); if(newPop>0)c.population=newPop;
        const newTax=parseFloat(prompt("税率(0~1)",c.taxRate||0)); if(newTax>=0 && newTax<=1)c.taxRate=newTax;
        drawMap(); updateCountryList();
    }
});

// 左クリックで塗り＋ステート追加＋人口・資源追加
canvas.addEventListener('click',e=>{
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/scale);
    const y=Math.floor((e.clientY-rect.top)/scale);

    const colorHex=document.getElementById('colorPicker').value;
    const countryName=document.getElementById('countryName').value.trim()||'名前なし';
    const ideology=document.getElementById('ideology').value.trim()||'なし';
    const leader=document.getElementById('leader').value.trim()||'なし';

    const pixels=getRegionPixels(x,y); if(pixels.length===0) return;
    fillRegion(pixels,colorHex);

    let country=countryData.find(c=>c.name===countryName);
    const randPop=Math.floor(Math.random()*(50000000-1000000+1))+1000000; // 100万〜5000万
    const newResources = {};
    resourceList.forEach(r=>{ newResources[r]=Math.floor(Math.random()*1000)+100; });

    if(country){
        country.regions.push({pixels:pixels});
        country.population += randPop;
        country.ideology=ideology;
        country.leader=leader;
        country.colorHex=colorHex;
        country.resources = {...country.resources,...newResources};
    } else {
        countryData.push({name:countryName,colorHex:colorHex,ideology:ideology,leader:leader,population:randPop,soldiers:0,regions:[{pixels:pixels}],resources:newResources,taxRate:0});
    }
    drawMap(); updateCountryList();
});

// 右クリックで情報表示
canvas.addEventListener('contextmenu', e=>{
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/scale);
    const y=Math.floor((e.clientY-rect.top)/scale);

    let found=false;
    for(const country of countryData){
        for(const region of country.regions){
            if(region.pixels.some(p=>p.x===x && p.y===y)){
                const resStr = Object.entries(country.resources).map(([k,v])=>`${k}:${v}`).join(", ");
                alert(`国名: ${country.name}\n主義: ${country.ideology}\n代表: ${country.leader}\n人口: ${country.population.toLocaleString()}\n兵士: ${country.soldiers}\n資源: ${resStr}\n税率: ${(country.taxRate*100||0)}%`);
                found=true; break;
            }
        }
        if(found) break;
    }
    if(!found) alert("ここには国情報はありません");
});

// ズーム
document.getElementById('zoomIn').addEventListener('click',()=>{scale*=1.2; drawMap();});
document.getElementById('zoomOut').addEventListener('click',()=>{scale/=1.2; drawMap();});

// 徴兵システム
function conscript(country, number){
    const maxConscript=Math.floor(country.population*0.1);
    const actual=Math.min(number,maxConscript);
    country.population-=actual;
    country.soldiers+=actual;
}

// 1か月進行
function nextMonth(){
    month++;
    if(month>12){ month=1; year++; }
    countryData.forEach(country=>{
        // 人口成長: 毎月1%
        const popGrowth=Math.floor(country.population*0.01);
        country.population+=popGrowth;

        // 税収計算（税収は資金や通貨として表示していませんがシステムに組込可能）
        const taxIncome=Math.floor(country.population*1000*country.taxRate);
        // 資源収入: ランダムで増える
        resourceList.forEach(r=>{
            country.resources[r] = (country.resources[r]||0) + Math.floor(Math.random()*100+50);
        });
    });
    document.getElementById('timeDisplay').textContent=`年:${year} 月:${month}`;
    updateCountryList();
}
document.getElementById('nextMonth').addEventListener('click',nextMonth);

</script>
</body>
</html>
