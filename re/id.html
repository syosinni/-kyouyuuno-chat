<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>国家管理ゲームサンプル</title>
<style>
  body { font-family: sans-serif; display: flex; }
  #mapContainer { position: relative; }
  canvas { border: 1px solid #000; }
  #controls { margin-left: 20px; }
  input, button { margin: 5px 0; display: block; }
</style>
</head>
<body>
<div id="mapContainer">
  <canvas id="mapCanvas" width="800" height="600"></canvas>
</div>
<div id="controls">
  <h3>国家情報</h3>
  <label>国名: <input id="countryName" type="text" value="日本"></label>
  <label>代表: <input id="leaderName" type="text" value="山田太郎"></label>
  <label>主義: <input id="ideology" type="text" value="民主主義"></label>
  <button id="saveBtn">セーブ</button>
  <button id="loadBtn">ロード</button>
  <pre id="jsonOutput"></pre>
</div>

<script>
// --- 1. 地図表示とクリックで塗る ---
const canvas = document.getElementById('mapCanvas');
const ctx = canvas.getContext('2d');

// ここにポリゴンで囲まれた領土座標例 (本来はSVGデータから変換)
const territories = [
  {id: 'A', points: [{x:100,y:100},{x:200,y:100},{x:200,y:200},{x:100,y:200}], owner:null},
  {id: 'B', points: [{x:250,y:100},{x:350,y:100},{x:350,y:200},{x:250,y:200}], owner:null},
];

// 画像読み込み (PNG/SVG対応)
const mapImage = new Image();
mapImage.src = 'map.png'; // GitHub上のSVGやPNGのURLに置き換え
mapImage.onload = () => { ctx.drawImage(mapImage,0,0,canvas.width,canvas.height); drawTerritories(); }

// ポリゴン描画
function drawTerritories() {
  territories.forEach(t => {
    if(t.owner) {
      ctx.fillStyle = t.owner.color;
      ctx.beginPath();
      t.points.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
      ctx.closePath();
      ctx.fill();
    }
    ctx.strokeStyle = '#333';
    ctx.beginPath();
    t.points.forEach((p,i)=>i===0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y));
    ctx.closePath();
    ctx.stroke();
  });
}

// ポリゴン内判定
function isInside(polygon, x, y) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i].x, yi = polygon[i].y;
    const xj = polygon[j].x, yj = polygon[j].y;
    const intersect = ((yi > y) != (yj > y)) && (x < (xj - xi)*(y - yi)/(yj - yi)+xi);
    if(intersect) inside = !inside;
  }
  return inside;
}

// クリック処理
canvas.addEventListener('click', e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const country = {
    name: document.getElementById('countryName').value,
    leader: document.getElementById('leaderName').value,
    ideology: document.getElementById('ideology').value,
    color: '#ff0000'
  };
  territories.forEach(t=>{
    if(isInside(t.points,x,y)) t.owner = country;
  });
  ctx.drawImage(mapImage,0,0,canvas.width,canvas.height);
  drawTerritories();
});

// --- 2. JSONセーブ/ロード ---
document.getElementById('saveBtn').addEventListener('click', ()=>{
  const saveData = {
    countryInfo: {
      name: document.getElementById('countryName').value,
      leader: document.getElementById('leaderName').value,
      ideology: document.getElementById('ideology').value,
    },
    territories: territories.map(t=>({id:t.id, owner:t.owner?t.owner.name:null}))
  };
  document.getElementById('jsonOutput').textContent = JSON.stringify(saveData, null, 2);
  localStorage.setItem('gameSave', JSON.stringify(saveData));
});

document.getElementById('loadBtn').addEventListener('click', ()=>{
  const loadData = JSON.parse(localStorage.getItem('gameSave'));
  if(!loadData) return;
  document.getElementById('countryName').value = loadData.countryInfo.name;
  document.getElementById('leaderName').value = loadData.countryInfo.leader;
  document.getElementById('ideology').value = loadData.countryInfo.ideology;
  territories.forEach(t=>{
    const ownerName = loadData.territories.find(l=>l.id===t.id)?.owner;
    t.owner = ownerName ? {name: ownerName, color:'#ff0000'} : null;
  });
  ctx.drawImage(mapImage,0,0,canvas.width,canvas.height);
  drawTerritories();
});
</script>
</body>
</html>
