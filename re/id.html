<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>世界地図バケツ塗り＋国名管理</title>
<style>
  body { display: flex; flex-direction: column; align-items: center; margin: 20px; font-family: sans-serif; }
  canvas { border:1px solid #000; cursor: crosshair; }
  .controls { margin:10px; }
  #countryList { margin-top:10px; max-height:200px; overflow:auto; border:1px solid #ccc; width: 300px; padding:5px;}
  .countryItem { display:flex; justify-content:space-between; padding:2px 5px; cursor:pointer; }
  .colorBox { width:20px; height:20px; display:inline-block; margin-right:5px; border:1px solid #000; vertical-align:middle; }
</style>
</head>
<body>

<div class="controls">
  <label>塗る色: <input type="color" id="colorPicker" value="#ff0000"></label>
  <label>国名: <input type="text" id="countryName" placeholder="国名を入力"></label>
  <button id="zoomIn">拡大</button>
  <button id="zoomOut">縮小</button>
</div>

<canvas id="canvas"></canvas>

<div id="countryList"></div>

<script>
const svgUrl = "https://kyouyuuno-to.f5.si/img/0001.svg";
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let scale = 1;
let mapImg = new Image();
mapImg.crossOrigin = "anonymous";
mapImg.onload = () => {
    canvas.width = mapImg.width;
    canvas.height = mapImg.height;
    drawMap();
}
mapImg.src = svgUrl;

let countryData = []; // {name, colorHex, pixels: [{x,y}]} を格納

function drawMap(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(mapImg, 0, 0);

    // 塗り済み国を描画
    countryData.forEach(country=>{
        const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const data = imgData.data;
        country.pixels.forEach(p=>{
            const i = (p.x + p.y*canvas.width)*4;
            const col = hexToRGBA(country.colorHex);
            data[i] = col.r;
            data[i+1] = col.g;
            data[i+2] = col.b;
            data[i+3] = col.a;
        });
        ctx.putImageData(imgData,0,0);
    });
}

// 色をHEXからRGBAに変換
function hexToRGBA(hex){
    return {
        r: parseInt(hex.slice(1,3),16),
        g: parseInt(hex.slice(3,5),16),
        b: parseInt(hex.slice(5,7),16),
        a: 255
    };
}

// Flood Fillで領域のピクセル取得
function getRegionPixels(x,y){
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imgData.data;
    const width = canvas.width;
    const stack = [[x,y]];
    const visited = new Set();
    const pixels = [];

    function key(x,y){ return x + ',' + y; }

    while(stack.length){
        const [cx,cy] = stack.pop();
        if(cx<0 || cy<0 || cx>=width || cy>=canvas.height) continue;
        if(visited.has(key(cx,cy))) continue;

        const i = (cx + cy*width)*4;
        const c = [data[i], data[i+1], data[i+2]];

        // 白部分のみ
        if(c[0]===255 && c[1]===255 && c[2]===255){
            pixels.push({x:cx,y:cy});
            visited.add(key(cx,cy));
            stack.push([cx+1,cy]);
            stack.push([cx-1,cy]);
            stack.push([cx,cy+1]);
            stack.push([cx,cy-1]);
        }
    }
    return pixels;
}

// 塗りつぶし
function fillRegion(pixels, colorHex){
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const data = imgData.data;
    const col = hexToRGBA(colorHex);
    pixels.forEach(p=>{
        const i = (p.x + p.y*canvas.width)*4;
        data[i]=col.r;
        data[i+1]=col.g;
        data[i+2]=col.b;
        data[i+3]=col.a;
    });
    ctx.putImageData(imgData,0,0);
}

// 国リスト描画
function updateCountryList(){
    const listDiv = document.getElementById('countryList');
    listDiv.innerHTML = '';
    countryData.forEach((c,i)=>{
        const div = document.createElement('div');
        div.className = 'countryItem';
        div.innerHTML = `<span><span class="colorBox" style="background:${c.colorHex}"></span>${c.name}</span> <button data-index="${i}">編集</button>`;
        listDiv.appendChild(div);
    });
}

// 国編集ボタン
document.getElementById('countryList').addEventListener('click', e=>{
    if(e.target.tagName==='BUTTON'){
        const idx = parseInt(e.target.dataset.index);
        const newName = prompt("国名を変更", countryData[idx].name);
        if(newName) countryData[idx].name = newName;
        const newColor = prompt("色をHEXで変更", countryData[idx].colorHex);
        if(newColor) countryData[idx].colorHex = newColor;
        drawMap();
        updateCountryList();
    }
});

// クリックで塗る
canvas.addEventListener('click', e=>{
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left)/scale);
    const y = Math.floor((e.clientY - rect.top)/scale);

    const colorHex = document.getElementById('colorPicker').value;
    const countryName = document.getElementById('countryName').value.trim() || '名前なし';

    const pixels = getRegionPixels(x,y);
    if(pixels.length===0) return;

    fillRegion(pixels,colorHex);
    countryData.push({name:countryName, colorHex:colorHex, pixels:pixels});
    updateCountryList();
});

// ズーム
document.getElementById('zoomIn').addEventListener('click', ()=>{
    scale *= 1.2;
    drawMap();
});
document.getElementById('zoomOut').addEventListener('click', ()=>{
    scale /= 1.2;
    drawMap();
});
</script>

</body>
</html>
