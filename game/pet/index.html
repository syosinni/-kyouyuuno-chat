<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ä¼šè©±AIã€Œã¨ã‚‚ã‚Šã‚“ï¼ã‚‚ã“ã‚Šã‚“ã€</title>
<style>
body { background: #f6fafe; font-family:"ãƒ¡ã‚¤ãƒªã‚ª", "Meiryo", sans-serif; text-align: center; margin:0;}
.topbar {background:#deedfc; padding:6px;}
h2 {margin-top:11px;}
.avatar { width:130px; height:130px; border-radius:50%; object-fit:cover; box-shadow: 0 8px 20px #b6e3f7 inset, 0 2px 8px #999; display:inline-block; margin-bottom:10px;}
#avatarDefault { width:130px; height:130px; display:inline-block; border-radius:50%; background:linear-gradient(135deg,#a6e3f7,#fff); position:relative;}
#avatarDefault .eye { position:absolute; width:24px; height:24px; background:#222; border-radius:50%; top:52px;}
#avatarDefault .eye.left { left:34px; }
#avatarDefault .eye.right { right:34px; }
#avatarDefault .mouth { position:absolute; width:36px; height:18px; border-radius:0 0 30px 30px; background:#fff; bottom:32px; left:48px;border-bottom:3px solid #89c9ea;}

#setup { background:#dfffe9; border-radius:14px; padding:13px 0; margin:0 auto 12px; width:370px;}
label {color:#29ad8e;}
input[type=text], input[type=file] { font-size:1em; border-radius:8px; border:1px solid #a7ece2; padding:4px;}

.chat-box { width: 350px; margin: 0 auto 16px; padding: 9px; background: #fff; border-radius:10px; box-shadow: 0 2px 12px #dceafd; min-height: 120px; max-height: 250px; overflow-y: auto; margin-top:7px;}
.user { text-align: right; color: #387fd4; }
.bot { text-align: left; color: #24a69a; position:relative;}
.favbtn { display:inline-block; margin-left:8px; background:#ffe486; border-radius:7px; padding:2px 6px; border:0; font-size:1em; cursor:pointer;}
.favbtn.active { background:#ffd46a;}
.input-area { margin: 16px auto; width: 350px;}
input, button, textarea { font-size: 1.08em; padding: 6px; border-radius:8px; border: 1px solid #d2eefb; margin: 2px;}
button { background:#e6f2fa;}
.learn-form {background:#fffbe6; padding:7px 12px; border-radius:10px; margin:10px auto;}
.learn-form label {display:block; margin:6px 0 2px; color:#d28721;}
#memoArea {font-size:0.97em; background:#eff4fb; padding:8px; border-radius:10px; width:340px; margin:10px auto;}
.miniBtn { font-size:0.92em; margin:0 2px; }
</style>
</head>
<body>
<div class="topbar">
  <b>ä¼šè©±AI - å‹é”ãƒ¢ãƒ¼ãƒ‰ï¼ãƒšãƒƒãƒˆã‚‚ã“ã‚Šã‚“</b>
  <button onclick="switchMode()" class="miniBtn" id="modeBtn">å‹é”ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿</button>
  <button onclick="setupShow()" class="miniBtn">ã‚¢ã‚¤ã‚³ãƒ³/åå‰è¨­å®š</button>
  <button onclick="memoShow()" class="miniBtn">å­¦ç¿’è¿”ç­”å±¥æ­´</button>
  <button onclick="memoExport()" class="miniBtn">jsonã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <button onclick="memoImportShow()" class="miniBtn">jsonã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
</div>

<div id="setup" style="display:none;">
  <label>ã‚ãªãŸã®AIã®åå‰:</label>
  <input type="text" id="friendName" value=""> <br>
  <label>å†™çœŸã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰:</label>
  <input type="file" id="avatarFile" accept="image/*"> <br>
  <button onclick="setupSave()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
  <button onclick="setupHide()" style="margin-left:8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  <div style="margin-top:7px;"><span style="font-size:0.98em;color:#777;">ä¸Šè¨˜æœªè¨­å®šã®å ´åˆã¯ã€Œã‚‚ã“ã‚Šã‚“ã€&amp;ã‚¤ãƒ©ã‚¹ãƒˆã§å§‹ã¾ã‚Šã¾ã™</span></div>
</div>

<div id="avatarZone">
  <div id="avatarDefault">
    <div class="eye left"></div>
    <div class="eye right"></div>
    <div class="mouth"></div>
  </div>
</div>
<h2 id="aiNameH">ã‚‚ã“ã‚Šã‚“ğŸ¾</h2>

<div class="chat-box" id="chat"></div>
<form class="input-area" onsubmit="return false;" id="inputForm">
  <input id="userInput" type="text" placeholder="è©±ã—ã‹ã‘ã¦ã¿ã¦ã­" autocomplete="off" size="27">
  <button onclick="chat()">é€ä¿¡</button>
</form>
<div id="learnArea"></div>
<div id="memoArea" style="display:none;"></div>
<div id="memoImportArea" style="display:none;">
  <label>jsonã‚’è²¼ã‚Šä»˜ã‘ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:</label>
  <textarea id="jsonImportBox" rows="5" cols="38"></textarea><br>
  <button onclick="memoImport()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <button onclick="memoImportHide()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>
<script>
let chain = {};
let memo = JSON.parse(localStorage.getItem("friend_memo")||"{}");
let fav = JSON.parse(localStorage.getItem("friend_fav")||"{}");
let friendName = localStorage.getItem("friend_name") || "ã‚‚ã“ã‚Šã‚“";
let avatarImg = localStorage.getItem("friend_avatar") || "";
let mode = localStorage.getItem("friend_mode") || "pet"; // pet or friend

const defaultTextPet = [
  "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚",
  "ã”ã¯ã‚“é£Ÿã¹ãŸã„ãªã€‚", "çœ ã„æ°—ãŒã™ã‚‹ã‚ˆã€‚", "ãªã§ã¦ã»ã—ã„ã€‚", "ã ã„ã™ãã ã‚ˆã€‚",
  "ä¸€ç·’ã«ãŒã‚“ã°ã‚ã†ï¼", "ã‚ã‚ŠãŒã¨ã†ã€‚", "ã¼ãã€ã‚‚ã“ã‚Šã‚“ã£ã¦ã„ã†ã‚ˆã€‚"
];
const defaultTextFriend = [
  "ãŠã¯ã‚ˆã†ï¼", "å…ƒæ°—ï¼Ÿ", "ä½•ã—ã¦ã‚‹ã®ï¼Ÿ", "æœ€è¿‘ã©ã†ï¼Ÿ", "ã‚ã‚ŠãŒã¨ã†ï¼",
  "ä¸€ç·’ã«éŠã¼ã†ã‚ˆã€‚", "è©±ãã†ï¼", "å‹é”ã£ã¦ã„ã„ã­ã€‚"
];
// æ—¥æœ¬èªæ–‡æ³•ãƒ™ãƒ¼ã‚¹
const basicGram = {
  "ãŠã¯ã‚ˆã†": "æœã®æŒ¨æ‹¶", "ã“ã‚“ã«ã¡ã¯":"æ˜¼ã®æŒ¨æ‹¶", "ã“ã‚“ã°ã‚“ã¯":"å¤œã®æŒ¨æ‹¶",
  "ã‚ã‚ŠãŒã¨ã†": "æ„Ÿè¬", "ã ã„ã™ã":"å¥½æ„", "ã”ã¯ã‚“":"é£Ÿäº‹", "éŠã¶":"è¡Œå‹•", "çœ ã„":"çŠ¶æ…‹"
};

function chainInit(){
  chain = {};
  let list = (mode=="pet"?defaultTextPet:defaultTextFriend);
  list.forEach(learn);
  learnFromHistory();
}
function learn(text) {
  text = text.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, " ");
  let words = text.split(/\s+/).filter(Boolean);
  for (let i=0; i<words.length-2; i++) {
    let key = words[i] + " " + words[i+1];
    chain[key] = chain[key] || [];
    chain[key].push(words[i+2]);
  }
}
function learnFromHistory() {
  let history = JSON.parse(localStorage.getItem("friend_history")||"[]");
  history.forEach(learn);
}
chainInit();

let pendingLearn = null;
function chat() {
  if(pendingLearn) {
    printChat("bot",`ã€Œ${pendingLearn.word}ã€ã«ã¤ã„ã¦ã¯ä¸‹ã®é»„è‰²ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰æ•™ãˆã¦ã­ã€‚`);
    return;
  }
  let input = document.getElementById("userInput").value.trim();
  if(!input) return;
  printChat("user", input);

  let history = JSON.parse(localStorage.getItem("friend_history")||"[]");
  history.push(input);
  localStorage.setItem("friend_history",JSON.stringify(history));

  let unknowns = [];
  let words = input.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, " ").split(/\s+/).filter(Boolean);
  for(let w of words){
    if(!basicGram[w] && (!memo[w]||memo[w].responses===undefined)){
      if(!unknowns.includes(w)) unknowns.push(w);
    }
  }
  learn(input);

  if(unknowns.length > 0){
    pendingLearn = {word: unknowns[0]};
    showLearnForm(unknowns[0]);
    printChat("bot",`ã€Œ${unknowns[0]}ã€ã£ã¦ä½•ï¼Ÿã©ã‚“ãªé¢¨ã«è¿”ã—ã¦ã»ã—ã„ï¼Ÿä¾‹ã‚’æœ€å¤§3ã¤æ•™ãˆã¦ï¼`);
    document.getElementById("userInput").value="";
    return;
  }

  let reply = generate(input, words);
  printChat("bot", reply, words);
  document.getElementById("userInput").value="";
}

function printChat(type, text, inputWords) {
  let box = document.getElementById("chat");
  let div = document.createElement("div");
  div.className = type;
  if(type=="user"){
    div.textContent = "ã‚ãªãŸ: " + text;
  }else{
    div.textContent = friendName+": " + text;
    // ãŠæ°—ã«å…¥ã‚Šè¿½åŠ ãƒœã‚¿ãƒ³
    let favBtn = document.createElement("button");
    favBtn.className = "favbtn" + (fav[text]?" active":"");
    favBtn.textContent = fav[text]?"â˜…ãŠæ°—ã«å…¥ã‚Š":"â˜†ãŠæ°—ã«å…¥ã‚Š";
    favBtn.onclick = function(){
      if(fav[text]){
        delete fav[text];
      } else{
        fav[text]=true;
      }
      localStorage.setItem("friend_fav",JSON.stringify(fav));
      favBtn.textContent = fav[text]?"â˜…ãŠæ°—ã«å…¥ã‚Š":"â˜†ãŠæ°—ã«å…¥ã‚Š";
      favBtn.className = "favbtn" + (fav[text]?" active":"");
    };
    div.appendChild(favBtn);
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showLearnForm(word){
  let area = document.getElementById("learnArea");
  area.innerHTML = `
  <form class="learn-form" onsubmit="return false;" id="formLearn">
    <label>ã“ã‚“ãªãµã†ã«è¿”ã—ã¦ã»ã—ã„ï¼ˆå€™è£œï¼‘ï¼‰:</label>
    <input type="text" id="resp1" placeholder="ä¾‹: ã™ã”ã„ã­ï¼" maxlength="36"><br>
    <label>å€™è£œï¼’:</label>
    <input type="text" id="resp2" placeholder="ä¾‹: ãã‚Œã¯é¢ç™½ã„ã­ï¼" maxlength="36"><br>
    <label>å€™è£œï¼“:</label>
    <input type="text" id="resp3" placeholder="ä¾‹: ã‚‚ã£ã¨æ•™ãˆã¦ï¼" maxlength="36"><br>
    <button onclick="submitLearn()">ä¿å­˜ã™ã‚‹</button>
  </form>
  `;
  document.getElementById("resp1").focus();
}

window.submitLearn = function(){
  if(!pendingLearn) return;
  let responses = [
    document.getElementById("resp1").value.trim(),
    document.getElementById("resp2").value.trim(),
    document.getElementById("resp3").value.trim()
  ].filter(Boolean);

  if(responses.length==0) {
    alert("è¿”ç­”å€™è£œã‚’æœ€ä½1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
    return;
  }
  memo[pendingLearn.word] = { responses: responses };
  localStorage.setItem("friend_memo",JSON.stringify(memo));

  printChat("bot",`ã‚ã‚ŠãŒã¨ã†ï¼è¦šãˆãŸã‚ˆã€‚ã€Œ${pendingLearn.word}ã€ã«ä»Šåº¦ã‹ã‚‰è¿”ã›ã‚‹ã‚ˆã€‚`);
  pendingLearn = null;
  document.getElementById("learnArea").innerHTML = "";
  document.getElementById("userInput").focus();
}

function generate(seed, words) {
  // ãŠæ°—ã«å…¥ã‚Šå€™è£œå„ªå…ˆ
  for(let w of words){
    if(memo[w] && memo[w].responses && memo[w].responses.length>0){
      let arr = memo[w].responses;
      // ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å„ªå…ˆå‡ºç¾
      let favs = arr.filter(x=>fav[x]);
      if(favs.length>0){
        return favs[Math.floor(Math.random()*favs.length)];
      }
      return arr[Math.floor(Math.random()*arr.length)];
    }
  }
  // ãƒãƒ«ã‚³ãƒ•å¿œç­”
  let seedWords = seed.split(/\s+/).filter(Boolean);
  let w1 = seedWords[0]||Object.keys(chain)[0]?.split(" ")[0];
  let w2 = seedWords[1]||Object.keys(chain)[0]?.split(" ")[1];
  let result = [w1,w2];
  for(let i=0;i<15;i++) {
    let key = result[result.length-2]+" "+result[result.length-1];
    let nexts = chain[key];
    if(!nexts||nexts.length==0) break;
    let next = nexts[Math.floor(Math.random()*nexts.length)];
    result.push(next);
  }
  return result.join(" ")+"ã€‚";
}

// åå‰ãƒ»å†™çœŸè¨­å®š
function setupShow(){
  document.getElementById("setup").style.display="block";
  document.getElementById("friendName").value=friendName;
}
function setupHide(){
  document.getElementById("setup").style.display="none";
}
function setupSave(){
  let name = document.getElementById("friendName").value.trim();
  friendName = name?name:"ã‚‚ã“ã‚Šã‚“";
  localStorage.setItem("friend_name",friendName);
  document.getElementById("aiNameH").textContent = friendName;
  setupHide();
  let file = document.getElementById("avatarFile").files[0];
  if(file){
    let reader = new FileReader();
    reader.onload = function(e){
      avatarImg = e.target.result;
      localStorage.setItem("friend_avatar", avatarImg);
      avatarRender();
    };
    reader.readAsDataURL(file);
  }else{
    avatarImg="";
    localStorage.removeItem("friend_avatar");
    avatarRender();
  }
}
function avatarRender(){
  let zone = document.getElementById("avatarZone");
  if(avatarImg){
    zone.innerHTML='<img class="avatar" src="'+avatarImg+'">';
  }else{
    zone.innerHTML=`<div id="avatarDefault">
      <div class="eye left"></div>
      <div class="eye right"></div>
      <div class="mouth"></div>
    </div>`;
  }
}

// ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
function switchMode(){
  mode = mode=="pet"?"friend":"pet";
  localStorage.setItem("friend_mode",mode);
  document.getElementById("modeBtn").textContent = mode=="pet"?"å‹é”ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿":"ã‚‚ã“ã‚Šã‚“ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿";
  chainInit();
  document.getElementById("chat").innerHTML="";
  document.getElementById("userInput").value="";
  document.getElementById("aiNameH").textContent = friendName + (mode=="pet"?"ğŸ¾":"");
  avatarRender();
  printChat("bot",mode=="pet"?"ã“ã‚“ã«ã¡ã¯ï¼ã¼ãã€ã‚‚ã“ã‚Šã‚“ğŸ¾ã€€ãªã‚“ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ã€‚":"ã‚„ã£ã»ãƒ¼ï¼å‹é”ã¨ã—ã¦è©±ãã†ã€‚");
}

// å­¦ç¿’å±¥æ­´è¡¨ç¤º
function memoShow(){
  let area = document.getElementById("memoArea");
  let msg = Object.entries(memo).map(([w,v])=>
    `ã€Œ${w}ã€: ${v.responses.map(r=>(fav[r]?"â˜…":"")+r).join(" / ")}`
  ).join("<br>");
  area.innerHTML = "<b>å­¦ç¿’ã—ãŸå˜èª:</b><br>" +(msg||"ã¾ã ã‚ã‚Šã¾ã›ã‚“");
  area.style.display="block";
}

// jsonã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
function memoExport(){
  let data = JSON.stringify(memo,null,2);
  let blob = new Blob([data],{type:"application/json"});
  let url = URL.createObjectURL(blob);
  let dl=document.createElement("a");
  dl.href=url;dl.download="friend_memo.json";
  dl.click();
  setTimeout(()=>{URL.revokeObjectURL(url);},3333);
}

// jsonã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒªã‚¢è¡¨ç¤º
function memoImportShow(){
  document.getElementById("memoImportArea").style.display="block";
}
function memoImportHide(){
  document.getElementById("memoImportArea").style.display="none";
}
// å®Ÿã‚¤ãƒ³ãƒãƒ¼ãƒˆ
function memoImport(){
  let val = document.getElementById("jsonImportBox").value;
  try{
    let obj = JSON.parse(val);
    memo = obj;
    localStorage.setItem("friend_memo",JSON.stringify(memo));
    alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼");
    memoImportHide();
  }catch(e){alert("jsonå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");}
}

// åˆæœŸæç”»
avatarRender();
document.getElementById("aiNameH").textContent = friendName +(mode=="pet"?"ğŸ¾":"");
document.getElementById("modeBtn").textContent = mode=="pet"?"å‹é”ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿":"ã‚‚ã“ã‚Šã‚“ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿";
printChat("bot",mode=="pet"?"ã“ã‚“ã«ã¡ã¯ï¼ã¼ãã€ã‚‚ã“ã‚Šã‚“ğŸ¾ã€€ãªã‚“ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ã€‚":"ã‚„ã£ã»ãƒ¼ï¼å‹é”ã¨ã—ã¦è©±ãã†ã€‚");

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é€ä¿¡å¯¾å¿œ
document.getElementById("userInput").addEventListener("keydown", function(e){if(e.key==="Enter") chat();});

</script>
</body>
</html>
