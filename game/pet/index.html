<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIペット「もこりん」</title>
  <style>
    body { background: #f6fafe; font-family: "メイリオ", "Meiryo", sans-serif; text-align: center; margin: 0; padding: 0;}
    .pet { margin: 30px auto 10px; width: 130px; height: 130px; border-radius: 40% 50%; background: linear-gradient(135deg,#a6e3f7,#fff); box-shadow: 0 8px 20px #a6e3f7 inset, 0 2px 8px #999; position: relative; display: inline-block;}
    .pet-eye { position: absolute; width: 24px; height: 24px; background: #222; border-radius: 50%; top: 52px;}
    .pet-eye.left { left: 34px; }
    .pet-eye.right { right: 34px; }
    .pet-mouth { position: absolute; width: 36px; height: 18px; border-radius: 0 0 30px 30px; background: #fff; bottom: 32px; left: 48px; border-bottom: 3px solid #89c9ea;}
    .chat-box { width: 330px; margin: 0 auto 16px; padding: 9px; background: #fff; border-radius:10px; box-shadow: 0 2px 12px #dceafd; min-height: 120px; max-height: 240px; overflow-y: auto;}
    .user { text-align: right; color: #387fd4; }
    .bot { text-align: left; color: #24a69a; }
    .input-area { margin: 16px auto; width: 330px; }
    input, button, textarea { font-size: 1.1em; padding: 6px; border-radius:7px; border: 1px solid #d2eefb; margin: 2px;}
    button { background:#e6f2fa;}
    .learn-form {background:#fffbe6; padding:7px 12px; border-radius:8px; margin:10px auto;}
    .learn-form label {display:block; margin:6px 0 2px; color:#d28721;}
  </style>
</head>
<body>
  <div class="pet">
    <div class="pet-eye left"></div>
    <div class="pet-eye right"></div>
    <div class="pet-mouth"></div>
  </div>
  <h2>こんにちは！ぼく「もこりん」🐾</h2>
  <div class="chat-box" id="chat"></div>
  <form class="input-area" onsubmit="return false;" id="inputForm">
    <input id="userInput" type="text" placeholder="話しかけてみてね" autocomplete="off" size="25">
    <button onclick="chat()">送信</button>
  </form>
  <div id="learnArea"></div>
  <script>
    let chain = {};
    let memo = JSON.parse(localStorage.getItem("mokorin_memo")||"{}");

    const defaultText = [
      "おはようございます。",
      "今日も元気？",
      "ごはん食べたいな。",
      "遊んでほしいな。",
      "眠い気がするよ。",
      "何をしてる？",
      "一緒にがんばろう！",
      "ありがとう。",
      "だいすきだよ。",
      "えへへ、なでてほしい。",
      "ぼく、もこりんっていうよ。"
    ];

    function learn(text) {
      text = text.replace(/[。！？\n]/g, " ");
      let words = text.split(/\s+/).filter(Boolean);
      for (let i=0; i<words.length-2; i++) {
        let key = words[i] + " " + words[i+1];
        chain[key] = chain[key] || [];
        chain[key].push(words[i+2]);
      }
    }
    defaultText.forEach(learn);

    function learnFromHistory() {
      let history = JSON.parse(localStorage.getItem("mokorin_history")||"[]");
      history.forEach(learn);
    }
    learnFromHistory();

    function generate(seed) {
      let words = seed.replace(/[。！？\n]/g, " ").split(/\s+/).filter(Boolean);
      // 未学習語にmemoを使う
      for(let w of words){
        if(memo[w] && memo[w].responses && memo[w].responses.length>0){
          let arr = memo[w].responses;
          return arr[Math.floor(Math.random()*arr.length)];
        }
      }
      let seedWords = seed.split(/\s+/).filter(Boolean);
      let w1 = seedWords[0]||Object.keys(chain)[0]?.split(" ")[0];
      let w2 = seedWords[1]||Object.keys(chain)[0]?.split(" ")[1];
      let result = [w1,w2];
      for(let i=0;i<15;i++) {
        let key = result[result.length-2]+" "+result[result.length-1];
        let nexts = chain[key];
        if(!nexts||nexts.length==0) break;
        let next = nexts[Math.floor(Math.random()*nexts.length)];
        result.push(next);
      }
      return result.join(" ")+"。";
    }

    // 基本文法辞書（超簡易）
    const basicGram = {
      "おはよう": "朝の挨拶", "こんにちは":"昼の挨拶", "こんばんは":"夜の挨拶",
      "ありがとう": "感謝", "だいすき":"好意", "ごはん":"食事", "遊ぶ":"行動", "眠い":"状態"
    };

    let pendingLearn = null;

    function chat() {
      if(pendingLearn) {
        printChat("bot","「" + pendingLearn.word + "」について教えてくれる？下の黄色いフォームから入力してね。");
        return;
      }
      let input = document.getElementById("userInput").value.trim();
      if(!input) return;
      printChat("user", input);

      let history = JSON.parse(localStorage.getItem("mokorin_history")||"[]");
      history.push(input);
      localStorage.setItem("mokorin_history",JSON.stringify(history));

      let unknowns = [];
      let words = input.replace(/[。！？\n]/g, " ").split(/\s+/).filter(Boolean);
      for(let w of words){
        if(!basicGram[w] && (!memo[w]||memo[w].responses===undefined)){
          if(!unknowns.includes(w)) unknowns.push(w);
        }
      }
      learn(input);

      if(unknowns.length > 0){
        pendingLearn = {word: unknowns[0]};
        showLearnForm(unknowns[0]);
        printChat("bot", "「" + unknowns[0] + "」はまだよく知らないみたい。こんなふうに返してほしいっていう例を教えてね！（最大3つ）");
        document.getElementById("userInput").value="";
        return;
      }

      let reply = generate(input);
      printChat("bot", reply);
      document.getElementById("userInput").value="";
    }

    function printChat(type, text){
      let box = document.getElementById("chat");
      let div = document.createElement("div");
      div.className = type;
      div.textContent = (type=="user"?"あなた: ":"もこりん: ")+text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function showLearnForm(word){
      let area = document.getElementById("learnArea");
      area.innerHTML = `
      <form class="learn-form" onsubmit="return false;" id="formLearn">
        <label>こんなふうに返してほしい（候補１）:</label>
        <input type="text" id="resp1" placeholder="例: すごいね！" maxlength="30"><br>
        <label>候補２:</label>
        <input type="text" id="resp2" placeholder="例: それは面白いね！" maxlength="30"><br>
        <label>候補３:</label>
        <input type="text" id="resp3" placeholder="例: もっと教えて！" maxlength="30"><br>
        <button onclick="submitLearn()">保存する</button>
      </form>
      `;
      document.getElementById("resp1").focus();
    }

    window.submitLearn = function(){
      if(!pendingLearn) return;
      let responses = [
        document.getElementById("resp1").value.trim(),
        document.getElementById("resp2").value.trim(),
        document.getElementById("resp3").value.trim()
      ].filter(Boolean);

      if(responses.length==0) {
        alert("返答候補を最低1つ以上入力してください。");
        return;
      }

      memo[pendingLearn.word] = {
        responses: responses
      };
      localStorage.setItem("mokorin_memo",JSON.stringify(memo));

      printChat("bot","ありがとう！覚えたよ。次からは「"+pendingLearn.word+"」を話しても返せるよ。");

      pendingLearn = null;
      document.getElementById("learnArea").innerHTML = "";
      document.getElementById("userInput").focus();
    }

    printChat("bot","こんにちは！ぼく、もこりん🐾　なんでも話しかけてね。");

    document.getElementById("userInput").addEventListener("keydown", function(e){
      if(e.key==="Enter") chat();
    });
  </script>
</body>
</html>
