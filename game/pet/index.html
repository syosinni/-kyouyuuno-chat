<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIãƒšãƒƒãƒˆã€Œã‚‚ã“ã‚Šã‚“ã€</title>
  <style>
    body {
      background: #f6fafe;
      font-family: "ãƒ¡ã‚¤ãƒªã‚ª", "Meiryo", sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .pet {
      margin: 30px auto 10px;
      width: 130px;
      height: 130px;
      border-radius: 40% 50%;
      background: linear-gradient(135deg,#a6e3f7,#fff);
      box-shadow: 0 8px 20px #a6e3f7 inset, 0 2px 8px #999;
      position: relative;
      display: inline-block;
    }
    .pet-eye {
      position: absolute;
      width: 24px;
      height: 24px;
      background: #222;
      border-radius: 50%;
      top: 52px;
    }
    .pet-eye.left { left: 34px; }
    .pet-eye.right { right: 34px; }
    .pet-mouth {
      position: absolute;
      width: 36px;
      height: 18px;
      border-radius: 0 0 30px 30px;
      background: #fff;
      bottom: 32px;
      left: 48px;
      border-bottom: 3px solid #89c9ea;
    }
    .chat-box {
      width: 330px; margin: 0 auto 16px; padding: 9px;
      background: #fff;
      border-radius:10px;
      box-shadow: 0 2px 12px #dceafd;
      min-height: 120px;
      max-height: 240px;
      overflow-y: auto;
    }
    .user { text-align: right; color: #387fd4; }
    .bot { text-align: left; color: #24a69a; }
    .input-area {
      margin: 16px auto; width: 330px;
    }
    input, button, textarea {
      font-size: 1.1em;
      padding: 6px;
      border-radius:7px; border: 1px solid #d2eefb;
      margin: 2px;
    }
    button { background:#e6f2fa;}
    .learn-form {background:#fffbe6; padding:7px 12px; border-radius:8px; margin:10px auto;}
    .learn-form label {display:block; margin:6px 0 2px; color:#d28721;}
  </style>
</head>
<body>
  <div class="pet">
    <div class="pet-eye left"></div>
    <div class="pet-eye right"></div>
    <div class="pet-mouth"></div>
  </div>
  <h2>ã“ã‚“ã«ã¡ã¯ï¼ã¼ãã€Œã‚‚ã“ã‚Šã‚“ã€ğŸ¾</h2>
  <div class="chat-box" id="chat"></div>
  <form class="input-area" onsubmit="return false;" id="inputForm">
    <input id="userInput" type="text" placeholder="è©±ã—ã‹ã‘ã¦ã¿ã¦ã­" autocomplete="off" size="25">
    <button onclick="chat()">é€ä¿¡</button>
  </form>
  <div id="learnArea"></div>
  <script>
    // --- ãƒãƒ«ã‚³ãƒ•é€£é–ï¼ˆ2éšï¼‰ãƒ¢ãƒ‡ãƒ« ---
    let chain = {};
    // --- å˜èªãƒ»æ–‡æ³•ãƒ¡ãƒ¢ ---
    let memo = JSON.parse(localStorage.getItem("mokorin_memo")||"{}");

    // åˆæœŸæ–‡ã‚»ãƒƒãƒˆï¼ˆãƒšãƒƒãƒˆå¯¾è©±ç”¨åŸºæœ¬æ–‡ï¼‰
    const defaultText = [
      "ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚",
      "ä»Šæ—¥ã‚‚å…ƒæ°—ï¼Ÿ",
      "ã”ã¯ã‚“é£Ÿã¹ãŸã„ãªã€‚",
      "éŠã‚“ã§ã»ã—ã„ãªã€‚",
      "çœ ã„æ°—ãŒã™ã‚‹ã‚ˆã€‚",
      "ä½•ã‚’ã—ã¦ã‚‹ï¼Ÿ",
      "ä¸€ç·’ã«ãŒã‚“ã°ã‚ã†ï¼",
      "ã‚ã‚ŠãŒã¨ã†ã€‚",
      "ã ã„ã™ãã ã‚ˆã€‚",
      "ãˆã¸ã¸ã€ãªã§ã¦ã»ã—ã„ã€‚",
      "ã¼ãã€ã‚‚ã“ã‚Šã‚“ã£ã¦ã„ã†ã‚ˆã€‚"
    ];

    // åˆæœŸçµ„ã¿ç«‹ã¦
    function learn(text) {
      text = text.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, " ");
      let words = text.split(/\s+/).filter(Boolean);
      for (let i=0; i<words.length-2; i++) {
        let key = words[i] + " " + words[i+1];
        chain[key] = chain[key] || [];
        chain[key].push(words[i+2]);
      }
    }
    defaultText.forEach(learn);

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾è©±å±¥æ­´â†’å­¦ç¿’
    function learnFromHistory() {
      let history = JSON.parse(localStorage.getItem("mokorin_history")||"[]");
      history.forEach(learn);
    }
    learnFromHistory();

    // ãƒãƒ«ã‚³ãƒ•ç”Ÿæˆ
    function generate(seed) {
      let seedWords = seed.split(/\s+/).filter(Boolean);
      let w1 = seedWords[0]||Object.keys(chain)[0]?.split(" ")[0];
      let w2 = seedWords[1]||Object.keys(chain)[0]?.split(" ")[1];
      let result = [w1,w2];
      for(let i=0;i<15;i++) {
        let key = result[result.length-2]+" "+result[result.length-1];
        let nexts = chain[key];
        if(!nexts||nexts.length==0) break;
        let next = nexts[Math.floor(Math.random()*nexts.length)];
        result.push(next);
      }
      return result.join(" ")+"ã€‚";
    }

    // åŸºæœ¬æ–‡æ³•è¾æ›¸ï¼ˆè¶…ç°¡æ˜“ï¼‰
    const basicGram = {
      "ãŠã¯ã‚ˆã†": "æœã®æŒ¨æ‹¶", "ã“ã‚“ã«ã¡ã¯":"æ˜¼ã®æŒ¨æ‹¶", "ã“ã‚“ã°ã‚“ã¯":"å¤œã®æŒ¨æ‹¶",
      "ã‚ã‚ŠãŒã¨ã†": "æ„Ÿè¬", "ã ã„ã™ã":"å¥½æ„", "ã”ã¯ã‚“":"é£Ÿäº‹", "éŠã¶":"è¡Œå‹•", "çœ ã„":"çŠ¶æ…‹"
    };

    let pendingLearn = null; // ç¾åœ¨å­¦ç¿’ä¸­å˜èª

    // å—ã‘ç­”ãˆ
    function chat() {
      if(pendingLearn) {
        printChat("bot","ã€Œ" + pendingLearn.word + "ã€ã«ã¤ã„ã¦æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿä¸‹ã®é»„è‰²ã„ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å…¥åŠ›ã—ã¦ã­ã€‚");
        return;
      }
      let input = document.getElementById("userInput").value.trim();
      if(!input) return;
      printChat("user", input);

      // ä¿å­˜å±¥æ­´
      let history = JSON.parse(localStorage.getItem("mokorin_history")||"[]");
      history.push(input);
      localStorage.setItem("mokorin_history",JSON.stringify(history));

      // åˆ†ã‹ã‚‹å˜èª/æ–‡æ³•ãƒ»åˆ†ã‹ã‚‰ãªã„ã‚‚ã®åˆ¤å®š
      let unknowns = [];
      let words = input.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, " ").split(/\s+/).filter(Boolean);
      for(let w of words){
        if(!basicGram[w] && (!memo[w]||memo[w]=="æœªå­¦ç¿’")){
          if(!unknowns.includes(w)) unknowns.push(w);
        }
      }

      // å­¦ç¿’
      learn(input);

      // æœªå­¦ç¿’ã‚ã‚Œã°å­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ æç¤º
      if(unknowns.length > 0){
        pendingLearn = {word: unknowns[0]};
        showLearnForm(unknowns[0]);
        printChat("bot", "ã€Œ" + unknowns[0] + "ã€ã¯ã¾ã ã‚ˆãçŸ¥ã‚‰ãªã„ã¿ãŸã„ã€‚æ„å‘³ã¨è¿”ã—æ–¹ã‚’æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ");
        document.getElementById("userInput").value="";
        return;
      }

      // æ—¢çŸ¥èªã®ã¿â†’é€šå¸¸ãƒãƒ«ã‚³ãƒ•å¿œç­”
      let reply = generate(input);
      printChat("bot", reply);
      document.getElementById("userInput").value="";
    }

    // ç”»é¢è¡¨ç¤º
    function printChat(type, text){
      let box = document.getElementById("chat");
      let div = document.createElement("div");
      div.className = type;
      div.textContent = (type=="user"?"ã‚ãªãŸ: ":"ã‚‚ã“ã‚Šã‚“: ")+text;
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    // å­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
    function showLearnForm(word){
      let area = document.getElementById("learnArea");
      area.innerHTML = `
      <form class="learn-form" onsubmit="return false;" id="formLearn">
        <label>ã€Œ${word}ã€ã®æ„å‘³ã‚’æ•™ãˆã¦ãã ã•ã„:</label>
        <input type="text" id="wordMean" placeholder="æ„å‘³ã‚’å…¥åŠ›" maxlength="30"><br>
        <label>ã“ã‚“ãªãµã†ã«è¿”ã—ã¦ã»ã—ã„ï¼ˆå€™è£œï¼‘ï¼‰:</label>
        <input type="text" id="resp1" placeholder="ä¾‹: ã™ã”ã„ã­ï¼" maxlength="30"><br>
        <label>å€™è£œï¼’:</label>
        <input type="text" id="resp2" placeholder="ä¾‹: ãã‚Œã¯é¢ç™½ã„ã­ï¼" maxlength="30"><br>
        <label>å€™è£œï¼“:</label>
        <input type="text" id="resp3" placeholder="ä¾‹: ã‚‚ã£ã¨æ•™ãˆã¦ï¼" maxlength="30"><br>
        <button onclick="submitLearn()">ä¿å­˜ã™ã‚‹</button>
      </form>
      `;
      document.getElementById("wordMean").focus();
    }

    // å­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ ã®ä¿å­˜
    window.submitLearn = function(){
      if(!pendingLearn) return;
      let mean = document.getElementById("wordMean").value.trim();
      let responses = [
        document.getElementById("resp1").value.trim(),
        document.getElementById("resp2").value.trim(),
        document.getElementById("resp3").value.trim()
      ].filter(Boolean);

      if(!mean || responses.length==0) {
        alert("æ„å‘³ã¨è¿”ç­”å€™è£œã‚’æœ€ä½1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ä¿å­˜
      memo[pendingLearn.word] = {
        meaning: mean,
        responses: responses
      };
      localStorage.setItem("mokorin_memo",JSON.stringify(memo));

      printChat("bot","ã‚ã‚ŠãŒã¨ã†ï¼è¦šãˆãŸã‚ˆã€‚æ¬¡ã‹ã‚‰ã¯ã€Œ"+pendingLearn.word+"ã€ã‚’è©±ã—ã¦ã‚‚è¿”ã›ã‚‹ã‚ˆã€‚");

      pendingLearn = null;
      document.getElementById("learnArea").innerHTML = "";
      document.getElementById("userInput").focus();
    }

    // å¿œç­”ç”Ÿæˆã®æ”¹è‰¯ï¼ˆmemoèªå¯¾å¿œï¼‰
    function generate(seed) {
      let words = seed.replace(/[ã€‚ï¼ï¼Ÿ\n]/g, " ").split(/\s+/).filter(Boolean);
      // æœªå­¦ç¿’èªã«memoã‚’ä½¿ã†
      for(let w of words){
        if(memo[w] && memo[w].responses && memo[w].responses.length>0){
          // ãƒ©ãƒ³ãƒ€ãƒ å€™è£œ
          let arr = memo[w].responses;
          return arr[Math.floor(Math.random()*arr.length)] + "ï¼ˆã€Œ" + w + "ã€ã®æ„å‘³: " + memo[w].meaning + "ï¼‰";
        }
      }
      // ãµã¤ã†ã®ãƒãƒ«ã‚³ãƒ•
      return defaultGen(seed);
    }
    // é€šå¸¸ãƒãƒ«ã‚³ãƒ•å¿œç­”
    function defaultGen(seed){
      let seedWords = seed.split(/\s+/).filter(Boolean);
      let w1 = seedWords[0]||Object.keys(chain)[0]?.split(" ")[0];
      let w2 = seedWords[1]||Object.keys(chain)[0]?.split(" ")[1];
      let result = [w1,w2];
      for(let i=0;i<15;i++) {
        let key = result[result.length-2]+" "+result[result.length-1];
        let nexts = chain[key];
        if(!nexts||nexts.length==0) break;
        let next = nexts[Math.floor(Math.random()*nexts.length)];
        result.push(next);
      }
      return result.join(" ")+"ã€‚";
    }

    // åˆå›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    printChat("bot","ã“ã‚“ã«ã¡ã¯ï¼ã¼ãã€ã‚‚ã“ã‚Šã‚“ğŸ¾ã€€ãªã‚“ã§ã‚‚è©±ã—ã‹ã‘ã¦ã­ã€‚");

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰é€ä¿¡å¯¾å¿œ
    document.getElementById("userInput").addEventListener("keydown", function(e){
      if(e.key==="Enter") chat();
    });
  </script>
</body>
</html>
