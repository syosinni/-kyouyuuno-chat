<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>会話AI「ともりん／もこりん」</title>
<style>
body { background: #f6fafe; font-family:"メイリオ", "Meiryo", sans-serif; text-align: center; margin:0;}
.topbar {background:#deedfc; padding:6px;}
h2 {margin-top:11px;}
.avatar { width:130px; height:130px; border-radius:50%; object-fit:cover; box-shadow: 0 8px 20px #b6e3f7 inset, 0 2px 8px #999; display:inline-block; margin-bottom:10px;}
#avatarDefault { width:130px; height:130px; display:inline-block; border-radius:50%; background:linear-gradient(135deg,#a6e3f7,#fff); position:relative;}
#avatarDefault .eye { position:absolute; width:24px; height:24px; background:#222; border-radius:50%; top:52px;}
#avatarDefault .eye.left { left:34px; }
#avatarDefault .eye.right { right:34px; }
#avatarDefault .mouth { position:absolute; width:36px; height:18px; border-radius:0 0 30px 30px; background:#fff; bottom:32px; left:48px;border-bottom:3px solid #89c9ea;}

#setup { background:#dfffe9; border-radius:14px; padding:13px 0; margin:0 auto 12px; width:370px;}
label {color:#29ad8e;}
input[type=text], input[type=file] { font-size:1em; border-radius:8px; border:1px solid #a7ece2; padding:4px;}

.chat-box { width: 350px; margin: 0 auto 16px; padding: 9px; background: #fff; border-radius:10px; box-shadow: 0 2px 12px #dceafd; min-height: 120px; max-height: 250px; overflow-y: auto; margin-top:7px;}
.user { text-align: right; color: #387fd4; }
.bot { text-align: left; color: #24a69a; position:relative;}
.favbtn { display:inline-block; margin-left:8px; background:#ffe486; border-radius:7px; padding:2px 6px; border:0; font-size:1em; cursor:pointer;}
.favbtn.active { background:#ffd46a;}
.input-area { margin: 16px auto; width: 350px;}
input, button, textarea { font-size: 1.08em; padding: 6px; border-radius:8px; border: 1px solid #d2eefb; margin: 2px;}
button { background:#e6f2fa;}
.learn-form {background:#fffbe6; padding:7px 12px; border-radius:10px; margin:10px auto;}
.learn-form label {display:block; margin:6px 0 2px; color:#d28721;}
#memoArea {font-size:0.97em; background:#eff4fb; padding:8px; border-radius:10px; width:340px; margin:10px auto;}
.miniBtn { font-size:0.92em; margin:0 2px; }
</style>
</head>
<body>
<div class="topbar">
  <b>会話AI - 友達モード／ペットもこりん</b>
  <button onclick="switchMode()" class="miniBtn" id="modeBtn">友達モードに切替</button>
  <button onclick="setupShow()" class="miniBtn">アイコン/名前設定</button>
  <button onclick="memoShow()" class="miniBtn">学習返答履歴</button>
  <button onclick="memoExport()" class="miniBtn">jsonエクスポート</button>
  <button onclick="memoImportShow()" class="miniBtn">jsonインポート</button>
</div>

<div id="setup" style="display:none;">
  <label>あなたのAIの名前:</label>
  <input type="text" id="friendName" value=""> <br>
  <label>写真アイコンをアップロード:</label>
  <input type="file" id="avatarFile" accept="image/*"> <br>
  <button onclick="setupSave()">保存して閉じる</button>
  <button onclick="setupHide()" style="margin-left:8px;">キャンセル</button>
  <div style="margin-top:7px;"><span style="font-size:0.98em;color:#777;">上記未設定の場合は「もこりん」&amp;イラストで始まります</span></div>
</div>

<div id="avatarZone">
  <div id="avatarDefault">
    <div class="eye left"></div>
    <div class="eye right"></div>
    <div class="mouth"></div>
  </div>
</div>
<h2 id="aiNameH">もこりん🐾</h2>

<div class="chat-box" id="chat"></div>
<form class="input-area" onsubmit="return false;" id="inputForm">
  <input id="userInput" type="text" placeholder="話しかけてみてね" autocomplete="off" size="27">
  <button onclick="chat()">送信</button>
</form>
<div id="learnArea"></div>
<div id="memoArea" style="display:none;"></div>
<div id="memoImportArea" style="display:none;">
  <label>jsonを貼り付けてインポート:</label>
  <textarea id="jsonImportBox" rows="5" cols="38"></textarea><br>
  <button onclick="memoImport()">インポート</button>
  <button onclick="memoImportHide()">キャンセル</button>
</div>
<script>
let chain = {};
let memo = JSON.parse(localStorage.getItem("friend_memo")||"{}");
let fav = JSON.parse(localStorage.getItem("friend_fav")||"{}");
let friendName = localStorage.getItem("friend_name") || "もこりん";
let avatarImg = localStorage.getItem("friend_avatar") || "";
let mode = localStorage.getItem("friend_mode") || "pet"; // pet or friend

const defaultTextPet = [
  "おはようございます。",
  "ごはん食べたいな。", "眠い気がするよ。", "なでてほしい。", "だいすきだよ。",
  "一緒にがんばろう！", "ありがとう。", "ぼく、もこりんっていうよ。"
];
const defaultTextFriend = [
  "おはよう！", "元気？", "何してるの？", "最近どう？", "ありがとう！",
  "一緒に遊ぼうよ。", "話そう！", "友達っていいね。"
];
// 日本語文法ベース
const basicGram = {
  "おはよう": "朝の挨拶", "こんにちは":"昼の挨拶", "こんばんは":"夜の挨拶",
  "ありがとう": "感謝", "だいすき":"好意", "ごはん":"食事", "遊ぶ":"行動", "眠い":"状態"
};

function chainInit(){
  chain = {};
  let list = (mode=="pet"?defaultTextPet:defaultTextFriend);
  list.forEach(learn);
  learnFromHistory();
}
function learn(text) {
  text = text.replace(/[。！？\n]/g, " ");
  let words = text.split(/\s+/).filter(Boolean);
  for (let i=0; i<words.length-2; i++) {
    let key = words[i] + " " + words[i+1];
    chain[key] = chain[key] || [];
    chain[key].push(words[i+2]);
  }
}
function learnFromHistory() {
  let history = JSON.parse(localStorage.getItem("friend_history")||"[]");
  history.forEach(learn);
}
chainInit();

let pendingLearn = null;
function chat() {
  if(pendingLearn) {
    printChat("bot",`「${pendingLearn.word}」については下の黄色フォームから教えてね。`);
    return;
  }
  let input = document.getElementById("userInput").value.trim();
  if(!input) return;
  printChat("user", input);

  let history = JSON.parse(localStorage.getItem("friend_history")||"[]");
  history.push(input);
  localStorage.setItem("friend_history",JSON.stringify(history));

  let unknowns = [];
  let words = input.replace(/[。！？\n]/g, " ").split(/\s+/).filter(Boolean);
  for(let w of words){
    if(!basicGram[w] && (!memo[w]||memo[w].responses===undefined)){
      if(!unknowns.includes(w)) unknowns.push(w);
    }
  }
  learn(input);

  if(unknowns.length > 0){
    pendingLearn = {word: unknowns[0]};
    showLearnForm(unknowns[0]);
    printChat("bot",`「${unknowns[0]}」って何？どんな風に返してほしい？例を最大3つ教えて！`);
    document.getElementById("userInput").value="";
    return;
  }

  let reply = generate(input, words);
  printChat("bot", reply, words);
  document.getElementById("userInput").value="";
}

function printChat(type, text, inputWords) {
  let box = document.getElementById("chat");
  let div = document.createElement("div");
  div.className = type;
  if(type=="user"){
    div.textContent = "あなた: " + text;
  }else{
    div.textContent = friendName+": " + text;
    // お気に入り追加ボタン
    let favBtn = document.createElement("button");
    favBtn.className = "favbtn" + (fav[text]?" active":"");
    favBtn.textContent = fav[text]?"★お気に入り":"☆お気に入り";
    favBtn.onclick = function(){
      if(fav[text]){
        delete fav[text];
      } else{
        fav[text]=true;
      }
      localStorage.setItem("friend_fav",JSON.stringify(fav));
      favBtn.textContent = fav[text]?"★お気に入り":"☆お気に入り";
      favBtn.className = "favbtn" + (fav[text]?" active":"");
    };
    div.appendChild(favBtn);
  }
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showLearnForm(word){
  let area = document.getElementById("learnArea");
  area.innerHTML = `
  <form class="learn-form" onsubmit="return false;" id="formLearn">
    <label>こんなふうに返してほしい（候補１）:</label>
    <input type="text" id="resp1" placeholder="例: すごいね！" maxlength="36"><br>
    <label>候補２:</label>
    <input type="text" id="resp2" placeholder="例: それは面白いね！" maxlength="36"><br>
    <label>候補３:</label>
    <input type="text" id="resp3" placeholder="例: もっと教えて！" maxlength="36"><br>
    <button onclick="submitLearn()">保存する</button>
  </form>
  `;
  document.getElementById("resp1").focus();
}

window.submitLearn = function(){
  if(!pendingLearn) return;
  let responses = [
    document.getElementById("resp1").value.trim(),
    document.getElementById("resp2").value.trim(),
    document.getElementById("resp3").value.trim()
  ].filter(Boolean);

  if(responses.length==0) {
    alert("返答候補を最低1つ以上入力してください。");
    return;
  }
  memo[pendingLearn.word] = { responses: responses };
  localStorage.setItem("friend_memo",JSON.stringify(memo));

  printChat("bot",`ありがとう！覚えたよ。「${pendingLearn.word}」に今度から返せるよ。`);
  pendingLearn = null;
  document.getElementById("learnArea").innerHTML = "";
  document.getElementById("userInput").focus();
}

function generate(seed, words) {
  // お気に入り候補優先
  for(let w of words){
    if(memo[w] && memo[w].responses && memo[w].responses.length>0){
      let arr = memo[w].responses;
      // お気に入りから優先出現
      let favs = arr.filter(x=>fav[x]);
      if(favs.length>0){
        return favs[Math.floor(Math.random()*favs.length)];
      }
      return arr[Math.floor(Math.random()*arr.length)];
    }
  }
  // マルコフ応答
  let seedWords = seed.split(/\s+/).filter(Boolean);
  let w1 = seedWords[0]||Object.keys(chain)[0]?.split(" ")[0];
  let w2 = seedWords[1]||Object.keys(chain)[0]?.split(" ")[1];
  let result = [w1,w2];
  for(let i=0;i<15;i++) {
    let key = result[result.length-2]+" "+result[result.length-1];
    let nexts = chain[key];
    if(!nexts||nexts.length==0) break;
    let next = nexts[Math.floor(Math.random()*nexts.length)];
    result.push(next);
  }
  return result.join(" ")+"。";
}

// 名前・写真設定
function setupShow(){
  document.getElementById("setup").style.display="block";
  document.getElementById("friendName").value=friendName;
}
function setupHide(){
  document.getElementById("setup").style.display="none";
}
function setupSave(){
  let name = document.getElementById("friendName").value.trim();
  friendName = name?name:"もこりん";
  localStorage.setItem("friend_name",friendName);
  document.getElementById("aiNameH").textContent = friendName;
  setupHide();
  let file = document.getElementById("avatarFile").files[0];
  if(file){
    let reader = new FileReader();
    reader.onload = function(e){
      avatarImg = e.target.result;
      localStorage.setItem("friend_avatar", avatarImg);
      avatarRender();
    };
    reader.readAsDataURL(file);
  }else{
    avatarImg="";
    localStorage.removeItem("friend_avatar");
    avatarRender();
  }
}
function avatarRender(){
  let zone = document.getElementById("avatarZone");
  if(avatarImg){
    zone.innerHTML='<img class="avatar" src="'+avatarImg+'">';
  }else{
    zone.innerHTML=`<div id="avatarDefault">
      <div class="eye left"></div>
      <div class="eye right"></div>
      <div class="mouth"></div>
    </div>`;
  }
}

// モード切替
function switchMode(){
  mode = mode=="pet"?"friend":"pet";
  localStorage.setItem("friend_mode",mode);
  document.getElementById("modeBtn").textContent = mode=="pet"?"友達モードに切替":"もこりんモードに切替";
  chainInit();
  document.getElementById("chat").innerHTML="";
  document.getElementById("userInput").value="";
  document.getElementById("aiNameH").textContent = friendName + (mode=="pet"?"🐾":"");
  avatarRender();
  printChat("bot",mode=="pet"?"こんにちは！ぼく、もこりん🐾　なんでも話しかけてね。":"やっほー！友達として話そう。");
}

// 学習履歴表示
function memoShow(){
  let area = document.getElementById("memoArea");
  let msg = Object.entries(memo).map(([w,v])=>
    `「${w}」: ${v.responses.map(r=>(fav[r]?"★":"")+r).join(" / ")}`
  ).join("<br>");
  area.innerHTML = "<b>学習した単語:</b><br>" +(msg||"まだありません");
  area.style.display="block";
}

// jsonエクスポート
function memoExport(){
  let data = JSON.stringify(memo,null,2);
  let blob = new Blob([data],{type:"application/json"});
  let url = URL.createObjectURL(blob);
  let dl=document.createElement("a");
  dl.href=url;dl.download="friend_memo.json";
  dl.click();
  setTimeout(()=>{URL.revokeObjectURL(url);},3333);
}

// jsonインポートエリア表示
function memoImportShow(){
  document.getElementById("memoImportArea").style.display="block";
}
function memoImportHide(){
  document.getElementById("memoImportArea").style.display="none";
}
// 実インポート
function memoImport(){
  let val = document.getElementById("jsonImportBox").value;
  try{
    let obj = JSON.parse(val);
    memo = obj;
    localStorage.setItem("friend_memo",JSON.stringify(memo));
    alert("インポートしました！");
    memoImportHide();
  }catch(e){alert("json形式が正しくありません");}
}

// 初期描画
avatarRender();
document.getElementById("aiNameH").textContent = friendName +(mode=="pet"?"🐾":"");
document.getElementById("modeBtn").textContent = mode=="pet"?"友達モードに切替":"もこりんモードに切替";
printChat("bot",mode=="pet"?"こんにちは！ぼく、もこりん🐾　なんでも話しかけてね。":"やっほー！友達として話そう。");

// キーボード送信対応
document.getElementById("userInput").addEventListener("keydown", function(e){if(e.key==="Enter") chat();});

</script>
</body>
</html>
