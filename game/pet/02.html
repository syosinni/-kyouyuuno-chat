<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã¨ã‚‚ã‚Šã‚“ï¼ã‚‚ã“ã‚Šã‚“ - AIå­¦ç¿’ã‚²ãƒ¼ãƒ ï¼ˆå˜èªãƒ»æ–‡æ³•å¯¾å¿œï¼‰</title>
    <style>
        /* CSS: ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å‚è€ƒã«ã€æ¸…æ½”ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f8ff; /* è–„ã„æ°´è‰² */
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #aiPetDisplay {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* ã‚¢ãƒã‚¿ãƒ¼ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ (å…ƒã®MHTMLã‚’å‚è€ƒã«) */
        #avatarDefault {
            width: 100px;
            height: 100px;
            display: inline-block;
            border-radius: 50%;
            background: linear-gradient(135deg, rgb(166, 227, 247), rgb(255, 255, 255));
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        #avatarDefault .eye {
            position: absolute;
            width: 18px;
            height: 18px;
            background: rgb(34, 34, 34);
            border-radius: 50%;
            top: 40px;
        }

        #avatarDefault .eye.left { left: 25px; }
        #avatarDefault .eye.right { right: 25px; }

        #avatarDefault .mouth {
            position: absolute;
            width: 28px;
            height: 14px;
            border-radius: 0 0 30px 30px;
            background: #fff;
            bottom: 25px;
            left: 36px;
            border-bottom: 3px solid rgb(137, 201, 234);
        }
        
        #aiAvatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #66b3e7;
            margin-bottom: 10px;
        }

        #aiName {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 15px;
        }

        /* å¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« */
        #aiSpeech {
            background: #e1f5fe;
            border-radius: 10px;
            padding: 10px 15px;
            margin: 10px 0 20px 0;
            text-align: left;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        #aiSpeech::before {
            content: '';
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent #e1f5fe transparent;
            position: absolute;
            top: -10px;
            left: 50px;
        }


        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        #userInput {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #b3e5fc;
            border-radius: 8px;
            font-size: 1em;
        }

        button {
            background: #81d4fa;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background: #4fc3f7;
        }

        /* ã‚¿ãƒ–ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            flex-grow: 1;
            padding: 10px;
            background: #eee;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            color: #555;
        }

        .tab-btn.active {
            background: #fff;
            border-bottom: 2px solid #81d4fa;
            color: #4a90e2;
        }

        .tab-content {
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 0 0 10px 10px;
            text-align: left;
        }

        .data-input-group {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .data-input-group label {
            font-weight: bold;
            font-size: 0.9em;
            color: #4a90e2;
        }

        .data-input-group input, .data-input-group textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* JSONæ“ä½œã‚¨ãƒªã‚¢ */
        .json-area {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px dashed #ccc;
        }

        .json-area button {
            margin-right: 10px;
            padding: 8px 12px;
        }
        
        .storage-status {
            font-size: 0.8em;
            color: green;
            margin-top: 10px;
            text-align: right;
        }
        
        h3 {
            color: #4a90e2;
            border-bottom: 2px solid #b3e5fc;
            padding-bottom: 5px;
            margin-top: 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ã¨ã‚‚ã‚Šã‚“ï¼ã‚‚ã“ã‚Šã‚“ ğŸ’¬</h1>
        <p>AIã«è¨€è‘‰ã€å˜èªã€æ–‡æ³•ã‚’è¦šãˆã•ã›ã‚‹ã‚²ãƒ¼ãƒ </p>

        <div id="aiPetDisplay">
            <div id="avatarContainer">
                <div id="avatarDefault" class="default-avatar">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                    <div class="mouth"></div>
                </div>
            </div>
            
            <div id="aiName">ã¨ã‚‚ã‚Šã‚“</div>

            <div id="aiSpeech">ã“ã‚“ã«ã¡ã¯ï¼ãŸãã•ã‚“è¨€è‘‰ã‚’æ•™ãˆã¦ã­ã€‚</div>
        </div>
        
        <div class="input-area">
            <input type="text" id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
            <button onclick="handleChat()">é€ä¿¡</button>
        </div>
        
        <div class="storage-status" id="saveStatus"></div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('learning', this)">ğŸ’¡å­¦ç¿’</button>
            <button class="tab-btn" onclick="showTab('settings', this)">âš™ï¸è¨­å®šãƒ»JSON</button>
        </div>

        <div id="learning" class="tab-content">
            <h3>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²</h3>
            <div class="data-input-group">
                <label for="learningType">å­¦ç¿’ã‚¿ã‚¤ãƒ—:</label>
                <select id="learningType" onchange="updateLearningInputs(this.value)">
                    <option value="dialogue">1. ä¼šè©±ï¼ˆæ–‡ç« ã¨è¿”ç­”ï¼‰</option>
                    <option value="vocabulary">2. å˜èªï¼ˆèªå½™ã¨èª¬æ˜/åå¿œï¼‰</option>
                    <option value="grammar">3. æ–‡æ³•ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨è¿”ç­”æ§‹é€ ï¼‰</option>
                </select>
            </div>

            <div class="data-input-group">
                <label id="inputLabel" for="inputData">å…¥åŠ›ï¼ˆä¼šè©±å…¨ä½“ã€å˜èªã€æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹:ã€Œã€œãŒå¥½ãã€ï¼‰</label>
                <input type="text" id="inputData" placeholder="ä¾‹: ãŠè…¹ç©ºã„ãŸ" required>
            </div>

            <div class="data-input-group">
                <label id="outputLabel" for="outputData">å‡ºåŠ›ãƒ»è¿”ç­”ï¼ˆAIã®è¿”äº‹ï¼‰</label>
                <input type="text" id="outputData" placeholder="ä¾‹: ä½•ã‹é£Ÿã¹ã‚‹ï¼Ÿ" required>
            </div>

            <button onclick="addLearningData()">ã“ã®å†…å®¹ã‚’è¦šãˆã•ã›ã‚‹</button>
            
            <p style="margin-top: 15px; font-size: 0.9em; color: #555;">â€»ã€Œå…¥åŠ›ã€ã¨å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ã‹ã€æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã™ã‚‹å ´åˆã«AIãŒåå¿œã—ã¾ã™ã€‚</p>
        </div>

        <div id="settings" class="tab-content" style="display: none;">
            <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š</h3>
            <div class="data-input-group">
                <label for="charNameInput">AIã®åå‰å¤‰æ›´:</label>
                <input type="text" id="charNameInput" placeholder="æ–°ã—ã„åå‰" oninput="changeCharacterName(this.value)">
            </div>
            <div class="data-input-group">
                <label for="avatarFile">AIã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´ (ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«):</label>
                <input type="file" id="avatarFile" accept="image/*" onchange="changeCharacterAvatar(event)">
                <button style="background: #ef5350;" onclick="clearAvatar()">ã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆæœŸåŒ–</button>
            </div>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

            <h3>JSONãƒ‡ãƒ¼ã‚¿ã®å…±æœ‰ãƒ»ç®¡ç†</h3>
            <div class="json-area">
                <p style="font-size: 0.9em;">AIã®å…¨å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚</p>
                <button onclick="exportJSON()">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’JSONã§ä¿å­˜</button>
                <label for="importFile" style="background: #66bb6a; color: white; padding: 10px 15px; border-radius: 8px; cursor: pointer; display: inline-block; font-weight: bold;">
                    å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’JSONã‹ã‚‰èª­ã¿è¾¼ã¿
                </label>
                <input type="file" id="importFile" accept=".json" onchange="importJSON(event)" style="display: none;">
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ff9800;">
                
                <button style="background: #ef5350;" onclick="clearAllData()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆè¨­å®šãƒ»å­¦ç¿’å†…å®¹ï¼‰ã‚’æ¶ˆå»</button>
                <p style="font-size: 0.8em; color: #ef5350;">â€»ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚ŒãŸå†…å®¹ã‚‚ã™ã¹ã¦æ¶ˆå»ã•ã‚Œã€åˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®å®šç¾©ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿
        const defaultData = {
            character: {
                name: "ã¨ã‚‚ã‚Šã‚“",
                icon: "default", // 'default' or a base64 string
            },
            learning_data: {
                dialogue_pairs: [
                    { input: "ã“ã‚“ã«ã¡ã¯", output: "ã‚„ã£ã»ãƒ¼ï¼" },
                    { input: "ã‚ã‚ŠãŒã¨ã†", output: "ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼" },
                    { input: "ãŠã‚„ã™ã¿", output: "ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã­" },
                ],
                vocabulary: [
                    { word: "ã‚Šã‚“ã”", response: "èµ¤ãã¦ä¸¸ã„æœç‰©ã ã‚ˆã­ã€‚ç¾å‘³ã—ã„ï¼" },
                    { word: "ã‚²ãƒ¼ãƒ ", response: "å¾—æ„ã ã‚ˆï¼ä¸€ç·’ã«éŠã¼ã†ï¼" },
                ],
                grammar_patterns: [
                    { pattern: "ã€œãŒå¥½ã", response: "ç§ã‚‚ã€œãŒå¥½ãã ã‚ˆã€‚" },
                    { pattern: "ã€œã¯[å½¢å®¹è©]", response: "ã¸ãƒ¼ã€ã€œã¯[å½¢å®¹è©]ãªã‚“ã ã­ï¼" },
                ]
            }
        };

        let AIPet = {};
        const LOCAL_STORAGE_KEY = 'AIPetDataV2'; // æ—§ãƒ‡ãƒ¼ã‚¿ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã«ã‚­ãƒ¼ã‚’å¤‰æ›´

        // =================================================================
        // 1. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯ï¼ˆLocal Storageï¼‰ã‚’åˆ©ç”¨ã—ãŸè‡ªå‹•ä¿å­˜ã¨èª­ã¿è¾¼ã¿
        // =================================================================

        /**
         * ãƒ‡ãƒ¼ã‚¿ã‚’Local Storageã«è‡ªå‹•ä¿å­˜ã™ã‚‹
         */
        function saveData() {
            try {
                // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã«å¤‰å‹•ãŒã‚ã£ãŸã‚‰ã€ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                const statusElement = document.getElementById('saveStatus');
                statusElement.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';

                // JSON.stringifyã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—åŒ–ã—ã¦ä¿å­˜
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(AIPet.data));
                
                setTimeout(() => {
                    statusElement.textContent = `âœ… ${new Date().toLocaleTimeString()} ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`;
                }, 500);

            } catch (e) {
                document.getElementById('saveStatus').textContent = 'âŒ ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                console.error("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
            }
        }

        /**
         * Local Storageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€UIã‚’æ›´æ–°ã™ã‚‹
         */
        function loadData() {
            const savedDataJSON = localStorage.getItem(LOCAL_STORAGE_KEY);
            
            if (savedDataJSON) {
                AIPet.data = JSON.parse(savedDataJSON);
                console.log("ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚");
            } else {
                // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ (ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼)
                AIPet.data = JSON.parse(JSON.stringify(defaultData)); 
                console.log("ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸã€‚");
            }

            // äº’æ›æ€§ç¢ºä¿: æ–°ã—ã„å­¦ç¿’ã‚¿ã‚¤ãƒ—ãŒæ¬ ã‘ã¦ã„ãŸã‚‰åˆæœŸåŒ–
            const ld = AIPet.data.learning_data;
            ld.vocabulary = ld.vocabulary || [];
            ld.grammar_patterns = ld.grammar_patterns || [];

            updateUI();
        }

        /**
         * ç”»é¢ä¸Šã®è¦ç´ ã‚’ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹
         */
        function updateUI() {
            const char = AIPet.data.character;
            
            // 1. åå‰ã‚’æ›´æ–°
            document.getElementById('aiName').textContent = char.name;
            document.getElementById('charNameInput').value = char.name;

            // 2. ã‚¢ãƒã‚¿ãƒ¼ã‚’æ›´æ–°
            const avatarContainer = document.getElementById('avatarContainer');
            avatarContainer.innerHTML = ''; // ä¸€åº¦ã‚¯ãƒªã‚¢
            
            if (char.icon === 'default') {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®HTMLã‚’å†æŒ¿å…¥
                avatarContainer.innerHTML = `
                    <div id="avatarDefault" class="default-avatar">
                        <div class="eye left"></div>
                        <div class="eye right"></div>
                        <div class="mouth"></div>
                    </div>
                `;
            } else {
                // ã‚«ã‚¹ã‚¿ãƒ ç”»åƒã‚’è¡¨ç¤º
                const img = document.createElement('img');
                img.id = 'aiAvatar';
                img.src = char.icon;
                avatarContainer.appendChild(img);
            }
        }


        // =================================================================
        // 2. ä¼šè©±å‡¦ç†ï¼ˆå˜èªãƒ»æ–‡æ³•ãƒ»æ–‡ç« ã®å„ªå…ˆé †ä½ä»˜ã‘ï¼‰
        // =================================================================

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒ£ãƒƒãƒˆã‚’å‡¦ç†ã—ã€AIã®è¿”ç­”ã‚’ç”Ÿæˆã™ã‚‹
         */
        function handleChat() {
            const inputElement = document.getElementById('userInput');
            const userInput = inputElement.value.trim();
            inputElement.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢

            if (userInput === "") return;

            let response = "ã†ãƒ¼ã‚“ã€ãã®è¨€è‘‰ã¯ã¾ã çŸ¥ã‚‰ãªã„ãªâ€¦ã€‚æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¿”ç­”

            // 1. ä¼šè©±ãƒšã‚¢ï¼ˆå®Œå…¨ä¸€è‡´ï¼‰ãƒã‚§ãƒƒã‚¯ (å„ªå…ˆåº¦: é«˜)
            const dialogueMatch = AIPet.data.learning_data.dialogue_pairs.find(pair => pair.input === userInput);
            if (dialogueMatch) {
                response = dialogueMatch.output;
            } 
            
            // 2. å˜èªï¼ˆèªå½™ï¼‰ãƒã‚§ãƒƒã‚¯ (å„ªå…ˆåº¦: ä¸­)
            // å…¥åŠ›æ–‡ã«å­¦ç¿’ã—ãŸå˜èªãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
            else {
                for (const item of AIPet.data.learning_data.vocabulary) {
                    // å˜èªãŒå…¥åŠ›æ–‡ã«å«ã¾ã‚Œã¦ã„ã‚Œã°ãƒ’ãƒƒãƒˆ
                    if (userInput.includes(item.word)) {
                        response = item.response;
                        break;
                    }
                }
            }

            // 3. æ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ (å„ªå…ˆåº¦: ä½)
            // å˜èªãƒãƒƒãƒã‚‚ãªã‹ã£ãŸå ´åˆã«ã®ã¿å®Ÿè¡Œ
            if (response === "ã†ãƒ¼ã‚“ã€ãã®è¨€è‘‰ã¯ã¾ã çŸ¥ã‚‰ãªã„ãªâ€¦ã€‚æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ") {
                for (const item of AIPet.data.learning_data.grammar_patterns) {
                    const pattern = item.pattern;
                    let responseTemplate = item.response;

                    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ¤œå‡ºãƒ»ç½®æ›
                    // ä¾‹: å…¥åŠ›ã€Œã‚Šã‚“ã”ãŒå¥½ãã€, ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œã€œãŒå¥½ãã€
                    // ä¾‹: å…¥åŠ›ã€Œã¨ã‚‚ã‚Šã‚“ã¯ã‹ã‚ã„ã„ã€, ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œã€œã¯[å½¢å®¹è©]ã€
                    
                    let matchFound = false;
                    let matchedValue = '';

                    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã€Œã€œã€ã§å§‹ã¾ã‚‹å ´åˆ
                    if (pattern.startsWith('ã€œ')) {
                        const suffix = pattern.substring(1); // ä¾‹: ã€ŒãŒå¥½ãã€
                        if (userInput.endsWith(suffix)) {
                            matchedValue = userInput.substring(0, userInput.length - suffix.length); // ä¾‹: ã€Œã‚Šã‚“ã”ã€
                            response = responseTemplate.replace('ã€œ', matchedValue).replace('[å½¢å®¹è©]', matchedValue); // å¿œç­”ã‚‚ç½®æ›
                            matchFound = true;
                        }
                    } 
                    
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒç‰¹å®šã®æ§‹é€ ã‚’æŒã¤å ´åˆ (ä¾‹: [åè©]ã‚„[å½¢å®¹è©]ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼)
                    else if (pattern.includes('[')) {
                        const regexString = pattern
                            .replace(/\[åè©\]/g, '(.+?)')
                            .replace(/\[å‹•è©\]/g, '(.+?)')
                            .replace(/\[å½¢å®¹è©\]/g, '(.+?)')
                            .replace(/ã€œ/g, '(.+?)'); // ã€œã‚‚ãƒãƒƒãƒãƒ³ã‚°å¯¾è±¡ã«è¿½åŠ 
                        
                        const regex = new RegExp(`^${regexString}$`);
                        const matches = userInput.match(regex);
                        
                        if (matches) {
                            // ãƒãƒƒãƒã—ãŸå€¤ã‚’ä½¿ã£ã¦å¿œç­”ã‚’æ§‹ç¯‰
                            let currentResponse = responseTemplate;
                            let placeholderIndex = 1;
                            
                            // [åè©], [å‹•è©], [å½¢å®¹è©], ã€œ ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’é †ã«ç½®æ›
                            currentResponse = currentResponse.replace(/\[åè©\]|\[å‹•è©\]|\[å½¢å®¹è©\]|ã€œ/g, (match) => {
                                // æ¤œå‡ºã•ã‚ŒãŸè¦ç´ ï¼ˆmatches[1], matches[2]ãªã©ï¼‰ã§ç½®ãæ›ãˆ
                                return matches[placeholderIndex++] || match; 
                            });

                            response = currentResponse;
                            matchFound = true;
                        }
                    }

                    if (matchFound) {
                        break;
                    }
                }
            }

            // 4. AIã®å¿œç­”ã‚’è¡¨ç¤º
            document.getElementById('aiSpeech').textContent = response;
        }

        /**
         * å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹
         */
        function addLearningData() {
            const type = document.getElementById('learningType').value;
            const input = document.getElementById('inputData').value.trim();
            const output = document.getElementById('outputData').value.trim();

            if (!input || !output) {
                alert("å…¥åŠ›ã¨è¿”ç­”ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const ld = AIPet.data.learning_data;
            const newData = { input: input, output: output };

            if (type === 'dialogue') {
                // ä¼šè©±ãƒšã‚¢ï¼ˆæ–‡ç« ï¼‰
                ld.dialogue_pairs.push(newData);
            } else if (type === 'vocabulary') {
                // å˜èªï¼ˆèªå½™ï¼‰
                ld.vocabulary.push({ word: input, response: output });
            } else if (type === 'grammar') {
                // æ–‡æ³•ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                ld.grammar_patterns.push({ pattern: input, response: output });
            }

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('inputData').value = '';
            document.getElementById('outputData').value = '';
            
            saveData();
            document.getElementById('aiSpeech').textContent = `ã€Œ${input}ã€ã¨ã€Œ${output}ã€ã‚’æ–°ã—ãè¦šãˆãŸã‚ˆï¼`;
        }

        // =================================================================
        // 3. è¨­å®šãƒ»JSONæ“ä½œ
        // =================================================================

        /**
         * ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
         */
        function showTab(tabId, element) {
            // å…¨ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã—ã€ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è§£é™¤
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã€ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.getElementById(tabId).style.display = 'block';
            element.classList.add('active');
            
            // å­¦ç¿’ã‚¿ãƒ–ã®å…¥åŠ›æ¬„ã‚’åˆæœŸåŒ–
            if (tabId === 'learning') {
                updateLearningInputs(document.getElementById('learningType').value);
            }
        }
        
        /**
         * å­¦ç¿’ã‚¿ã‚¤ãƒ—ã«åˆã‚ã›ã¦å…¥åŠ›ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
         */
        function updateLearningInputs(type) {
            const inputLabel = document.getElementById('inputLabel');
            const outputLabel = document.getElementById('outputLabel');
            const inputElement = document.getElementById('inputData');
            
            if (type === 'dialogue') {
                inputLabel.textContent = "å…¥åŠ›ï¼ˆä¼šè©±å…¨ä½“ï¼‰";
                outputLabel.textContent = "å‡ºåŠ›ãƒ»è¿”ç­”ï¼ˆAIã®è¿”äº‹ï¼‰";
                inputElement.placeholder = "ä¾‹: ãŠè…¹ç©ºã„ãŸ";
            } else if (type === 'vocabulary') {
                inputLabel.textContent = "å…¥åŠ›ï¼ˆå˜èªãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰";
                outputLabel.textContent = "å‡ºåŠ›ãƒ»è¿”ç­”ï¼ˆæ„å‘³ã‚„åå¿œï¼‰";
                inputElement.placeholder = "ä¾‹: ã‚Šã‚“ã”";
            } else if (type === 'grammar') {
                inputLabel.textContent = "å…¥åŠ›ï¼ˆæ–‡æ³•ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹ï¼‰";
                outputLabel.textContent = "å‡ºåŠ›ãƒ»è¿”ç­”ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆã‚ã›ãŸæ§‹é€ ï¼‰";
                inputElement.placeholder = "ä¾‹: ã€œã¯[å½¢å®¹è©]";
            }
        }

        /**
         * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å¤‰æ›´ã™ã‚‹
         */
        function changeCharacterName(name) {
            AIPet.data.character.name = name;
            updateUI();
            saveData();
        }

        /**
         * ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã€base64ã§ä¿å­˜ã™ã‚‹
         */
        function changeCharacterAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Base64å½¢å¼ã§ä¿å­˜
                AIPet.data.character.icon = e.target.result;
                updateUI();
                saveData();
            };
            reader.readAsDataURL(file);
        }
        
        /**
         * ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
         */
        function clearAvatar() {
            AIPet.data.character.icon = 'default';
            document.getElementById('avatarFile').value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢
            updateUI();
            saveData();
            document.getElementById('aiSpeech').textContent = "ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ãŸã‚ˆï¼";
        }

        /**
         * JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰ã™ã‚‹
         */
        function exportJSON() {
            const dataStr = JSON.stringify(AIPet.data, null, 2); // 2ã‚¹ãƒšãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã§æ•´å½¢
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const filename = AIPet.data.character.name + '_AI_data.json';
            a.download = filename;
            a.href = url;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('aiSpeech').textContent = "å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ãŸã‚ˆï¼";
        }

        /**
         * JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰ã™ã‚‹
         * ğŸš¨ æ—§å½¢å¼ã®JSONãƒ‡ãƒ¼ã‚¿ã«ã‚‚å¯¾å¿œ
         */
        function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let newLearningData = importedData.learning_data;
                    
                    // --- äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚° ---
                    if (!importedData.learning_data && importedData.character) {
                        // **æ—§å½¢å¼ã®JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æƒ³å®š**
                        // æ—§JSONã¯ learning_dataã‚­ãƒ¼ãŒãªãã€dialogue_pairsãªã©ãŒç›´æ¥ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹å ´åˆã‚’æƒ³å®š
                        newLearningData = {
                            // å¾“æ¥ã®ä¼šè©±ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°ãã®ã¾ã¾ä½¿ç”¨
                            dialogue_pairs: importedData.dialogue_pairs || [], 
                            // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã¯ç©ºã§åˆæœŸåŒ–
                            vocabulary: [],
                            grammar_patterns: []
                        };
                    } else if (newLearningData) {
                         // **æ–°å½¢å¼ã®JSONãƒ‡ãƒ¼ã‚¿æ§‹é€ **
                        // æ¬ ã‘ã¦ã„ã‚‹æ–°ã—ã„ã‚­ãƒ¼ã‚’å®‰å…¨ã«åˆæœŸåŒ–
                        newLearningData.vocabulary = newLearningData.vocabulary || [];
                        newLearningData.grammar_patterns = newLearningData.grammar_patterns || [];
                    } else {
                        throw new Error("JSONãƒ•ã‚¡ã‚¤ãƒ«ã«å¿…è¦ãªå­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                    }
                    // ------------------------------------

                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    AIPet.data.character = importedData.character || defaultData.character;
                    AIPet.data.learning_data = newLearningData;

                    updateUI();
                    saveData();
                    document.getElementById('aiSpeech').textContent = "æ–°ã—ã„å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’JSONã‹ã‚‰èª­ã¿è¾¼ã‚“ã ã‚ˆï¼AIã®å€‹æ€§ãŒå¤‰ã‚ã£ãŸã‹ã‚‚ã€‚";

                } catch (error) {
                    alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: " + error.message);
                    console.error("JSON Import Error:", error);
                } finally {
                    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›è¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }
        
        /**
         * å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆLocal Storageï¼‰ã‚’æ¶ˆå»ã—ã€åˆæœŸåŒ–ã™ã‚‹
         */
        function clearAllData() {
            if (confirm("âš ï¸æœ¬å½“ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã¨å…¨ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¦åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                loadData(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã§å†ãƒ­ãƒ¼ãƒ‰
                document.getElementById('aiSpeech').textContent = "ã™ã¹ã¦åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸã€‚ã¾ãŸä¸€ã‹ã‚‰ç§ã‚’è‚²ã¦ã¦ã­ï¼";
                alert("å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå»ã•ã‚Œã€AIãŒåˆæœŸçŠ¶æ…‹ã«æˆ»ã‚Šã¾ã—ãŸã€‚");
            }
        }


        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        window.onload = function() {
            loadData();
            showTab('learning', document.querySelector('.tab-btn.active'));
        };
    </script>
</body>
</html>
