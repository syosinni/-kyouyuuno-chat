<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>バケツツール風SVG塗り</title>
  <style>
    body { text-align: center; font-family: sans-serif; background: #f0f0f0; }
    #wrapper { position: relative; display: inline-block; }
    #bg-svg { display: block; }
    #paint-canvas {
      position: absolute; top: 0; left: 0;
      cursor: crosshair;
    }
    #controls { margin: 10px; }
  </style>
</head>
<body>

<h1>キャンバス上にバケツ塗り（Flood Fill）</h1>
<div id="controls">
  <input type="color" id="colorPicker" value="#42a5f5">
</div>

<div id="wrapper">
  <img id="bg-svg" src="https://kyouyuuno-to.f5.si/img/0001.svg" alt="SVGマップ">
  <canvas id="paint-canvas"></canvas>
</div>

<script>
  const img = document.getElementById('bg-svg');
  const canvas = document.getElementById('paint-canvas');
  const ctx = canvas.getContext('2d');
  const colorPicker = document.getElementById('colorPicker');

  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  canvas.addEventListener('click', e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const fillColor = hexToRgba(colorPicker.value, 255);
    floodFill(canvas, x, y, fillColor);
  });

  // Hex to RGBA 配列変換
  function hexToRgba(hex, a=255) {
    const v = hex.replace('#','');
    const bigint = parseInt(v,16);
    return [(bigint >> 16)&255, (bigint >>8)&255, bigint&255, a];
  }

  // Flood Fill 実装（スタック法）
  function floodFill(canvas, x, y, fillColor){
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    const imgData = ctx.getImageData(0,0,w,h);
    const data = imgData.data;
    const startPos = (y*w + x)*4;
    const baseColor = data.slice(startPos, startPos+4).join(',');
    const stack = [[x,y]];

    if (baseColor === fillColor.join(',')) return;

    while(stack.length){
      const [cx, cy] = stack.pop();
      const pos = (cy*w + cx)*4;
      if (cx<0 || cy<0 || cx>=w || cy>=h) continue;
      const colorHere = data.slice(pos, pos+4).join(',');
      if (colorHere !== baseColor) continue;
      data[pos] = fillColor[0];
      data[pos+1] = fillColor[1];
      data[pos+2] = fillColor[2];
      data[pos+3] = fillColor[3];
      stack.push([cx+1, cy],[cx-1, cy],[cx, cy+1],[cx, cy-1]);
    }

    ctx.putImageData(imgData,0,0);
  }
</script>

</body>
</html>
