<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç©ºæƒ³åœ°å›³ã‚¨ãƒ‡ã‚£ã‚¿ï¼ˆver 1.2.5ï¼‰</title>
  <style>
    body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
    #sidebar { width: 250px; background: #f4f4f4; padding: 10px; overflow-y: auto; }
    #map-container { flex: 1; position: relative; }
    iframe { width: 100%; height: 100%; border: none; }
    canvas { position: absolute; top: 0; left: 0; z-index: 100; pointer-events: auto; }
    button, select, input { width: 100%; margin-top: 5px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <button onclick="toggleMapMode()">ğŸ—ºï¸ <span id="modeLabel">å»ºç¯‰ãƒ¢ãƒ¼ãƒ‰</span></button>
    <select id="buildingType">
      <option value="è¦å¡">è¦å¡</option>
      <option value="æµ·è»åŸºåœ°">æµ·è»åŸºåœ°</option>
      <option value="é™¸è»åŸºåœ°">é™¸è»åŸºåœ°</option>
    </select>
    <input type="text" id="customName" placeholder="åå‰ï¼ˆç©ºç™½ã§è‡ªå‹•ï¼‰">
    <button onclick="setMode('single')">ğŸ“ å»ºç‰©é…ç½®</button>
    <button onclick="setMode('fortLine')">ğŸ§± è¦å¡ ç·šé…ç½®</button>
    <button onclick="setMode('delete')">ğŸ—‘ï¸ å‰Šé™¤</button>
    <hr>
    <button onclick="downloadJSON()">ğŸ’¾ JSONä¿å­˜</button>
    <input type="file" onchange="loadJSON(event)">
  </div>

  <div id="map-container">
    <iframe id="mapFrame" src="https://maps.gsi.go.jp/?hc=hic#5/36.104611/140.084556/&base=std&ls=std&disp=1&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1"></iframe>
    <canvas id="overlayCanvas"></canvas>
  </div>

  <script>
    const canvas = document.getElementById("overlayCanvas");
    const ctx = canvas.getContext("2d");
    const modeLabel = document.getElementById("modeLabel");
    let buildings = [];
    let isMapMode = false;
    let mode = "single";
    let linePoints = [];

    // ===== ã‚ºãƒ¼ãƒ ã¨ä¸­å¿ƒã‚’ç®¡ç† =====
    let mapCenter = { lat: 36.104611, lon: 140.084556 };
    let zoom = 5;

    function resizeCanvas() {
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = canvas.parentElement.clientHeight;
      draw();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function toggleMapMode() {
      isMapMode = !isMapMode;
      document.getElementById("mapFrame").style.pointerEvents = isMapMode ? "auto" : "none";
      canvas.style.pointerEvents = isMapMode ? "none" : "auto";
      modeLabel.textContent = isMapMode ? "ãƒãƒƒãƒ—ç§»å‹•ãƒ¢ãƒ¼ãƒ‰" : "å»ºç¯‰ãƒ¢ãƒ¼ãƒ‰";
    }

    function setMode(newMode) {
      mode = newMode;
      if (mode !== "fortLine") linePoints = [];
    }

    // ==== ç·¯åº¦çµŒåº¦å¤‰æ›ï¼ˆæ“¬ä¼¼çš„ãªæ­£è·å††ç­’æŠ•å½±ï¼‰====
    function screenToLatLon(x, y) {
      const w = canvas.width;
      const h = canvas.height;
      const scale = Math.pow(2, zoom);
      const lon = mapCenter.lon + (x - w / 2) / (256 * scale) * 360;
      const lat = mapCenter.lat - (y - h / 2) / (256 * scale) * 180;
      return { lat, lon };
    }

    function latLonToScreen(lat, lon) {
      const w = canvas.width;
      const h = canvas.height;
      const scale = Math.pow(2, zoom);
      const x = (lon - mapCenter.lon) / 360 * (256 * scale) + w / 2;
      const y = (mapCenter.lat - lat) / 180 * (256 * scale) + h / 2;
      return { x, y };
    }

    canvas.addEventListener("click", e => {
      if (isMapMode) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const { lat, lon } = screenToLatLon(x, y);

      if (mode === "single") {
        const type = document.getElementById("buildingType").value;
        const name = document.getElementById("customName").value || type;
        buildings.push({ lat, lon, type, name });
      }

      if (mode === "fortLine") {
        linePoints.push({ lat, lon });
        if (linePoints.length >= 2) {
          const p1 = linePoints[linePoints.length - 2];
          const p2 = linePoints[linePoints.length - 1];
          const name = document.getElementById("customName").value || "è¦å¡ç·š";
          buildings.push({ type: "è¦å¡ç·š", name, lat1: p1.lat, lon1: p1.lon, lat2: p2.lat, lon2: p2.lon });
        }
      }

      if (mode === "delete") {
        buildings = buildings.filter(b => {
          const point = b.lat ? latLonToScreen(b.lat, b.lon) :
            latLonToScreen((b.lat1 + b.lat2) / 2, (b.lon1 + b.lon2) / 2);
          return Math.hypot(point.x - x, point.y - y) > 10;
        });
      }
      draw();
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (const b of buildings) {
        if (b.type === "è¦å¡ç·š") {
          const p1 = latLonToScreen(b.lat1, b.lon1);
          const p2 = latLonToScreen(b.lat2, b.lon2);
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(p1.x, p1.y);
          ctx.lineTo(p2.x, p2.y);
          ctx.stroke();
        } else {
          const p = latLonToScreen(b.lat, b.lon);
          ctx.fillStyle = "blue";
          ctx.fillRect(p.x - 5, p.y - 5, 10, 10);
          ctx.fillStyle = "black";
          ctx.fillText(b.name, p.x + 7, p.y);
        }
      }
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify({ buildings }, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "map_data.json";
      link.click();
    }

    function loadJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = JSON.parse(e.target.result);
        buildings = data.buildings || [];
        draw();
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
