<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>空想地図エディタ</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #sidebar {
      width: 250px; background: #f4f4f4; padding: 10px; overflow-y: auto;
    }
    #map-container {
      flex: 1; position: relative;
    }
    iframe {
      width: 100%; height: 100%;
      border: none;
      pointer-events: none; /* 初期は操作無効（建築モード） */
    }
    canvas {
      position: absolute;
      top: 0; left: 0; z-index: 100;
      pointer-events: auto;
    }
    button, select, input {
      width: 100%; margin-top: 5px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>ツール</h3>
    <button onclick="toggleMapMode()">🗺️ <span id="modeLabel">建築モード</span></button>
    <select id="buildingType">
      <option value="要塞">要塞</option>
      <option value="海軍基地">海軍基地</option>
      <option value="陸軍基地">陸軍基地</option>
      <option value="空軍基地">空軍基地</option>
      <option value="国会">国会</option>
    </select>
    <input type="text" id="customName" placeholder="名前（空白で自動）">
    <button onclick="setMode('single')">🏗 建物配置</button>
    <button onclick="setMode('fortLine')">🧱 要塞 線配置</button>
    <button onclick="setMode('delete')">🗑️ 建物削除</button>
    <hr>
    <button onclick="downloadJSON()">💾 JSON保存</button>
    <input type="file" onchange="loadJSON(event)">
  </div>

  <div id="map-container">
    <iframe id="mapFrame" src="https://maps.gsi.go.jp/?hc=hic#5/36.104611/140.084556/&base=std&ls=std&disp=1&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1"></iframe>
    <canvas id="overlayCanvas"></canvas>
  </div>

  <script>
    const canvas = document.getElementById("overlayCanvas");
    const ctx = canvas.getContext("2d");
    const mapFrame = document.getElementById("mapFrame");
    const modeLabel = document.getElementById("modeLabel");

    let buildings = [];
    let mode = "single";
    let isMapMode = false;
    let linePoints = [];

    function resizeCanvas() {
      canvas.width = canvas.parentElement.clientWidth;
      canvas.height = canvas.parentElement.clientHeight;
      draw();
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function toggleMapMode() {
      isMapMode = !isMapMode;
      mapFrame.style.pointerEvents = isMapMode ? "auto" : "none";
      canvas.style.pointerEvents = isMapMode ? "none" : "auto";
      modeLabel.textContent = isMapMode ? "マップ移動モード" : "建築モード";
    }

    function setMode(newMode) {
      mode = newMode;
      if (mode !== "fortLine") linePoints = [];
    }

    canvas.addEventListener("click", (e) => {
      if (isMapMode) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (mode === "single") {
        const type = document.getElementById("buildingType").value;
        const name = document.getElementById("customName").value || type;
        buildings.push({ x, y, type, name });
      }

      if (mode === "fortLine") {
        linePoints.push({ x, y });
        if (linePoints.length >= 2) {
          const p1 = linePoints[linePoints.length - 2];
          const p2 = linePoints[linePoints.length - 1];
          const name = document.getElementById("customName").value || "要塞線";
          buildings.push({ type: "要塞線", name, x1: p1.x, y1: p1.y, x2: p2.x, y2: p2.y });
        }
      }

      if (mode === "delete") {
        buildings = buildings.filter(b => {
          const bx = b.x ?? ((b.x1 + b.x2) / 2);
          const by = b.y ?? ((b.y1 + b.y2) / 2);
          return Math.hypot(bx - x, by - y) > 10;
        });
      }

      draw();
    });

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (const b of buildings) {
        if (b.type === "要塞線") {
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(b.x1, b.y1);
          ctx.lineTo(b.x2, b.y2);
          ctx.stroke();
          ctx.fillStyle = "black";
          ctx.fillText(b.name, (b.x1 + b.x2) / 2 + 5, (b.y1 + b.y2) / 2);
        } else {
          ctx.fillStyle = "blue";
          ctx.fillRect(b.x - 5, b.y - 5, 10, 10);
          ctx.fillStyle = "black";
          ctx.fillText(b.name, b.x + 7, b.y);
        }
      }
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify({ buildings }, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "map_data.json";
      link.click();
    }

    function loadJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = JSON.parse(e.target.result);
        buildings = data.buildings || [];
        draw();
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
