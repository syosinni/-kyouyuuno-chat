<html lang="ja" data-bs-theme="auto">
<head>
<meta charset="utf-8" />

<meta name="referrer" content="origin">
<meta name="viewport" id="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,maximum-scale=1">

<title>ネットで共有ノートチャット  ＃休日暇だわ（さら） | chaat</title>
	
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@kukusama" />
<meta property="og:url" content="https://c.kuku.lu/cwp573h6" />
<meta property="og:title" content="ネットで共有ノートチャット  ＃休日暇だわ（さら） | chaat" />
<meta property="og:description" content="登録不要、すぐに作れてずっと使える匿名チャットルーム" />
<meta property="og:image" content="https://c.kuku.lu/apple-touch-icon.png">
	
<link rel="manifest" href="/room.manifest.php?room_hash=cwp573h6">
<link rel="apple-touch-icon" href="apple-touch-icon.png" sizes="180x180">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
	
<script src="js/jquery.color-2.2.0.min.js" type="text/javascript"></script>
	
<script>
	var cookie = {};
cookie.get = function(name) {
    var regexp = new RegExp('; ' + name + '=(.*?);');
    var match  = ('; ' + document.cookie + ';').match(regexp);
    return match ? decodeURIComponent(match[1]) : '';
}
cookie.set = function(name, value) {
    document.cookie = name + '=' + encodeURIComponent(value) + '; expires=Mon, 31-Dec-2039 23:59:59 GMT; domain=.c.kuku.lu; path=/';
}
	
function getConf(_key, _default) {
	var _tmp = localStorage.getItem(_key);
	if (_tmp == undefined) {
		return _default;
	}
	return _tmp;
}
function setConf(_key, _value) {
	if (!_value || _value == undefined) {
		localStorage.removeItem(_key);
		return;
	}
	localStorage.setItem(_key, _value);
}

	function getConfigArrayList(_key) {
		var _conf = getConf(_key, "");
		try {
			_conf = JSON.parse(_conf);
		} catch(e) {
			_conf = [];
		}
		
		return _conf;
	}
	function checkConfigArrayList(_key, _value) {
		if (getConfigArrayList(_key).indexOf(_value) != -1) {
			return true;
		}
		return false;
	}
	function addConfigArrayList(_key, _value) {
		var _conf = getConfigArrayList(_key);
		if (!_conf.indexOf(_value) != -1) {
			_conf.push(_value);
		}
		setConf(_key, JSON.stringify(_conf));
	}
	function delConfigArrayList(_key, _value) {
		var _conf = getConfigArrayList(_key);
		
		_conf = _conf.filter(function(v){
			if (v != _value) return true;
		});
		
		setConf(_key, JSON.stringify(_conf));
	}
	
function encodeHiraToKata( text )
{
	var after = "";
	var i;
	for (i=0; i<text.length; i++) {
		c = text.charCodeAt(i);
		if (c>=12353 && c<=12435) {
		c = c + 96;
	}
	after += String.fromCharCode(c);
	}
	return (after.toLowerCase()).replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(s){return String.fromCharCode(s.charCodeAt(0)-0xFEE0)});
}
	
function strcnt(_str, _find) {
	return ( _str.match( new RegExp( escapeRegExp(_find), "g" ) ) || [] ).length ;
}
	function escapeRegExp(string) {
	    return string.replace(/[.*+\-?^${}()|[\]\\]/g, '\\$&');
	}

function sortASC(_array) {
	_array.sort(function(a,b){
	        if( a < b ) return -1;
	        if( a > b ) return 1;
	        return 0;
	});
}
function sortDESC(_array) {
	_array.sort(function(a,b){
        if( a > b ) return -1;
        if( a < b ) return 1;
        return 0;
	});
}
		
function dataURLtoFile(filename, dataurl) {
	var arr = dataurl.split(','),
	mime = arr[0].match(/:(.*?);/)[1],
	bstr = atob(arr[1]), 
	n = bstr.length, 
	u8arr = new Uint8Array(n);
	while(n--){
		u8arr[n] = bstr.charCodeAt(n);
	}
	if (mime) {
		var _ex = mime.split("/");
		if (_ex.length >= 2) {
			filename = filename+"."+_ex[1];
		}
	}
	return new File([u8arr], filename, {type:mime});
}

function clipcopyjs(string){
	var tmp = document.createElement("div");
	// 選択用のタグ生成
	var pre = document.createElement('pre');
	pre.style.webkitUserSelect = 'auto';
	pre.style.userSelect = 'auto';

	tmp.appendChild(pre).textContent = string;
	var s = tmp.style;
	s.position = 'fixed';
	s.right = '200%';
	document.body.appendChild(tmp);
	document.getSelection().selectAllChildren(tmp);
	var result = document.execCommand("copy");
	document.body.removeChild(tmp);
	return result;
}

function autojson(_data) {
	if (isObject(_data)) {
		return JSON.stringify(_data);
	} else {
		return JSON.parse(_data);
	}
}

function safestr(_str) {
	if (!_str) return "";
	
	_str = _str.split("<").join("&lt;");
	_str = _str.split(">").join("&gt;");
	_str = _str.split('"').join("&quot;");
	_str = _str.split("'").join("&#039;");
	
	return _str;
}

function isObject(value) {
  return value !== null && typeof value === 'object'
}

function getRandomInt(min, max) {
	min = Math.ceil(min);
	max = Math.floor(max);
	return Math.floor(Math.random() * (max - min) + min);
}

function jsonFetch(_url, _data, _callback_success) {
    $.ajax({
        url: _url,
        type: 'POST',
        data: _data,
        dataType: "json"
    }).done(function(data){
    	if (data["result"] == "OK") {
    		_callback_success(data);
		    return;
    	} else if (data["msg"]) {
    		showToast(data["msg"]);
    	} else {
    		showToast("システムエラーが発生しました。再度お試しください。");
    	}
    }).fail(function(){
    	showToast("ネットワークエラーが発生しました。再度お試しください。");
    });
}

const observer_imgloader = new IntersectionObserver(
	function(events){
		events.forEach( (e) => {
			if (!e.isIntersecting) return;
			if ($(e.target).hasClass("imgloader-view")) return;
			
			$(e.target).attr("src", $(e.target).attr("data-src")).addClass("imgloader-view");
		});
	}, 
	{
		threshold: [0,1]
	}
);
function updateImgLoader() {
	$(".imgloader").each(function(i, e){
		if ($(e).hasClass("imgloader-init")) return;
		observer_imgloader.observe($(e).get(0));
	});
}
$(function(){
	updateImgLoader();
});

/*!
 * Color mode toggler for Bootstrap's docs (https://getbootstrap.com/)
 * Copyright 2011-2024 The Bootstrap Authors
 * Licensed under the Creative Commons Attribution 3.0 Unported License.
 */

(() => {
  'use strict'

  const getStoredTheme = () => localStorage.getItem('theme')
  const setStoredTheme = theme => localStorage.setItem('theme', theme)

  const getPreferredTheme = () => {
    const storedTheme = getStoredTheme()
    if (storedTheme) {
      return storedTheme
    }

    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  const setTheme = theme => {
    if (theme === 'auto') {
      document.documentElement.setAttribute('data-bs-theme', (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'))
    } else {
      document.documentElement.setAttribute('data-bs-theme', theme)
    }
  }

  setTheme(getPreferredTheme())

  const showActiveTheme = (theme, focus = false) => {
    const themeSwitcher = document.querySelector('#bd-theme')

    if (!themeSwitcher) {
      return
    }

    const themeSwitcherText = document.querySelector('#bd-theme-text')
    const activeThemeIcon = document.querySelector('.theme-icon-active use')
    const btnToActive = document.querySelector(`[data-bs-theme-value="${theme}"]`)
    const svgOfActiveBtn = btnToActive.querySelector('svg use').getAttribute('href')

    document.querySelectorAll('[data-bs-theme-value]').forEach(element => {
      element.classList.remove('active')
      element.setAttribute('aria-pressed', 'false')
    })

    btnToActive.classList.add('active')
    btnToActive.setAttribute('aria-pressed', 'true')
    activeThemeIcon.setAttribute('href', svgOfActiveBtn)
    const themeSwitcherLabel = `${themeSwitcherText.textContent} (${btnToActive.dataset.bsThemeValue})`
    themeSwitcher.setAttribute('aria-label', themeSwitcherLabel)

    if (focus) {
      themeSwitcher.focus()
    }
  }

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const storedTheme = getStoredTheme()
    if (storedTheme !== 'light' && storedTheme !== 'dark') {
      setTheme(getPreferredTheme())
    }
  })

  window.addEventListener('DOMContentLoaded', () => {
    showActiveTheme(getPreferredTheme())

    document.querySelectorAll('[data-bs-theme-value]')
      .forEach(toggle => {
        toggle.addEventListener('click', () => {
          const theme = toggle.getAttribute('data-bs-theme-value')
          setStoredTheme(theme)
          setTheme(theme)
          showActiveTheme(theme, true)
        })
      })
  })
})()</script>

<script src="js/Autolinker.min.js" type="text/javascript"></script>
<script src="js/marked.min.js" type="text/javascript"></script>
<script src="js/DOMPurify/purify.min.js" type="text/javascript"></script>

<script src="webpush.js.php" type="text/javascript"></script>
	
<script src="https://d.kuku.lu/filenow_upload-s3.js.php" type="text/javascript"></script>

<script src="js/peerjs-1.5.1.min.js" type="text/javascript"></script>
<script src="vcam-rtcpeer2.js.php" type="text/javascript"></script>
	
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js" integrity="sha512-xi/RZRIF/S0hJ+yJJYuZ5yk6/8pCiRlEXZzoguSMl+vk2i3m6UjUO/WcZ11blRL/O+rnj94JRGwt/CHbc9+6EA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<style>
body {
	overscroll-behavior-y: none;
	margin:0px;
	padding:0px;
	background-color:rgb(250,250,250);
}
*, *:before, *:after {
	box-sizing: border-box;
}

::-webkit-scrollbar{
	width: 10px;
}
::-webkit-scrollbar-track{
	background: #fff;
	border-left: solid 1px #ececec;
}
::-webkit-scrollbar-thumb{
	background: #ccc;
	border-radius: 10px;
	box-shadow: inset 0 0 0 2px #fff;
}
	
.master_body {
	background-color: #eff3f4;
}
.master_inner {
	width:100%;
	height:100%;
	background-color: white;
}

.footer_inner {
	max-width:1210px;margin:auto;padding-top:10px;padding-bottom:0px;
}
	.footer_inner > div {
		display:flex;flex-direction:column;justify-content:space-between;
		border:1px solid #eff3f4;border-radius:8px 8px 0px 0px;padding:5px;
		box-shadow: 0px 0px 1px 1px rgb(0 0 0 / 10%);
		background:rgb(250,250,250);
		color: #333333;
	}

	@media (max-width: 1210px) {
		.footer_inner > div {
			border-left: 0px;
			border-right: 0px;
			border-bottom: 0px;
			border-radius:0px;
		}
	}

.flex-center {
	display:flex;flex-wrap:nowrap;width:100%;justify-content: center;
}
.flex-list {
	display:flex;justify-content: space-between;align-items: center;width:100%;
}
.flex-list-wrap {
	display:flex;flex-wrap:wrap;
}
.flex-leftright {
	display:flex;width:100%;justify-content: space-between;align-items: center;
}
.flex-right {
	display:flex;width:100%;justify-content: right;
}

.divlink {
	position:relative;
}
.divlink > a {
	display: block;position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index:10;
}
.divlink_hover:hover{
	background-color:rgba(128,128,128,0.03);
}
.menu-base, .menu-rightallowbox, .menu-rightclipbox{
	width:35px;min-height: 35px;
}
.menu-rightallowbox {
	width:35px;background-image:url(img/icon_rightallow_gray.png);background-repeat:no-repeat;background-size:30px 30px;background-position:right center;
}
.menu-rightclipbox {
	width:35px;background-image:url(img/icon_clip_gray.png);background-repeat:no-repeat;background-size:30px 30px;background-position:right center;
}

.tab {
	white-space: pre-wrap;
	tab-size: 8;
}

.line-1 {
	display: -webkit-box;
	overflow: hidden;
	-webkit-box-orient: vertical;
	-webkit-line-clamp: 1;
}

.line-2 {
	display: -webkit-box;
	overflow: hidden;
	-webkit-box-orient: vertical;
	-webkit-line-clamp: 2;
}

.card {
	color: #666666;
}


@media (prefers-color-scheme: dark) {
	body {
		background-color: #000000;
	}
	.footer_inner > div {
		background:#333333;
		color: white;
		border:0;
	}
}

.master_header{
	position: relative;z-index: 20;border-bottom:1px solid #eff3f4;
	box-shadow: 1px 1px 1px rgb(0 0 0 / 6%);
}
	
.icon-toggle-on {
	filter: invert(15%) sepia(95%) saturate(6932%) hue-rotate(358deg) brightness(95%) contrast(112%);
}

.iconbutton:hover {
	opacity: 0.9;
}
.iconbutton:active {
	opacity: 0.8;
}

.icon-upload, .icon-capture, .icon-videocapture, .icon-aichat, .icon-draw, .icon-live, .icon-detail, .icon-send, .icon-emotion, .icon-qrcode, .icon-bell, .icon-pinned, .icon-search, .icon-config {
	background-repeat:no-repeat;
	background-size:100% 100%;
	background-position:center center;
	width: 30px;
	height: 30px;
	margin: 5px;
}
	.icon-upload {
		background-image: url(img/icon_upload.png?v1);
		width: 25px;height: 25px;
	}
	.icon-capture {
		background-image: url(img/icon_trim.png);
		width: 25px;height: 25px;
	}
	.icon-videocapture {
		background-image: url(img/icon_trimvideo.png?v1);
		width: 25px;height: 25px;
	}
	.icon-aichat {
		background-image: url(img/icon_ai.png);
		width: 25px;height: 25px;
	}
	.icon-draw {
		background-image: url(img/icon_draw.png);
		width: 25px;height: 25px;
	}
	.icon-live {
		background-image: url(img/icon_telp.png);
		width: 25px;height: 25px;
	}
	.icon-detail {
		background-image: url(img/icon_detail.png);
		width: 25px;height: 25px;
	}
	.icon-send {
		background-image: url(img/icon_send.png);
		width: 25px;height: 25px;
	}
	.icon-emotion {
		background-image: url(img/icon_emotion.png);
		width: 25px;height: 25px;
	}
	.icon-qrcode {
		background-image: url(img/icon_qrcode.png);
	}
	.icon-bell {
		background-image: url(img/icon_bell.png);
	}
	.icon-pinned {
		background-image: url(img/icon_pin.png);
	}
	.icon-search {
		background-image: url(img/icon_search.png);
	}
	.icon-config {
		background-image: url(img/icon_config.png);
	}
	
	.chatinput_left_full, .header_right_full {
		display: block;
	}
	.chatinput_left_mini, .header_right_mini {
		display: none;
	}
	@media (max-width: 600px) {
		.chatinput_left_full, .header_right_full {
			display: none;
		}
		.chatinput_left_mini, .header_right_mini {
			display: block;
		}
	}
	
	.breaktext {
	    line-break: anywhere;
	    word-break: break-all;
	    word-wrap: break-word;
	    overflow-wrap:anywhere;
	}
	
	.chatitem {
		width:fit-content;
		border:1px solid #eff3f4;
		border-radius:8px;
		margin-bottom:5px;
		margin-top:5px;
		margin-left:0px;
		margin-right:20px;
		font-size:17px;
	    line-break: anywhere;
	    word-break: break-all;
	    word-wrap: break-word;
	    overflow-wrap:anywhere;
	    position:relative;
	    background:white;
	    box-shadow: 1px 1px 1px rgb(0 0 0 / 6%);
	    color: #333333;
	    align-self: flex-start;
	}
	
		.chatitem.me {
			align-self: flex-end;
		}
	
			.chatitem.me {
				margin-left:20px;
				margin-right:0px;
			}
		
		.chatitem .bg {
			padding:7px;
			border-radius:8px;
		}
	
		.chatitem .menu {
			position:absolute;
			right:-20px;
			top:0px;
			background-image: url(img/icon_dot.png);
			background-repeat: no-repeat;
			background-size: 20px 20px;
			width: 20px;
			height: 20px;
		}
		
			.chatitem.me .menu {
				right:auto;
				left:-20px;
			}
	
		.chatitem .head {
			display: flex;
			justify-content: flex-start;
			flex-wrap: wrap;
			align-items: center;
		}
		
		.chatitem .name {
			font-size:14px;
			color: black;
			margin-right: 15px;
			font-weight:bold;
		}
		
		.chatitem .msg {
			margin-top:5px;
			white-space: break-spaces;
		}
		
			.chatitem .tab {
				white-space: break-spaces;
				max-height: 500px;
				overflow: hidden;
			}
			
			.chatitem .exloader {
				display:none;
			}
			
			.chatitem .exbutton {
				position: absolute;
				display: block;
				content: "すべて表示";
				bottom: 0;
				left: 0;
				width: 100%;
				height: 75px;
				background: linear-gradient( rgba(238, 238, 238,0) 0%, rgba(238, 238, 238,0.8) 50%, #eeeeee 100%);
				cursor: pointer;
			}
		
			.chatitem .msg p {
				margin: 0;
			}
			
			.chatitem .bq {
				border-left:2px solid rgb(199,204,209);
				padding-left:15px;
				margin-top:3px;
				margin-bottom:3px;
			}
				
			.chatitem div.code {
				border:1px solid rgb(227,229,232);
				border-radius:6px;
				background:rgb(242,243,245);
				padding:5px;
				margin:5px;
			}

			.chatitem span.code {
				background:rgb(242,243,245);
				border-radius:3px;
				padding:3px;
			}
			
			.chatitem .spoiler {
				background:rgb(242,243,245);
				color: rgb(242,243,245);
				border-radius:3px;
				padding:3px;
			}
		
		.chatitem .reply {
			font-size:14px;
			background-color:rgba(128,128,128,0.1);
			border-radius:6px;
			padding: 6px;
			margin-top:5px;
			margin-bottom:5px;
		}
		
		.chatitem .reply .reply-head {
			color: gray;
		}
		
		.chatitem .date {
			font-size:11px;
			color: #a3a3a3;
		}
		
		.wait-only, .hidden-only {
			display: none;
		}
		
		.chatprogressitem {
			color: green;
			padding:10px;
			font-size:18px;
		}
		
		.appendview {
		}
		
		.appenditem {
			margin: 10px;
			position:relative;
		}
			.appenditem .img {
				width: 160px;
				height: 140px;
				//float: right;
				object-fit: contain;
			}
			
			.appenditem .close {
				position:absolute;
				right: 5px;
				top: 5px;
				z-index: 20;
			}
				.appenditem .close img {
					width: 30px;
					height: 30px;
				}
				
	.area_chatlog_fixed {
		background: rgba(128,128,128,0.06);
		min-height: 90px;
	}
		
		.area_chatlog_fixed .chatitem {
			background:rgba(0,0,0,0) !important;
			border:0px;
		}
		
		.area_chatlog_fixed .chatitem .bg {
			background:rgba(0,0,0,0) !important;
			padding:0;
		}
	
	.area_chatlog_live {
		background: rgba(0,0,0,1);
	}
	
  		.vcam_master .info {
  			position:absolute;top:0px;margin:auto;left:0;right:0;background-color:rgba(255,255,255,0.85);border-radius:0px 0px 5px 5px;width:80%;max-width:300px;text-align:center;z-index:10;opacity:0.8;color:black;
  		}
  		.vcam_master .control {
  			position:absolute;bottom:0px;margin:auto;right:0px;width:100%;text-align:right;z-index:20;opacity:0.8;background-image:url(img/bg_grad_bottom.png?v1);background-repeat:repeat-x;background-size:100% 100%;
  		}
  		.vcam_master .unmute {
  			display:none;position:absolute;top:0;left:0;right:0;bottom:0;cursor:pointer;z-index:21;
  		}
  			.vcam_master .unmute > div {
  				position:absolute;bottom:50px;margin:auto;left:0;right:0;background-color:rgba(255,255,255,0.7);border-radius:5px;width:80%;max-width:300px;text-align:center;z-index:21;
  			}
  			
  		.vcam_master .audioonly {
  			position:absolute;top:0;left:0;right:0;bottom:0;cursor:pointer;z-index:10;
  		}
  			.vcam_master .audioonly > div {
  				position:absolute;top:30px;margin:auto;left:0;right:0;width:60%;min-width:60px;max-width:150px;text-align:center;z-index:11;color:rgba(128,128,128,1);font-weight:bold;
  			}
  			
  		.vcam_master .vcam_icon {
  			margin:4px;
  			width: 30px;
  			cursor:pointer;
  		}
	
	.cardloader {
		width: 300px;
		max-width: 45vw;
		height: 150px;
		max-height: 50vh;
		margin: 5px;
		margin-right: 0px;
		overflow:hidden;
		border-radius:10px;
		border:1px solid rgba(128,128,128,0.2);
		background-color: #eff3f4;
		color: #333333;
		position:relative;
	}
	
		.cardloader-emotion {
			border:0px;
			background-color: transparent;
		}
	
	.cardloader-container {
		width: 100%;
		height: 100%;
		overflow:hidden;
		text-align:center;
		position:relative;
	}
	
	.cardloader-container .flex-center {
		height: 100%;
	}
	
		.cardloader-container .image {
			width: 100%;
			height: 100%;
			object-fit: contain;
		}
		
		.cardloader-container .underarea {
			padding: 5px;
			background: linear-gradient( rgba(239, 243, 244,0) 0%, rgba(239, 243, 244,0.8) 40%, #eff3f4 100%);
			width: 100%;
			position: absolute;
			bottom: 0;
		}
		.cardloader-container .title {
			font-weight:bold;
			font-size:15px;
			
			display: -webkit-box;
			overflow: hidden;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 1;
		}
		.cardloader-container .description {
			font-size:14px;
			
			display: -webkit-box;
			overflow: hidden;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 1;
		}
		
		@media (max-width: 600px) {
			.cardloader {
			}
		}
		
		.appenditem .cardloader-container {
		}
		.appenditem .cardloader-container .image {
			max-height: 140px;
		}
		
		.cardloader .spinner-border {
			position: absolute;
			margin: auto;
			left:0;right:0;top:0;bottom:0;
		}

	@media (prefers-color-scheme: dark) {
		.master_inner {
			background-color: #000000;
		}
		.iconautolight, .iconautolight-button {
			filter: brightness(300%);
		}
		.iconautolight-button:hover {
			filter: brightness(100%);
		}
		.icon-toggle-on {
			filter: invert(15%) sepia(95%) saturate(6932%) hue-rotate(358deg) contrast(112%) brightness(300%);
		}
		
		.area_chatlog_fixed .chatitem .bg {
			color: white;
		}
		.area_chatlog_fixed .chatitem .name {
			color: white;
		}
		.view_username {
			color: white;
		}
	}
	
</style>
<script>
	var sound = {};
	var table_sound = ["newmessage.mp3", "newuser.mp3", "leave.mp3", "enter.mp3"];
	for (var i in table_sound) {
		sound[table_sound[i]] = new Howl({src: ['img/'+table_sound[i]], volume: 0.7});
	}
	function playSound(_name) {
		sound[_name].play();
	}
</script>
</head>
<body style="padding:0px;margin:0px;">

<div class="position-relative">
	<div class="toast-container position-absolute top-0 end-0 p-3">
	
		<div id="area_toast" class="toast" role="alert">
			<div class="d-flex">
				<div class="toast-body">
					<div class="msg"></div>
				</div>
				<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		</div>
			
		<div id="area_toast_upload" class="toast" data-autohide="false" role="alert">
			<div class="d-flex">
				<div class="toast-body">
					<div class="msg"></div>
					<div>
						<div style="display:flex;justify-content:center;align-items:center;margin-top:10px;">
							<div style="width:100%;background-color:rgba(128,128,128,0.1);border-radius:5px;">
								<div class="uploadprogress" style="width:0%;height:10px;background-color:#FFCA43;border-radius:5px;"></div>
							</div>
						</div>
					</div>
				    <div class="mt-2 pt-2 border-top">
				      <button id="button_uploadcancel" type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="toast">キャンセル</button>
				    </div>
				</div>
				<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
			</div>
		</div>
			
	</div>
</div>
		
<div class="area_fileupload_drop" style="display:none;width:100%;height:100%;position:absolute;z-index:10000;">
	<div class="area_fileupload_drop_here" style="display:flex;justify-content:center;align-items:center;height:100%;border:2px dashed rgba(128,128,128,0.5);background-color:rgba(255,255,255,0.6);">
		<div style="color:gray;font-size:15px;font-weight:bold;">ドロップしてアップロード</div>
	</div>
	<input id="file_upload" type="file" name="file[]" style="display:none;" multiple="multiple">
</div>

<div class="master_body area_fileupload_fixed" style="display:flex;justify-content: center;">

	<div class="master_inner" style="">
		
		<div id="area_header" class="master_header" style="">
			
			<div>
				<div style="padding:0px;">
					<div class="flex-leftright">
						<div class="flex-list" style="justify-content: flex-start;">
							<div style="padding:5px;">
								<a href="javascript:openMenu();" class="btn btn-outline-light iconautolight-button"><img src="img/icon_menus.gif?v5" width="30" height="30"></a>
							</div>
							<div class="room_title_header divlink" style="padding:3px;margin-left:10px;">
								<a href="javascript:openInfo();"></a>
								<div class="room_title" style="font-size:18px;font-weight:bold;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;">ネットで共有ノートチャット  ＃休日暇だわ（さら）</div>
							</div>
						</div>
						<div class="flex-right room_icon_header" style="width: fit-content;">
							<div class="icon-qrcode iconbutton iconautolight divlink header_right_full" style="padding:5px;width:35px;height:35px;">
								<a href="javascript:openInfo();"></a>
							</div>
							<div class="icon-bell iconbutton iconautolight divlink" style="padding:5px;width:35px;height:35px;">
								<a href="javascript:openPush();"></a>
							</div>
							<div class="icon-pinned iconbutton iconautolight divlink" style="padding:5px;width:35px;height:35px;">
								<a href="javascript:openPinned();"></a>
							</div>
							<div class="icon-search iconbutton iconautolight divlink" style="padding:5px;width:35px;height:35px;">
								<a href="javascript:openSearch();"></a>
							</div>
							<div class="icon-config iconbutton iconautolight divlink" style="padding:5px;width:35px;height:35px;">
								<a href="javascript:openRoomConfig();"></a>
							</div>
						</div>
					</div>
				</div>
				
				<div class="area_search_box" style="display:none;padding:5px;border-top:1px solid #eff3f4;">
					<div class="flex-leftright">
						<div>
							
						</div>
						<div class="flex-right">
							<div class="input-group" style="max-width:300px;">
								<input type="text" class="form-control" id="search_q" value="" maxlength="32" placeholder="検索ワード">
								<input onclick="openSearch();" type="button" class="btn btn-outline-secondary" value="閉じる">
							</div>
						</div>
					</div>
				</div>
							
				<div class="area_chatlog_fixed" style="display:none;padding:5px;border-top:1px solid #eff3f4;">
					<div style="position:relative;">
						<div style="position:absolute;top:5px;right:10px;">
							<div class="btn-group-vertical iconautolight" role="group">
								<a href="javascript:void(0);" onclick="closeFixedMessage(false, true);" class="btn btn-sm btn-outline-secondary"><img src="img/icon_close.png?vb" width="25"></a>
								<a href="javascript:void(0);" onclick="toggleFixedMessage();" class="btn-expand btn btn-sm btn-outline-secondary"><img src="img/icon_down.png" width="25"></a>
							</div>
						</div>
						<div id="area_chatlog_fixed_master" class="inner" style="max-height:13vh;overflow-y:hidden;">
							<div class="flex-list" style="justify-content: flex-start;align-items: flex-start;">
								<div class="iconautolight" style="width:40px;">
									<img src="img/icon_fixed.png" width="30">
								</div>
								<div class="data" style="margin-right:60px;">
									
								</div>
							</div>
						</div>
					</div>
				</div>
				<script>
					function toggleFixedMessage() {
						if ($(".area_chatlog_fixed .inner").css("overflow-y") == "hidden") {
							$(".area_chatlog_fixed .inner").css({"max-height": "60vh", "overflow-y": "scroll"});
							$(".area_chatlog_fixed .btn-expand").html('<img src="img/icon_up.png" width="25">');
						} else {
							$(".area_chatlog_fixed .inner").css({"max-height": "13vh", "overflow-y": "hidden"});
							$(".area_chatlog_fixed .btn-expand").html('<img src="img/icon_down.png" width="25">');
						}
						windowResize();
					}
					function closeFixedMessage(_force, _manual) {
						if (!_force && $(".area_chatlog_fixed").css("display") != "block") return;
						
						$(".area_chatlog_fixed").css("display", "none");
						$(".button_restore_fixed").css("display", "block");
						windowResize();
						
						if (_manual) {
							addConfigArrayList("fixed_message_checked", "cwp573h6");
						}
					}
						
					function openFixedMessage() {
						$(".area_chatlog_fixed").css("display", "block");
						$(".button_restore_fixed").css("display", "none");
						windowResize();
						
						delConfigArrayList("fixed_message_checked", "cwp573h6");
					}
				</script>
				
				<div class="area_chatlog_live" style="display:none;padding:5px;border-top:1px solid #eff3f4;">
					<div style="position:relative;">
						<div style="position:absolute;top:5px;right:10px;z-index:30;">
							<div class="btn-group-vertical" role="group" style="filter: brightness(300%);">
								<a href="javascript:void(0);" onclick="closeLive();" class="btn btn-sm btn-outline-secondary"><img src="img/icon_close.png?vb" width="25"></a>
								<a href="javascript:void(0);" onclick="toggleLive();" class="btn-expand btn btn-sm btn-outline-secondary"><img src="img/icon_down.png" width="25"></a>
								<a href="javascript:void(0);" onclick="toggleLiveAllMute();" class="btn-allmute btn btn-sm btn-outline-secondary"><img src="img/icon_unmute.png" width="25"></a>
							</div>
						</div>
						<div id="area_chatlog_live_master" class="inner" style="overflow-y:hidden;">
							<div class="resizable" style="min-height:140px;max-height:80vh;height: 140px;resize:vertical;overflow-y:hidden;overflow-x:auto;">
								<div class="flex-list lives" style="justify-content: center;align-items: center;min-width:fit-content;height:100%;">
									
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<script>
					function openLive() {
						$(".area_chatlog_live").css("display", "block");
						windowResize();
					}
					function toggleLive() {
						if ($(".area_chatlog_live .btn-expand").html().indexOf("down") == -1) {
							$(".area_chatlog_live .resizable").css({"height": "140px"});
							$(".area_chatlog_live .btn-expand").html('<img src="img/icon_down.png" width="25">');
						} else {
							$(".area_chatlog_live .resizable").css({"height": "45vh"});
							$(".area_chatlog_live .btn-expand").html('<img src="img/icon_up.png" width="25">');
						}
						windowResize();
					}
					var timeout_windowResizeObserver = false;
					let observer = new ResizeObserver(function(mutations) {
						clearTimeout(timeout_windowResizeObserver);
						timeout_windowResizeObserver = setTimeout(function(){
							windowResize();
						}, 50);
					});
					observer.observe(document.querySelector('.resizable'));
				</script>
				
			</div>
				
				
				
		</div>
		
		<div style="position:relative;">
			
			<div class="area_loader flex-center" style="position:absolute;left:0;right:0;margin:auto;padding:15px;opacity:0.7;">
				<div class="spinner-border text-warning" role="status">
				  <span class="visually-hidden"></span>
				</div>
			</div>
			
			<div id="area_chatlog_log_master" class="chatlog_master" style="overflow-y:scroll;width:100%;padding-left:10px;padding-right:10px;">
				
				<div style="max-width:1200px;margin:auto;">
					<div id="area_chatlog_log" class="area_chatlog" style="display:flex;flex-direction: column;">
					</div>
					
					<div class="area_chatlog_progress" style="display:none;margin-top:6px;">
						<div class="data line-1" style="background-color:rgba(239,243,244,0.8);border-radius: 8px;padding:10px;color:black;font-size:17px;">
							
						</div>
					</div>
					
				</div>
					
				<div class="scroll_magnet_bottom iconautolight" style="position:absolute;z-index:10;bottom:30px;right:30px;width:50px;height:50px;">
					<div class="inner divlink" style="border:1px solid #eff3f4;border-radius:6px;background-color:rgba(160,160,160,0.2);">
						<a href="javascript:ChatScrollLast(true);"></a>
						<div><img src="img/icon_bottom.png" width="45"></div>
					</div>
				</div>
					

			</div>
				
			<div id="area_chatlog_pinned_master" class="chatlog_master" style="display:none;overflow-y:scroll;width:100%;padding-left:10px;padding-right:10px;">
				
				<div style="max-width:1200px;margin:auto;">
					<div id="area_chatlog_pinned" class="area_chatlog" style="display:flex;flex-direction: column;"></div>
				</div>

				<div class="scroll_magnet_bottom" style="position:absolute;z-index:10;bottom:30px;right:30px;width:50px;height:50px;">
					<div class="inner divlink" style="border:1px solid #eff3f4;border-radius:6px;background-color:rgba(160,160,160,0.2);">
						<a href="javascript:ChatScrollLast(true);"></a>
						<div><img src="img/icon_bottom.png" width="45"></div>
					</div>
				</div>

			</div>
				
			<div id="area_chatlog_search_master" class="chatlog_master" style="display:none;overflow-y:scroll;width:100%;padding-left:10px;padding-right:10px;">
				
				<div style="max-width:1200px;margin:auto;">
					<div id="area_chatlog_search" class="area_chatlog" style="display:flex;flex-direction: column;"></div>
				</div>

				<div class="scroll_magnet_bottom" style="position:absolute;z-index:10;bottom:30px;right:30px;width:50px;height:50px;">
					<div class="inner divlink" style="border:1px solid #eff3f4;border-radius:6px;background-color:rgba(160,160,160,0.2);">
						<a href="javascript:ChatScrollLast(true);"></a>
						<div><img src="img/icon_bottom.png" width="45"></div>
					</div>
				</div>

			</div>
				
		</div>
			
		<div id="area_footer">
			
			<div class="footer_inner">
				<div>
					
					<div id="area_pre" style="margin:5px;margin-left:10px;margin-right:10px;">
						<div class="flex-leftright">
							<div style="font-size:13px;">
								<a data-bs-toggle="offcanvas" href="#dialog_profile" class="btn btn-sm btn-outline-secondary view_color" style="border-color:#a5dee5;">You: <span class="view_username">もやし猫@管理者だよ#dbec</span></a>
							</div>
							<div class="flex-right" style="max-width:fit-content;">
								<div class="button_restore_live iconautolight" style="display:none;"><a href="javascript:void(0);" onclick="openLive();"><img src="img/icon_live.png" width="30"></a></div>
								<div class="button_restore_fixed iconautolight" style="display:none;"><a href="javascript:void(0);" onclick="openFixedMessage();"><img src="img/icon_fixed.png" width="30"></a></div>
							</div>
						</div>
					</div>
						
					<div style="margin:5px;margin-left:10px;margin-right:10px;">
						<div style="border:1px solid gray;border-radius:6px;overflow:hidden;min-height:40px;max-height:50vh;background:white;color:#333333;">
							<div class="flex-leftright" style="align-items: stretch;">
								<div class="chatinput_left_master" style="display:flex;background:#eff3f4;">
									<div class="chatinput_left_full" style="height:100%;">
										<div class="flex-list" style="width:fit-content;height:100%;align-items:center;align-content: center;">
											<div class="icon-upload divlink iconbutton" title="ファイルのアップロード">
												<a class="button_upload" href="javascript:void(0);"></a>
											</div>
											<div class="icon-videocapture iconbutton divlink chatinput_func_videocapture" title="キャプチャ">
												<a class="button_videocapture" href="javascript:openCaptureSelecter();"></a>
											</div>
											<div class="icon-draw iconbutton divlink chatinput_func_draw" title="手書きメッセージ">
												<a class="button_draw" href="javascript:openDraw();"></a>
											</div>
											<div class="icon-live iconbutton divlink chatinput_func_live" title="通話／ライブ配信の開始">
												<a class="button_live" href="javascript:initLive();"></a>
											</div>
																					</div>
									</div>
									<div class="chatinput_left_mini" style="height:100%;">
										<div class="flex-list" style="width:fit-content;height:100%;align-items:center;align-content: center;">
											<div class="divlink" title="ファイルのアップロード">
												<a class="button_upload" href="javascript:void(0);"></a>
												<div class="icon-upload iconbutton" style="width:30px;height:30px;margin:5px;"></div>
											</div>
											<div class="divlink" title="その他の機能を開く">
												<a class="button_detail" href="javascript:toggleChatinputFuncDetail();"></a>
												<div class="icon-detail iconbutton" style="width:30px;height:30px;margin:5px;"></div>
											</div>
										</div>
									</div>
								</div>
								<div style="position:relative;width:100%;overflow: hidden;">
									<div class="chatinput_mode" style="display:none;padding-bottom:6px;">
										<div class="flex-leftright" style="padding:6px;background-color:rgba(128,128,128,0.2);">
											<div class="modeview"></div>
											<div><a href="javascript:resetChatinputMode();" class="btn btn-sm btn-outline-secondary">解除</a></div>
										</div>
									</div>
									<div class="chatinput_append" style="display:none;padding-bottom:6px;">
										<div style="width:100%;overflow-x:scroll;">
											<div class="flex-list appendview" style="flex-wrap:nowrap;justify-content: flex-start;">
											</div>
										</div>
									</div>
									<div style="position:relative;">
										<div class="icon-emotion divlink iconbutton" style="position:absolute;right:40px;top:0;bottom:0;margin:auto;"><a href="javascript:openEmotion();"></a></div>
										<div class="icon-send divlink iconbutton" style="position:absolute;right:10px;top:0;bottom:0;margin:auto;"><a href="javascript:SendChat();"></a></div>
										
										<div contentEditable="true" id="chatinput" class="tab" style="padding:7px;overflow-y:scroll;font-size:16px;padding-right:60px;max-height:25vh;"><div class="placehold" style="color:gray;user-select:none;pointer-events: none;">メッセージを入力...</div></div>
									</div>
								</div>
							</div>
						</div>
						
					</div>
					
					<style>
						.emotion_preview {
							margin: 5px;
						}
						.emotion_preview img {
							width: 120px;
							max-width: 20vw;
							height: 120px;
							max-height: 20vw;
							object-fit: contain;
						}
					</style>
					<script>
						var emotion_cache = false;
						function fetchEmotion(_forceopen) {
							jsonFetch(
								"room.php", 
								"&hash=cwp573h6&action=getEmotion&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
								function(data){
									emotion_cache = data;
									redrawEmotion();
									
									openEmotion(_forceopen);
								}
							);
						}
							function redrawEmotion() {
								var _search = encodeHiraToKata($("#search_emotion").val());
								
								var _buffer = "";
								for (var i in emotion_cache["emotions"]) {
									var _emotion = emotion_cache["emotions"][i];
									
									if (_search) {
										if (encodeHiraToKata(_emotion["emourl"]).indexOf(_search) == -1 && encodeHiraToKata(_emotion["name"]).indexOf(_search) == -1) continue;
									}
									
									var _js = "sendEmotion('"+_emotion["emourl"]+"', '"+_emotion["emoid"]+"')";
									var _js_error = "$('#emotion_item_"+_emotion["emoid"]+"').remove();";
									
									_buffer += '<div id="emotion_item_'+_emotion["emoid"]+'" class="emotion_preview divlink">';
									_buffer += '	<a href="javascript:'+_js+'"></a>';
									_buffer += '	<div><img class="imgloader" data-src="'+safestr(_emotion["emourl_proxy"])+'" onerror="'+_js_error+'"></div>';
									_buffer += '</div>';
								}
								
								$(".list_emotion").html(_buffer);
								
								updateImgLoader();
							}
						function sendEmotion(_emourl, _emoid) {
							var _senddata = {
								"type": "chat",
								"msg": "",
								"append": [{"type": "emotion", "url": _emourl}],
								"emotion": _emoid
							};
							SendChatNow(_senddata);
							
							closeEmotion();
						}
						function openEmotion(_forceopen) {
							if (!_forceopen && $("#area_emotion").css("display") == "block") {
								closeEmotion();
								return;
							}
							
							if (emotion_cache) {
								$("#area_emotion").css("display", "block");
								windowResize();
								return;
							}
							
							fetchEmotion();
						}
						function closeEmotion() {
							$("#area_emotion").css("display", "none");
							windowResize();
						}
						
						function openAddEmotion() {
							$("#dialog_addemotion").modal("show");
						}
						
						$(function(){
							$("#search_emotion").bind("input", function(e){
								redrawEmotion();
							});
						});
					</script>
					<div id="area_emotion" style="display:none;margin:5px;margin-left:10px;margin-right:10px;">
						<div class="flex-leftright" style="margin-bottom:5px;">
							<div>
								<div class="input-group" style="max-width:300px;">
									<input type="text" class="form-control form-control-sm" id="search_emotion" value="" maxlength="32" placeholder="検索...">
								</div>
							</div>
							<div class="flex-right">
								<div><a href="javascript:openAddEmotion();" class="btn btn-sm btn-outline-primary">追加</a></div>
								<div style="margin-left:5px;"><a href="javascript:openDelEmotion();" class="btn btn-sm btn-outline-secondary">削除</a></div>
							</div>
						</div>
						<div class="list_emotion flex-list" style="align-items: flex-start;justify-content: flex-start;overflow-y:scroll;flex-wrap:wrap;max-height:30vh;height:400px;">
						</div>
					</div>
						
					<div id="area_status" style="font-size:13px;margin:5px;margin-left:10px;margin-right:10px;">...</div>
						
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	var chatinput_mode = false;
	function resetChatinputMode() {
		chatinput_mode = false;
		
		$(".chatinput_mode").css("display", "none");
		
		$(".chatinput_append").css("display", "none");
		$(".chatinput_append .appendview").html("");
		
		windowResize();
	}
</script>

<div id="dialog_addemotion" class="modal modal-xl fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">エモーションの追加</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="contents" style="padding:25px;">
    		
		    <div>
				<div class="input-group mb-3">
					<div class="form-floating">
					  <input type="text" class="form-control" id="emotionloader_url" value="" maxlength="512" placeholder="URL">
					  <label for="emotionloader_url">画像または画像を含むウェブページのURL</label>
					</div>
				  <button class="btn btn-outline-primary" onclick="fetchEmotionLoader();" type="button">URLから読込</button>
				</div>
		    </div>
		    	
		    <div>
		    	<a class="btn btn-outline-primary button_upload_emotion" href="javascript:void(0);"><img src="img/icon_file.png" width="24"> ファイルから読込</a>
		    </div>
		    <input id="file_upload_emotion" type="file" name="file[]" style="display:none;" multiple="multiple">
			<script>
				$(function(){
					$("#file_upload_emotion").change(function(){
						uploadFile(
							document.getElementById('file_upload_emotion').files, 
							function(err, fdata){
								$("#file_upload_emotion").val("");
								if (err) {
									showToast(''+err);
									return;
								}
								
								var _emoid = fdata.hash;
								getCardLoader(fdata.url, false, function(data){
									if (!data) {
										showToast("エモーションのアップロードに失敗しました。再度お試しください。");
										return;
									}
									
									if (!data.image_original || data.image_original.indexOf("icon_file.png") != -1) {
										showToast("エモーションは5MB以下の画像フォーマットを使用してください。");
										return;
									}
									
									var _buffer = "";

									var _js = "addEmotionLoader('"+_emoid+"', '"+data.image+"', '')";
									var _addstyle = "";
									
									var _js_error = "$('#addemotion_item_"+_emoid+"').remove();";
									_buffer += '<div id="addemotion_item_'+_emoid+'" class="emotion_preview">';
									_buffer += '	<div><img src="'+data.image_original+'" onload="'+_js+'" onerror="'+_js_error+'"></div>';
									_buffer += '</div>';
								
									$("#dialog_addemotion .emotions").prepend(_buffer);
								});

							}
						);
					});
					$(".button_upload_emotion").click(function(){
						var $elm = $('#file_upload_emotion');
						if (document.createEvent) {
							$elm.show();
							var e = document.createEvent('MouseEvents');
							e.initEvent('click', true, true );
							$elm.get(0).dispatchEvent(e);
							$elm.hide();
						} else {
							$elm.show();
							$elm.trigger("click");
							$elm.hide();
						}
						return false;
					});
				});
			</script>
		    	
		    <div class="emotions flex-list" style="align-items: flex-start;justify-content: flex-start;flex-wrap:wrap;">
				
		    </div>
		    	
    		
      </div>
    </div>
  </div>
</div>
<script>
	$('#dialog_addemotion').on('hidden.bs.modal', function () {
		$("#dialog_addemotion .emotions").html("");
		fetchEmotion(true);
	})
	
	function fetchEmotionLoader() {
		var _url = $("#emotionloader_url").val();
		
		jsonFetch(
			"room.php", 
			"&hash=cwp573h6&action=fetchEmotionLoader&url="+encodeURIComponent(_url)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
			function(data){
				var _buffer = "";
				for (var i in data["emotions"]) {
					var _emotion = data["emotions"][i];
					
					var _js = "addEmotionLoader('"+_emotion["emoid"]+"', '"+_emotion["emourl"]+"', '"+_emotion["name"]+"')";
					var _addstyle = "";
					if (_emotion["added"]) {
						_js = "showToast('既に追加済みのエモーションです。')";
						_addstyle = "opacity:0.4;";
					}
					
					var _js_error = "$('#addemotion_item_"+_emotion["emoid"]+"').remove();";
					_buffer += '<div id="addemotion_item_'+_emotion["emoid"]+'" class="emotion_preview divlink" style="'+_addstyle+'">';
					_buffer += '	<a href="javascript:'+_js+'"></a>';
					_buffer += '	<div><img src="'+safestr(_emotion["emourl_proxy"])+'" onerror="'+_js_error+'"></div>';
					_buffer += '</div>';
				}
				
				$("#dialog_addemotion .emotions").html(_buffer);
			}
		);
	}
		function addEmotionLoader(_id, _url, _name) {
			jsonFetch(
				"room.php", 
				"&hash=cwp573h6&action=addEmotionLoader&url="+encodeURIComponent(_url)+"&name="+encodeURIComponent(_name)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
				function(data){
					$("#addemotion_item_"+_id).css("opacity", "0.4");
					showToast('エモーションを追加しました。');
				}
			);
		}
</script>
<div id="dialog_delemotion" class="modal modal-xl fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">エモーションの削除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="contents" style="padding:25px;">
		    	
		    <div class="emotions">
				
		    </div>
		    	
    		
      </div>
    </div>
  </div>
</div>
<script>
	$('#dialog_delemotion').on('hidden.bs.modal', function () {
		$("#dialog_delemotion .emotions").html("");
		fetchEmotion(true);
	})
		function openDelEmotion() {
			var _buffer = "";
			for (var u in emotion_cache["emotions_user"]) {
				
				if (owner && u) {
					_buffer += '<div><h6>'+safestr(u)+'</h6></div>';
				}
				_buffer += '<div class="flex-list" style="align-items: flex-start;justify-content: flex-start;flex-wrap:wrap;margin-bottom:10px;">';
				
				for (var i in emotion_cache["emotions_user"][u]) {
					var _emoid = emotion_cache["emotions_user"][u][i];
					var _emotion = emotion_cache["emotions"][_emoid];
					
					if (!_emotion["me"] && !owner) {
						continue;
					}
					if (_emotion["lock"]) {
						continue;
					}
					
					var _js = "delEmotion('"+_emotion["emoid"]+"')";
					
					_buffer += '<div id="delemotion_item_'+_emotion["emoid"]+'" class="emotion_preview divlink">';
					_buffer += '	<a href="javascript:'+_js+'"></a>';
					_buffer += '	<div><img class="imgloader" data-src="'+safestr(_emotion["emourl_proxy"])+'"></div>';
					_buffer += '</div>';
				}
				
				_buffer += '</div>';
			}
			
			$("#dialog_delemotion .emotions").html(_buffer);
			
			$("#dialog_delemotion").modal("show");
			
			updateImgLoader();
		}
		
		function delEmotion(_id) {
			jsonFetch(
				"room.php", 
				"&hash=cwp573h6&action=delEmotion&emoid="+encodeURIComponent(_id)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
				function(data){
					$("#delemotion_item_"+_id).remove();
					showToast('エモーションを削除しました。');
				}
			);
		}
</script>

<div id="dialog_info" class="modal modal-xl fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">ルームに招待</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
    
      <div class="contents" style="">
      	  
	    <div class="flex-center">
    		<div class="room_title" style="padding:20px;font-size:18px;font-weight:bold;word-wrap: break-word;word-break: break-all;">ネットで共有ノートチャット  ＃休日暇だわ（さら）</div>
    	</div>
    	  
	    <div class="flex-center">
	    	<div style="padding:20px;max-width:80vw;">
	    		<img src="https://qrcode.kuku.lu/?service=chaat&data=https%3A%2F%2Fc.kuku.lu%2Fcwp573h6" style="width:160px;">
	    	</div>
    	</div>
    		
	    <div class="flex-center">
	    	<div style="padding:20px;">
	    		<div>
					<input type="text" class="form-control" disabled value="https://c.kuku.lu/cwp573h6" style="width:250px;max-width:80vw;">
				</div>
	    		<div style="padding-top:5px;text-align:center;">
					<input onclick="copyRoomURL();" type="button" class="btn btn-secondary" value="コピー">
				</div>
	    	</div>
    	</div>
    
      </div>
    </div>
  </div>
</div>
<script>
	function openInfo() {
		$("#dialog_info").modal("show");
	}
	function copyRoomURL() {
		clipcopyjs("https://c.kuku.lu/cwp573h6");
		showToast("コピーしました。");
	}
</script>

<div id="dialog_members" class="modal modal-xl fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">参加者一覧</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
    
      <div class="contents" style="">
      	  
			
    
      </div>
    </div>
  </div>
</div>
<script>
	function openMembers() {
		jsonFetch(
			"room.php", 
			"&hash=cwp573h6&action=getMembers&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
			function(data){
				var _buffer = "";
				
				for (var i in data["members"]) {
					var _member = data["members"][i];
					
					var _banjs = "banMember('"+_member["id_hash"]+"')";
					
					_buffer += '<div class="flex-leftright" style="padding:20px;">';
					_buffer += '	<div>';
					_buffer += '		<div><b>'+safestr(_member["name"])+'</b></div>';
					if (_member["active"] == 1) {
						_buffer += '		<div style="color:red;">参加中</div>';
					} else {
						_buffer += '		<div style="color:gray;">'+_member["date"]+' に離脱</div>';
					}
					_buffer += '	</div>';
					if (_member["ban"] == 1) {
						_buffer += '	<div><a href="javascript:void(0);" class="btn btn-outline-secondary" disabled style="pointer-events:none;">BAN済み</a></div>';
					} else {
						_buffer += '	<div><a href="javascript:void('+_banjs+');" class="btn btn-danger">BAN</a></div>';
					}
					_buffer += '</div>';
				}
				
				$("#dialog_members .contents").html(_buffer);
				$("#dialog_members").modal("show");
			}
		);
	}
			function banMember(_id_hash, _force) {
				if (!_force) {
					viewDialogConfirm({
						"title": "確認", 
						"content": "このユーザーをBANしますか？ 過去の書き込みがすべて削除され、新たな書き込みがブロックされます。"
						},
						function(){
							banMember(_id_hash, true);
						},
						function(){
						});
					return
				}
				
				jsonFetch(
					"room.php", 
					"action=banUser&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&id_hash="+encodeURIComponent(_id_hash),
					function(data){
						$("#dialog_members").modal("hide");
						showToast("BANしました。");
					}
				);
			}
</script>

<div id="dialog_capture" class="modal modal-xl fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">スクリーンショットキャプチャー</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="contents" style="">
      </div>
    </div>
  </div>
</div>
<script>
	function openCaptureSelecter() {
			$("#dialog_capture .title").text("キャプチャー");
			
			var _html = "";
			_html += '<div class="contents" style="padding:25px;">';
			_html += '<div class="card"><ul class="list-group list-group-flush">';
			_html += '	 <li class="list-group-item divlink divlink_hover">';
			_html += '		<a href="javascript:void(0);" onclick="openCapture();"></a>';
			_html += '		<div class="flex-leftright">';
			_html += '			<div>静止画としてキャプチャー</div>';
			_html += '			<div>';
			_html += '			<div class="flex-right">';
			_html += '				<div></div>';
			_html += '				<div class="menu-rightallowbox divlink"></div>';
			_html += '			</div>';
			_html += '		<div>';
			_html += '   </li>';
			_html += '</ul></div>';
			_html += '<div class="card" style="margin-top:10px;"><ul class="list-group list-group-flush">';
			_html += '	 <li class="list-group-item divlink divlink_hover">';
			_html += '		<a href="javascript:void(0);" onclick="openVideoCapture();"></a>';
			_html += '		<div class="flex-leftright">';
			_html += '			<div>動画としてキャプチャー</div>';
			_html += '			<div>';
			_html += '			<div class="flex-right">';
			_html += '				<div></div>';
			_html += '				<div class="menu-rightallowbox divlink"></div>';
			_html += '			</div>';
			_html += '		<div>';
			_html += '   </li>';
			_html += '</ul></div>';
			_html += '</div>';
			$("#dialog_capture .contents").html(_html);
			
			$("#dialog_capture").modal("show");
	}
		function openCapture() {
			$("#dialog_capture .title").text("スクリーンショットキャプチャー");
			$("#dialog_capture .contents").html("<iframe src='https://s.kuku.lu/edit.php?service=embedCallback' style='width:100%;height:800px;max-height:80vh;' allow='camera; display-capture'></iframe>");
			$("#dialog_capture").modal("show");
		}
		
		function openVideoCapture() {
			$("#dialog_capture .title").text("動画キャプチャー");
			$("#dialog_capture .contents").html("<iframe src='https://v.kuku.lu/edit.php?service=embedCallback' style='width:100%;height:800px;max-height:80vh;' allow='camera; microphone; display-capture'></iframe>");
			$("#dialog_capture").modal("show");
		}
	
	function openDraw() {
		$("#dialog_capture .title").text("手書きメッセージ");
		$("#dialog_capture .contents").html("<iframe src='https://draw.kuku.lu/room/?mode_offline=1&canvasx=600&canvasy=600&url_post=embedCallback' style='width:100%;height:800px;max-height:90vh;' allow=''></iframe>");
		$("#dialog_capture").modal("show");
	}
	
	function toggleChatinputFuncDetail() {
		$(".chatinput_left_mini").css("display", "none");
		$(".chatinput_left_full").css("display", "block");
	}
	
	function initLive() {
		if (vcamLocalID) {
			endLive();
			return;
		}
		
		vcamSendInit(function(_res){
			if (_res["error"]) {
				showToast("ブラウザによりマイクとカメラデバイスの使用を拒否されました。通話やライブ機能を使用するには、許可してください。");
				return;
			}
			
			//if (_res["devices"]["audio"].length == 1 && _res["devices"]["video"].length == 1) {
			//	startLive({"deviceAudio": _res["devices"]["audio"][0]["id"], "deviceVideo": _res["devices"]["video"][0]["id"]});
			//	return;
			//}
			
			var _html = "";
			_html += "<div class='contents' style='padding:25px;'>";
			_html += "<div style='padding-bottom:15px;'><h6>通話やライブ配信に使用するマイク・カメラデバイスを選択してください。</h6></div>";
			
			//mic
			var _savedAudio = getConf("vcamAudio", "");
			_html += "<div class='form-floating mb-3' style=''><select id='vcam_devices_audio' class='form-control'>";
			
			for (var i=0; i<_res["devices"]["audio"].length; i++) {
				var _add = "";
				if (_savedAudio && _savedAudio == _res["devices"]["audio"][i]["id"]) {
					_add = " selected";
				}
				_html += "<option value='"+_res["devices"]["audio"][i]["id"]+"'"+_add+">"+_res["devices"]["audio"][i]["name"]+"</option>";
			}
			
			if (navigator.mediaDevices.getDisplayMedia) {
				var _add = "";
				if (_savedAudio && _savedAudio == "displayAudio") {
					_add = " selected";
				}
				_html += "<option value='displayAudio'"+_add+">デバイスで再生されているサウンド</option>";
			}
			
			_html += "</select><label for='vcam_devices_audio'>オーディオ（マイク）</label></div>";
			
			//video
			var _savedVideo = getConf("vcamVideo", "");
			_html += "<div class='form-floating mb-3' style=''><select id='vcam_devices_video' class='form-control'>";
			_html += "<option value=''>（カメラは使用しない）</option>";
			
			for (var i=0; i<_res["devices"]["video"].length; i++) {
				var _add = "";
				if (_savedVideo && _savedVideo == _res["devices"]["video"][i]["id"]) {
					_add = " selected";
				}
				_html += "<option value='"+_res["devices"]["video"][i]["id"]+"'"+_add+">"+_res["devices"]["video"][i]["name"]+"</option>";
			}
			
			if (navigator.mediaDevices.getDisplayMedia) {
				var _add = "";
				if (_savedVideo && _savedVideo == "displayVideo") {
					_add = " selected";
				}
				_html += "<option value='displayVideo'"+_add+">スクリーンをキャプチャする</option>";
			}
			
			_html += "</select><label for='vcam_devices_video'>ビデオ（カメラ）</label></div>";
			_html += "<div style='padding-top:15px;text-align:right;'><button onclick='startLive();' class='btn btn-primary'>開始</button></div>";
			_html += "</div>";
			
			$("#dialog_capture .title").text("デバイスの選択");
			$("#dialog_capture .contents").html(_html);
			$("#dialog_capture").modal("show");
		});
	}
		function closeLive() {
			if (vcamLocalID) {
				endLive();
			}
			
			$(".area_chatlog_live").css("display", "none");
			windowResize();
		}
	
		var vcamLocalID = "";
		var vcamLocalStatus = {"audio": true, "video": true};
		function startLive(_config) {
			if (!_config) {
				var _audio = $("#vcam_devices_audio").val();
				var _video = $("#vcam_devices_video").val();
				
				_config = {};
				if (_audio == "displayAudio") {
					_config["displayAudio"] = _audio;
				} else {
					_config["deviceAudio"] = _audio;
				}
				if (_video == "displayVideo") {
					_config["displayVideo"] = _video;
				} else {
					_config["deviceVideo"] = _video;
				}
				
				setConf("vcamAudio", $("#vcam_devices_audio").val());
				setConf("vcamVideo", $("#vcam_devices_video").val());
			}
			_config["localVideo"] = ".vcam_local";
			
			vcamLocalStatus = {"audio": true, "video": true};
			if ($("#vcam_devices_video").val() == "") {
				vcamLocalStatus["video"] = false;
			}
			vcamLocalID = "(wait)";
			
			closeFixedMessage();
			
  	  		var _html = "";
  	  		_html += "<div class='vcam_master vcam_local_master' data-sender_id='local' style='position:relative;height:100%;'>";
  	  		_html += "	<video class='vcam_local' style='height:100%;max-width:100%;min-width:280px;' playsinline></video>";
  	  		_html += "	<div class='info'>あなたです</div>";
  	  		_html += "	<div class='control'><div class='flex-leftright'><div><img class='icon_close vcam_icon' src='img/icon_close.png'></div><div><img class='icon_vmute vcam_icon' src='img/icon_video.png'><img class='icon_mute vcam_icon' src='img/icon_unmute.png'></div></div></div>";
  	  		_html += "	<div class='audioonly' style='display:none;'><div><img src='img/icon_vmute.png' width='30'><br>音声のみ</div></div>";
  	  		_html += "</div>";
			
			$("#area_chatlog_live_master .lives").append(_html);
			
			$(".vcam_local_master .icon_mute").bind("click", function(e){
				if ($(".vcam_local").get(0).srcObject.getAudioTracks()[0].enabled == true) {
					$(".vcam_local").get(0).srcObject.getAudioTracks()[0].enabled = false;
					$(".vcam_local_master .icon_mute").attr("src", "img/icon_mute.png");
					vcamLocalStatus["audio"] = false;
				} else {
					$(".vcam_local").get(0).srcObject.getAudioTracks()[0].enabled = true;
					$(".vcam_local_master .icon_mute").attr("src", "img/icon_unmute.png");
					vcamLocalStatus["audio"] = true;
				}
				time_lastvcampolling = 0;
			});
			
			if (!vcamLocalStatus["video"]) {
				$(".vcam_local_master .audioonly").css("display", "block");
			}
			$(".vcam_local_master .icon_vmute").bind("click", function(e){
				if ($(".vcam_local").get(0).srcObject.getVideoTracks()[0].enabled == true) {
					$(".vcam_local").get(0).srcObject.getVideoTracks()[0].enabled = false;
					$(".vcam_local_master .icon_vmute").attr("src", "img/icon_vmute.png");
					$(".vcam_local_master .audioonly").css("display", "block");
					vcamLocalStatus["video"] = false;
				} else {
					$(".vcam_local").get(0).srcObject.getVideoTracks()[0].enabled = true;
					$(".vcam_local_master .icon_vmute").attr("src", "img/icon_video.png");
					$(".vcam_local_master .audioonly").css("display", "none");
					vcamLocalStatus["video"] = true;
				}
				time_lastvcampolling = 0;
			});
			
			$(".vcam_local_master .icon_close").bind("click", function(e){
				endLive();
			});
					
			$(".area_chatlog_live").css("display", "block");
			windowResize();
			$("#dialog_capture").modal("hide");
			
			vcamSendStart(
				_config, 
				function(_res){
					if (_res["error"]) {
						showToast("マイクとビデオの使用開始に失敗しました。");
						vcamLocalID = "";
						return;
					}
					
					vcamLocalID = _res["sender_id"];
					
					time_lastvcampolling = 0;
					vcamPolling();
					
					windowResize();
				},
				function(){
					endLive();
				}
			);
		}
		
			function endLive() {
				vcamLocalID = "";
				vcamSendEnd();
				$(".vcam_local_master").remove();
				windowResize();
			}
				
			var time_lastvcampolling = (new Date()).getTime();
			function vcamPolling() {
				if (!vcamLocalID) return;
				if (vcamLocalID == "(wait)") return;
				if (!ws_connect) return;
				
				if ((new Date()).getTime() - time_lastvcampolling < 1*1000) { //1secごとに送る
					return;
				}
				time_lastvcampolling = (new Date()).getTime();
				
				var _sendparam = {
			        "type": "vcam",
			        "name": "もやし猫@管理者だよ#dbec",
					"name_enc": "V6dF38CXUmd/wnnCYX9y/sDDCf8B9tPE87l7G63qZjV/cmeDCnd4dBcb0TVzE/yy",
			        "sender_id": vcamLocalID,
			       	"status": vcamLocalStatus
			    };
				
				SocketSend("@"+JSON.stringify(_sendparam));
			    pollingServer("vcam", _sendparam, 20*1000);
			}
	
$(function(){
	if (!navigator.getUserMedia) {
		$(".chatinput_func_capture").css("display", "none");
		$(".chatinput_func_videocapture").css("display", "none");
	}
});
</script>


<script>
$(function(){
	$(window).on('message', function(event) {
		if (!event.originalEvent || !event.originalEvent.data) return;
		console.log("event.originalEvent.data: ", event.originalEvent.data);
		var _data = event.originalEvent.data;
		if (_data["action"] == "gamennowCallback") {
			console.log("event.originalEvent.origin: ", event.originalEvent.origin);
			if (event.originalEvent.origin.indexOf("https://s.kuku.lu") !== 0) return;
			
			if (_data["url"]) {
				addChatInputAppend({"type": "link", "url": _data["url"]});
			}
			$("#dialog_capture").modal("hide");
		} else if (_data["action"] == "douganowCallback") {
			console.log("event.originalEvent.origin: ", event.originalEvent.origin);
			if (event.originalEvent.origin.indexOf("https://v.kuku.lu") !== 0) return;
			
			if (_data["url"]) {
				addChatInputAppend({"type": "link", "url": _data["url"]});
			}
			$("#dialog_capture").modal("hide");
		} else if (_data["action"] == "magicaldrawCallback") {
			console.log("event.originalEvent.origin: ", event.originalEvent.origin);
			if (event.originalEvent.origin.indexOf("https://draw.kuku.lu") !== 0) return;
			
			if (_data["image_url"]) {
				addChatInputAppend({"type": "image", "src": _data["image_url"]});
			}
			$("#dialog_capture").modal("hide");
		}
	});
});

</script>
	
<div id="dialog_profile" class="offcanvas offcanvas-start" tabindex="-1">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasExampleLabel">プロフィール設定</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
        	<div style="margin-bottom:15px;">
			<h6>
				ユーザープロフィール
			</h6>
    		
		    <div>
				<div class="form-floating mb-3">
				  <input type="text" class="form-control" id="user_id" value="もやし猫@管理者だよ" maxlength="16" placeholder="名前">
				  <label for="user_id">あなたの名前</label>
				</div>
		    </div>
		    <div>
				<div class="form-floating mb-3">
				  <input type="password" class="form-control" id="user_password" value="syosinni@10" maxlength="64" placeholder="トリップキー">
				  <label for="user_password">トリップキー</label>
				</div>
			
				<div class="alert alert-warning" role="alert">
					名前の#以降のIDはトリップキーから生成されます。同じトリップキーを使用するとIDも同じものが生成されます。
				</div>
		    </div>
		    <div>
				<div class="form-floating mb-3">
				  <input id="user_color" class="form-control" type="color" value="#a5dee5" maxlength="7" list="colors">
				  <label for="user_color">カラー</label>
				</div>
				<div style="margin-top:3px;">
					<datalist id="colors">
													<option value="#FEA78C"></option>
													<option value="#FFA3A6"></option>
													<option value="#F583B4"></option>
													<option value="#CD69A7"></option>
													<option value="#ED7179"></option>
													<option value="#8869A5"></option>
													<option value="#C58ADE"></option>
													<option value="#B1BEEA"></option>
													<option value="#90C4E9"></option>
													<option value="#8095CE"></option>
													<option value="#D6A3DC"></option>
													<option value="#F7DB70"></option>
													<option value="#EABEBF"></option>
													<option value="#75CCE8"></option>
													<option value="#A5DEE5"></option>
													<option value="#80BEAF"></option>
													<option value="#B3DDD1"></option>
													<option value="#D1DCE2"></option>
													<option value="#F5B994"></option>
													<option value="#EE9C6A"></option>
													<option value="#FFF5E9"></option>
													<option value="#FFE5C0"></option>
													<option value="#EAD2DF"></option>
													<option value="#EDB5D2"></option>
													<option value="#C8A8DA"></option>
													<option value="#FD475D"></option>
													<option value="#FEB396"></option>
													<option value="#FFCCBF"></option>
													<option value="#AED4D5"></option>
													<option value="#F9CC88"></option>
													<option value="#F5CEC7"></option>
													<option value="#E79796"></option>
													<option value="#FFB284"></option>
													<option value="#FFC98B"></option>
													<option value="#C6C09C"></option>
													<option value="#879E46"></option>
													<option value="#BBD5A6"></option>
													<option value="#FBCEB9"></option>
													<option value="#FEBD3D"></option>
													<option value="#E57B87"></option>
													<option value="#FFC4C8"></option>
													<option value="#FF5685"></option>
													<option value="#FED154"></option>
													<option value="#FEB25E"></option>
													<option value="#6AC7E6"></option>
													<option value="#FB93AC"></option>
													<option value="#9BC768"></option>
													<option value="#FDC7D4"></option>
													<option value="#FDD84C"></option>
													<option value="#BB9DCF"></option>
													<option value="#E49AAB"></option>
													<option value="#F3BDD7"></option>
													<option value="#FFDFA2"></option>
													<option value="#BFE4FF"></option>
													<option value="#A3B5FD"></option>
													<option value="#C3C5F8"></option>
													<option value="#60EFDB"></option>
													<option value="#BEF2E5"></option>
													<option value="#C5E7F1"></option>
													<option value="#79CEED"></option>
													<option value="#6F89A2"></option>
													<option value="#85CBCD"></option>
													<option value="#A8DEE0"></option>
													<option value="#F9E2AE"></option>
													<option value="#FBC78D"></option>
													<option value="#A7D676"></option>
													<option value="#ADC965"></option>
													<option value="#89D5C9"></option>
													<option value="#FAC172"></option>
													<option value="#FF8357"></option>
													<option value="#E25B45"></option>
													<option value="#D2A8B2"></option>
													<option value="#EDE1E5"></option>
													<option value="#DAE6E4"></option>
													<option value="#EECF65"></option>
													<option value="#DA9C25"></option>
											</datalist>
				</div>
		    </div>
		</div>
					
		<div style="margin-bottom:15px;">
			<h6>
				アカウント
			</h6>
		
											<div class="alert alert-warning" role="alert">
					連携ID(google)でログイン中
				</div>
				
										<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>もやし猫@管理者だよ#dbec</div>
									<div>
																					<a href="" class="btn btn-outline-secondary" style="pointer-events:none;">使用中</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@管理者かもよ#dbec</div>
									<div>
																					<a href="javascript:switchID('TFUmNkm2PRZILYMrT3j4jbUciBmM44CK1GBifB2E0pPGsngVmqrqvmiV%2FpUspHhYwgwX7iiUwXaM9IsW7KBRjQ%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>もやし猫＠管理者かもね#dbec</div>
									<div>
																					<a href="javascript:switchID('0dhsOzioz47S5IVAdDBcx9iX8un%2BVC5RbzARV2CeDZDV7OTrQWvjybdJqOe6vYBloQYylab1iqQJPmt2vFt27A%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@もやしだよ#dbec</div>
									<div>
																					<a href="javascript:switchID('0x3tZo8XgkHkNJhU35cKr9FHbeTtmlbQi%2FTqq1WVL1iF76j8G8u4Es7iLWDhIdOi8CrtippYiwPYjFP3eVTDGg%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@管理者らしき者#dbec</div>
									<div>
																					<a href="javascript:switchID('%2BwCRKB91U4srPFMLOdayi%2BV5ozH4G%2BOCSdP89WlTpPIzamJfFotP3hBmH%2Blwc%2BVBvx6VxwRWLhbZzuiTBphXuw%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
										
				<div style="margin-top:10px;">
			    	<div class="flex-right">
						<div><a class="btn btn-secondary" href="javascript:confirmLogout();">連携解除</a></div>
				    </div>
				</div>
					    	
	    </div>
      </div>
</div>
<script>
	$(function(){
		var dialog_profile = document.getElementById('dialog_profile');
		dialog_profile.addEventListener('hide.bs.offcanvas', function (e) {
			
		    $.ajax({
		        url:"room.php",
		        type:'POST',
		        data:"action=changeMyProfile&hash=cwp573h6&new_name="+encodeURIComponent($("#user_id").val())+"&new_trip="+encodeURIComponent($("#user_password").val())+"&new_color="+encodeURIComponent($("#user_color").val())+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
		        dataType: "json"
		    }).done(function(data){
		    	if (data["result"] == "OK") {
		    		$(".view_color").css("border-color", safestr(data["color"]));
		    		$(".view_username").html(safestr(data["username"]));
		    		return;
		    	}
		    	
		    	if (data["msg"]) {
		    		showToast(data["msg"]);
		    	} else {
		    		showToast("不明なエラーが発生しました。再度お試しください。");
		    	}
		    	setTimeout(function(){
		    		$("#dialog_profile").offcanvas("show");
		    	}, 200);
	 	    }).fail(function(){
	 	    	showToast("ネットワークエラーが発生しました。再度お試しください。");
		    	setTimeout(function(){
		    		$("#dialog_profile").offcanvas("show");
		    	}, 200);
		    });
		});
	});
	
	function switchID(_login_token) {
		jsonFetch(
			"./api_server.php", 
			"action=switchID&login_token="+encodeURIComponent(_login_token)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
			function(data){
		    	if (data["result"] == "OK") {
		    		location.reload();
		    	} else {
		    		showToast("システムエラーが発生しました。");
		    	}
			}
		);
	}
	
	function confirmLogout(_force) {
		if (!_force) {
			viewDialogConfirm({
				"title": "確認", 
				"content": "連携を解除してもよろしいですか？"
				},
				function(){
					confirmLogout(true);
				},
				function(){
				});
			return
		}
		
		jsonFetch(
			"./api_server.php", 
			"action=unlinkID&csrf_token_check=77a6556db546d525b7b4682783e342dc",
			function(data){
		    	if (data["result"] == "OK") {
		    		location.reload();
		    	} else {
		    		showToast("システムエラーが発生しました。");
		    	}
			}
		);
	}
</script>

<div id="dialog_login" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">ログイン</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="contents" style="padding:20px;">
    	
													      
					      		<div style="margin-bottom:10px;">
									<script type="text/javascript" src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>

									<div class="flex-center">
										<div id="appleid-signin" data-color="black" data-border="true" data-type="sign in" style="height:30px;width:185px;cursor:pointer;"></div>
										<script>
										AppleID.auth.init({
										clientId : 'lu.kuku.auth',
										redirectURI : 'https://auth.kuku.lu/callback.apple.php',
										state : '{"service":"chaat","hash":"cwp573h6","back":"\/cwp573h6"}',
										scope: 'email'
										});
										</script>
								    </div>
								</div>
											
					      		<div style="margin-bottom:10px;">
									<script src="https://accounts.google.com/gsi/client" async defer></script>
									<div id="g_id_onload"
									data-client_id="669712644646-oumsbv0udjcgl8oa2c06rma5mrfq7sus.apps.googleusercontent.com"
									data-callback="onGoogleLogin"
									data-auto_prompt="false">
									</div>

									<div class="flex-center">
											<div class="g_id_signin" data-type="standard" data-logo_alignment="center" data-width="185" data-size="medium"></div>
											<script>
											function onGoogleLogin(googleUser) {
												var _token = googleUser.credential;
												location.href = "https://auth.kuku.lu/callback.google.php?auth_service=chaat&token="+encodeURIComponent(_token)+"&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D";
											}
											</script>
								    </div>
								</div>
								
								<div style="margin-bottom:10px;">
									<div class="flex-center">
										<div class="linkidbox">
											<a href="https://auth.kuku.lu/request.php?auth_service=chaat&auth_provider=discord&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D" style="text-decoration: none;"><div style="text-align:center;width:185px;background-color:rgb(86,98,246);color:white;padding:5px;border-radius:5px;"><img src="img/icon-app-discord.png?v1" width="16" border="0"> Discord でログイン</div></a>
										</div>
								    </div>
							    </div>
							    	
								<div class="flex-center">
									<div style="width:185px;text-align:center;">
										<a href="https://auth.kuku.lu/request.php?auth_service=chaat&auth_provider=twitter&twitterauth_manual=1&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D" style="text-decoration: none;"><div style="background-color:#1da1f2;color:white;padding:5px;border-radius:5px;"><img src="img/icon-app-twitter.png" width="16" border="0"> Twitter でログイン</div></a>
									</div>
								</div>

      </div>
    </div>
  </div>
</div>
<script>
	$(function(){
		var dialog_login = document.getElementById('dialog_login');
		dialog_login.addEventListener('hide.bs.modal', function (e) {
		});
		
	});

	function openLogin() {
		$("#dialog_login").modal("show");
	}
</script>

<div id="dialog_chatmenu" class="offcanvas offcanvas-end" tabindex="-1">
	<div class="offcanvas-header">
		<h5 id="offcanvasRightLabel"></h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div class="offcanvas-body">
	
		<div class="area_tol_msg alert alert-warning" role="alert" style="margin-bottom:15px;display:none;"></div>
	
		<h6>メッセージ</h6>
	
		<div class="" style="width:100%;margin-bottom:15px;">
			<div style="margin-bottom:5px;"><button type="button" onclick="chatmenuReply();" class="btn btn-outline-primary" style="width:100%;">返信</button></div>
			<div style="margin-bottom:5px;"><button type="button" onclick="chatmenuCopy();" class="btn btn-outline-primary" style="width:100%;">コピー</button></div>
		</div>
	
		<h6>操作</h6>
	
		<div class="" style="width:100%;margin-bottom:15px;">
			<div class="include-owner-or-me" style="margin-bottom:5px;"><button type="button" onclick="chatmenuEdit();" class="btn btn-outline-danger" style="width:100%;">編集</button></div>
			<div class="include-owner-or-me" style="margin-bottom:5px;"><button type="button" onclick="chatmenuDelete();" class="btn btn-outline-danger" style="width:100%;">削除</button></div>
			<div class="include-owner chatmenu-button-ban" style="margin-bottom:5px;"><button type="button" onclick="chatmenuBAN();" class="btn btn-outline-danger" style="width:100%;">BAN</button></div>
			<div class="chatmenu-button-mute" style="margin-bottom:5px;"><button type="button" onclick="chatmenuMute();" class="btn btn-outline-danger" style="width:100%;">ミュート</button></div>
			<div class="include-owner-or-me chatmenu-button-autoreply" style="margin-bottom:5px;"><button type="button" onclick="chatmenuAutoreplyDisable();" class="btn btn-outline-danger" style="width:100%;">アシスタントを停止</button></div>
		</div>
		
		<h6>固定</h6>
			
		<div class="" style="width:100%;margin-bottom:15px;">
			<div class="pinned_on" style="margin-bottom:5px;"><button type="button" onclick="chatmenuPinned('on');" class="btn btn-outline-secondary" style="width:100%;">ピン留め</button></div>
			<div class="pinned_off" style="margin-bottom:5px;"><button type="button" onclick="chatmenuPinned('off');" class="btn btn-outline-secondary" style="width:100%;">ピン留め解除</button></div>
			
			<div class="include-owner">
				<div class="fixed_on" style="margin-bottom:5px;"><button type="button" onclick="chatmenuFixed('on');" class="btn btn-outline-secondary" style="width:100%;">上部に固定</button></div>
				<div class="fixed_off" style="margin-bottom:5px;"><button type="button" onclick="chatmenuFixed('off');" class="btn btn-outline-secondary" style="width:100%;">固定を解除</button></div>
			</div>
		</div>
			
	</div>
</div>
		
<div id="dialog_configselect" class="offcanvas offcanvas-end" tabindex="-1">
	<div class="offcanvas-header">
		<h5 id="offcanvasRightLabel" class="title">設定の選択</h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div id="area_configselect" class="offcanvas-body">
		
		<div class="card">
			<ul class="list-group list-group-flush">
				<li class="list-group-item divlink divlink_hover">
					<a href="javascript:void(0);" onclick="openUserConfig('');"></a>
					<div class="flex-leftright">
						<div>ユーザー設定を変更（サウンドやミュート）</div>
						<div>
						<div class="flex-right">
							<div></div>
							<div class="menu-rightallowbox divlink"></div>
						</div>
					<div>
				</li>
			</ul>
		</div>
		
		<div class="card" style="margin-top:10px;">
			<ul class="list-group list-group-flush">
				<li class="list-group-item divlink divlink_hover">
					<a href="javascript:void(0);" onclick="openRoomConfig('');"></a>
					<div class="flex-leftright">
						<div>ルーム設定を変更（オーナーのみ）</div>
						<div>
						<div class="flex-right">
							<div></div>
							<div class="menu-rightallowbox divlink"></div>
						</div>
					<div>
				</li>
			</ul>
		</div>
			
	</div>
</div>
		
<div id="dialog_configuser" class="offcanvas offcanvas-end" tabindex="-1">
	<div class="offcanvas-header">
		<h5 id="offcanvasRightLabel" class="title">ユーザー設定</h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div id="area_configuser_basic" class="dialog_configuser_inner offcanvas-body">
		
	    <div style="margin-bottom:15px;">
			<h6>
				サウンド設定
			</h6>

		    <div>
				<div class="form-floating mb-3">
					<select id="config_sound_newuser" class="form-control" onchange="">
						<option value="">オフ</option>
						<option value="on">常にオン</option>
						<option value="on-background">ウィンドウがバックグラウンドの場合のみオン</option>					</select>
					<label for="config_sound_newuser">参加者が増えたら音でお知らせ</label>
				</div>
		    </div>
		    	
		    <div>
				<div class="form-floating mb-3">
					<select id="config_sound_newmessage" class="form-control" onchange="">
						<option value="">オフ</option>
						<option value="on">常にオン</option>
						<option value="on-background">ウィンドウがバックグラウンドの場合のみオン</option>					</select>
					<label for="config_sound_newmessage">新着投稿を音でお知らせ</label>
				</div>
		    </div>
		    	
	    </div>
	    	
	    <div style="margin-bottom:15px;">
			<h6>
				操作設定
			</h6>

		    <div>
				<div class="form-floating mb-3">
					<select id="config_post_enter" class="form-control" onchange="">
													<option value="">Enterで投稿、Shift+Enterで改行</option>
							<option value="force_shift">Enterで改行、投稿はボタンのみ</option>
											</select>
					<label for="config_post_enter">改行と投稿</label>
				</div>
		    </div>
		    	
	    </div>
	    	
	    <div style="margin-bottom:15px;">
			<h6>
				読み上げ設定
			</h6>

		    <div>
				<div class="form-floating mb-3">
					<select id="config_softalk" class="form-control" onchange="updateUserConfigView();">
						<option value="">オフ</option>
						<option value="on">常にオン</option>
					</select>
					<label for="config_softalk">読み上げ機能</label>
				</div>
		    </div>
		    	
		    <div class="area_userconfig_softalk_detail">
		    	<a class="btn btn-outline-primary" style="width:100%;" href="javascript:openUserConfigSoftalkDetail();">読み上げの詳細設定</a>
			</div>
		    	
	    </div>
	    	
		<div style="margin-bottom:15px;">
			<h6>
				ミュート
			</h6>
				
		    <div>
		    	<a class="btn btn-outline-primary" style="width:100%;" href="javascript:openUserConfigMuteList();">ミュートリスト</a>
			</div>
		</div>
			
	</div>
	<div id="area_configuser_softalk" class="dialog_configuser_inner offcanvas-body">
		<div class="mb-3"><a href="javascript:void(0);" onclick="openUserConfig('');" class="btn btn-outline-secondary"> ≪ 戻る </a></div>
		<div class="content">
		    <div style="margin-bottom:15px;">
				<h6>
					読み上げの詳細設定
				</h6>

			    <div>
					<div class="form-floating mb-3">
						<select id="config_softalk_name" class="form-control" onchange="">
							<option value="">オフ</option>
							<option value="on">オン</option>
						</select>
						<label for="config_softalk_name">名前を読み上げる</label>
					</div>
			    </div>
			    	
			    <div>
					<div class="form-floating mb-3">
						<select id="config_softalk_cutoff" class="form-control" onchange="">
							<option value="short">短い</option>
							<option value="">通常</option>
							<option value="long">長い</option>
							<option value="off">限界まで省略しない</option>
						</select>
						<label for="config_softalk_cutoff">途中で文章を省略する長さ</label>
					</div>
			    </div>
			    	
			    <div>
					<div class="form-floating mb-3">
						<input type="range" id="config_softalk_speed" value="1.2" min="0.3" max="2.0" step="0.1" class="form-control">
						<label for="config_softalk_speed">読み上げスピード</label>
					</div>
			    </div>
			    	
			    <div>
					<div class="form-floating mb-3">
						<input type="range" id="config_softalk_volume" value="50" min="1" max="100" step="1" class="form-control">
						<label for="config_softalk_volume">読み上げ音量</label>
					</div>
			    </div>
			    	
		    <div>
		    	<a class="btn btn-outline-secondary" style="width:100%;" href="javascript:sampleUserConfigSoftalkDetail();">読み上げのテスト</a>
			</div>
			    	
		    </div>
		</div>
	</div>
	<div id="area_configuser_mutelist" class="dialog_configuser_inner offcanvas-body">
		<div class="mb-3"><a href="javascript:void(0);" onclick="openUserConfig('');" class="btn btn-outline-secondary"> ≪ 戻る </a></div>
		<div class="content">
		</div>
	</div>
</div>
<script>
	$(function(){
		var dialog_configuser = document.getElementById('dialog_configuser');
		dialog_configuser.addEventListener('hide.bs.offcanvas', function () {
			saveUserConfig();
		});
	});
	
	function updateUserConfigView() {
		if ($("#config_softalk").val() == "on") {
			$(".area_userconfig_softalk_detail").css("display", "block");
		} else {
			$(".area_userconfig_softalk_detail").css("display", "none");
		}
		
	}
	
	function openUserConfigSoftalkDetail() {
		$(".dialog_configuser_inner").css("display", "none");
		$("#area_configuser_softalk").css("display", "block");
		
		dummyClickIfNeeded(true);
	}
		function sampleUserConfigSoftalkDetail() {
			saveUserConfig();
			addSoftalkQueue('読み上げのテストです。', true);
		}
	
	function openUserConfigMuteList() {
		var _buf = "";
		for (var i in mute_userid) {
			var _js = "unmuteMuteList('"+i+"');";
			
			_buf += '<div id="mutelist_'+i+'" class="card" style="margin-bottom:5px;">';
			_buf += '	<div class="card-body">';
			_buf += '		<div class="flex-leftright">';
			_buf += '			<div><b>'+safestr(mute_userid[i]["name"])+'</b><br>'+UnixtimeToDate(mute_userid[i]["time"])+'</div>';
			_buf += '			<div><a href="javascript:'+_js+'" class="btn btn-outline-secondary">解除</a></div>';
			_buf += '		</div>';
			_buf += '	</div>';
			_buf += '</div>';
		}
		if (_buf) {
			_buf = '<div style="margin-bottom:15px;"><a class="btn btn-outline-primary" style="width:100%;" href="javascript:resetMuteList();">ミュートリストのリセット</a></div>' + _buf;
			$("#area_configuser_mutelist .content").html(_buf);
		} else {
			$("#area_configuser_mutelist .content").html("<div class='nodata'>リストがありません。</div>");
		}
		
		$(".dialog_configuser_inner").css("display", "none");
		$("#area_configuser_mutelist").css("display", "block");
	}
	
		function UnixtimeToDate(_unixtime) {
			var d = new Date(Math.round(_unixtime*1000));
			return NumFix(d.getMonth() + 1)+"/"+NumFix(d.getDate())+" "+NumFix(d.getHours())+":"+NumFix(d.getMinutes());
		}
			function NumFix(_num) {
				if (_num <= 9) return "0"+_num;
				return _num;
			}
			
	function unmuteMuteList(_userid) {
		delete mute_userid[_userid];
		$("#mutelist_"+_userid).remove();
		
		setConf("mute_userid", JSON.stringify(mute_userid));
		reloadMuteList();
	}
	
	function resetMuteList(_force) {
		if (!_force) {
			viewDialogConfirm({
				"title": "確認", 
				"content": "ミュートリストをリセットしますか？"
				},
				function(){
					resetMuteList(true);
				},
				function(){
				});
			return
		}
		
		setConf("mute_userid", "");
		reloadMuteList();
		
		showToast("ミュートリストをリセットしました。");
		location.reload();
	}
		var mute_userid = {};
		function reloadMuteList() {
			var _tmp = getConf("mute_userid", "");
			if (_tmp) {
				try {
					mute_userid = JSON.parse(_tmp);
				} catch(e) {
					console.error(e);
				}
			}
		}
		
</script>
			
<div id="dialog_config" class="offcanvas offcanvas-end" tabindex="-1">
	<div class="offcanvas-header">
		<h5 id="offcanvasRightLabel" class="title">ルーム設定</h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div id="area_config_login" class="dialog_config_inner offcanvas-body">
		
		<div class="alert alert-warning" role="alert">
			ルーム設定を変更するには、オーナーパスワードでログインしてください。
		</div>
		
	    <div>
			<div class="form-floating mb-3">
			  <input type="password" class="form-control" id="login_password_owner" value="" maxlength="16" placeholder="オーナーパスワード">
			  <label for="login_password_owner">オーナーパスワード</label>
			</div>

	    </div>
	    	
	    <div style="margin-top:10px;">
		    <div class="flex-right">
		    	<div><input onclick="openRoomConfig('login-owner');" class="form-control btn btn-primary" type="button" value="ログイン" /></div>
		    </div>
		</div>
			
					
	</div>
	<div id="area_config_basic" class="dialog_config_inner offcanvas-body">
	
		<div style="margin-bottom:15px;">
			<h6>
				基本設定
			</h6>
		
		    <div>
				<div class="form-floating mb-3">
				  <input type="text" class="form-control" id="config_title" value="" maxlength="64" placeholder="ルームタイトル">
				  <label for="config_title">ルームタイトル</label>
				</div>
		    </div>
		    	
		    <div>
				<div class="form-floating mb-3">
				  <input type="password" class="form-control" id="config_password_owner" value="" maxlength="16" placeholder="オーナーパスワード">
				  <label for="config_password_owner">オーナーパスワード</label>
				</div>

		    </div>
	    </div>
	    
	    <div style="margin-bottom:15px;">
			<h6>
				制限設定
			</h6>

		    <div>
				<div class="form-floating mb-3">
					<select id="config_access_permission" class="form-control" onchange="updateRoomConfigView();">
						<option value="">誰でもアクセス可</option>
						<option value="access-password">アクセスパスワード</option>
						<option value="access-check">アクセス許可制</option>
					</select>
					<label for="config_access_permission">アクセス制限</label>
				</div>
		    </div>

		    <div class="area_config_password_access">
				<div class="form-floating mb-3">
				  <input type="text" class="form-control" id="config_password_access" value="" maxlength="16" placeholder="アクセスパスワード">
				  <label for="config_password_access">アクセスパスワード</label>
				</div>
		    </div>
		    	
		    <div>
				<div class="form-floating mb-3">
					<select id="config_write_permission" class="form-control" onchange="updateRoomConfigView();">
						<option value="">誰でも書き込み可</option>
						<option value="only-owner">オーナーのみ書き込み可</option>
						<option value="write-password">書き込みパスワードが必要</option>
					</select>
					<label for="config_write_permission">書き込み制限</label>
				</div>
		    </div>
		    	
		    <div class="area_config_password_write">
				<div class="form-floating mb-3">
				  <input type="text" class="form-control" id="config_password_write" value="" maxlength="16" placeholder="書き込みパスワード">
				  <label for="config_password_write">書き込みパスワード</label>
				</div>
		    </div>
		    	
		    <div>
				<div class="form-floating mb-3">
					<select id="config_edit_permission" class="form-control" onchange="updateRoomConfigView();">
						<option value="">自分の書き込みは編集＆削除可</option>
						<option value="only-owner">編集＆削除はオーナーのみ</option>
					</select>
					<label for="config_edit_permission">編集制限</label>
				</div>
		    </div>
		    	
		    <div>
				<div class="form-floating mb-3">
					<select id="config_read_permission" class="form-control" onchange="updateRoomConfigView();">
						<option value="">誰でも閲覧可</option>
						<option value="only-owner">オーナーと本人のみ閲覧可</option>
					</select>
					<label for="config_read_permission">書き込みの閲覧制限</label>
				</div>
		    </div>
		    	
	    </div>
	    		
	    <div style="margin-bottom:15px;">
			<h6>
				時間制限
			</h6>
				
							
		    <div>
				<div class="form-floating mb-3">
					<select id="config_tol_write" class="form-control">
													<option value="0">永続</option>
													<option value="300">5分</option>
													<option value="600">10分</option>
													<option value="1800">30分</option>
													<option value="3600">1時間</option>
													<option value="10800">3時間</option>
													<option value="43200">12時間</option>
													<option value="86400">1日</option>
													<option value="604800">7日</option>
													<option value="1209600">14日</option>
													<option value="2678400">1ヶ月</option>
													<option value="16070400">6ヶ月</option>
													<option value="31536000">1年</option>
											</select>
					<label for="config_tol_write">書き込みの自動削除</label>
				</div>
		    </div>
		    			
		    <div>
				<div class="form-floating mb-3">
					<select id="config_tol_room" class="form-control">
													<option value="0">永続</option>
													<option value="300">5分</option>
													<option value="600">10分</option>
													<option value="1800">30分</option>
													<option value="3600">1時間</option>
													<option value="10800">3時間</option>
													<option value="43200">12時間</option>
													<option value="86400">1日</option>
													<option value="604800">7日</option>
													<option value="1209600">14日</option>
													<option value="2678400">1ヶ月</option>
													<option value="16070400">6ヶ月</option>
													<option value="31536000">1年</option>
											</select>
					<label for="config_tol_room">ルームの自動削除</label>
				</div>
		    </div>
		    			
			<div class="area_tol_room_msg alert alert-warning" role="alert" style="display:none;">
			</div>
	    </div>
	    		
	    <div style="margin-bottom:15px;">
			<h6>
				モード
			</h6>
				
		    <div class="area_config_progress_write">
				<div class="form-floating mb-3">
					<select id="config_progress_write" class="form-control">
						<option value="0">オフ</option>
						<option value="1">オン</option>
					</select>
					<label for="config_progress_write">入力中の文章を全員に表示</label>
				</div>
		    </div>
		    			
	    </div>
	    		
		<div style="margin-bottom:15px;">
			<h6>
				リスト
			</h6>
			
		    <div class="area_config_check_access" style="margin-bottom:15px;">
		    	<a class="btn btn-outline-primary" style="width:100%;" href="javascript:openRoomConfigAccessCheckList();">アクセス許可リスト</a>
			</div>
				
		    <div>
		    	<a class="btn btn-outline-primary" style="width:100%;" href="javascript:openRoomConfigBANList();">BANリスト</a>
			</div>
		</div>
				
		<div style="margin-bottom:15px;">
			<h6>
				投稿用API
			</h6>
				
		    <div>
		    	<a class="btn btn-outline-primary" style="width:100%;" href="javascript:openRoomConfigMailaddr();">設定</a>
			</div>
		</div>
		
		<div style="margin-bottom:15px;">
			<h6>
				閉鎖
			</h6>
				
		    <div>
		    	<a class="btn btn-outline-danger" style="width:100%;" href="javascript:deleteRoom();">ルームを閉鎖</a>
			</div>
		</div>
	    	
	</div>
	<div id="area_config_accesschecklist" class="dialog_config_inner offcanvas-body">
		<div class="mb-3"><a href="javascript:void(0);" onclick="openRoomConfig('');" class="btn btn-outline-secondary"> ≪ 戻る </a></div>
		<div class="content">
		</div>
	</div>
	<div id="area_config_banlist" class="dialog_config_inner offcanvas-body">
		<div class="mb-3"><a href="javascript:void(0);" onclick="openRoomConfig('');" class="btn btn-outline-secondary"> ≪ 戻る </a></div>
		<div class="content">
		</div>
	</div>
	<div id="area_config_mailaddr" class="dialog_config_inner offcanvas-body">
		<div class="mb-3"><a href="javascript:void(0);" onclick="openRoomConfig('');" class="btn btn-outline-secondary"> ≪ 戻る </a></div>
		<div class="content">
		    <div class="mb-3">
		    	<a class="btn btn-primary" style="width:100%;" href="javascript:addRoomConfigMailaddr();">投稿用アドレスを追加</a>
			</div>
			
			<div class="maillist" style="margin-top:15px;">
			</div>
		</div>
	</div>
</div>
<script>
	$(function(){
		var dialog_config = document.getElementById('dialog_config');
		dialog_config.addEventListener('hide.bs.offcanvas', function () {
			saveRoomConfig();
		});
	});
	
	function updateRoomConfigView() {
		if ($("#config_access_permission").val() == "access-password") {
			$(".area_config_password_access").css("display", "block");
		} else {
			$(".area_config_password_access").css("display", "none");
		}
		
		if ($("#config_access_permission").val() == "access-check") {
			$(".area_config_check_access").css("display", "block");
		} else {
			$(".area_config_check_access").css("display", "none");
		}
		
		if ($("#config_write_permission").val() == "write-password") {
			$(".area_config_password_write").css("display", "block");
		} else {
			$(".area_config_password_write").css("display", "none");
		}
		
		if ($("#config_read_permission").val() == "only-owner") {
			$(".area_config_progress_write").css("display", "none");
		} else {
			$(".area_config_progress_write").css("display", "block");
		}
		
	}
	
	function openRoomConfigAccessCheckList() {
		$(".dialog_config_inner").css("display", "none");
		$("#area_config_accesschecklist").css("display", "block");
	}
	
		function accesscheckRoomConfig(_tar, _id_enc, _access_num) {
			if (_access_num == 1) {
				_access = "allow";
			} else {
				_access = "deny";
			}
			
			jsonFetch(
				"room.php", 
				"&hash=cwp573h6&action=accesscheckUser&csrf_token_check=77a6556db546d525b7b4682783e342dc&id_enc="+encodeURIComponent(_id_enc)+"&access="+_access, 
				function(data){
					//$("#accesscheck_"+_tar).remove();
					$("#accesscheck_"+_tar+" .new").css("display", "none");
					$("#accesscheck_"+_tar+" .old").css("display", "block");
					$("#accesscheck_"+_tar+" .old_value").val(_access_num);
				}
			);
		}
	
	function openRoomConfigBANList() {
		$(".dialog_config_inner").css("display", "none");
		$("#area_config_banlist").css("display", "block");
	}
	
		function unbanRoomConfig(_tar, _id_enc) {
			jsonFetch(
				"room.php", 
				"&hash=cwp573h6&action=unbanUser&csrf_token_check=77a6556db546d525b7b4682783e342dc&id_enc="+encodeURIComponent(_id_enc), 
				function(data){
					$("#banlist_"+_tar).remove();
				}
			);
		}
	
	function openRoomConfigMailaddr() {
		$(".dialog_config_inner").css("display", "none");
		$("#area_config_mailaddr").css("display", "block");
		
	    updateRoomConfigMailaddr();
	}
		function updateRoomConfigMailaddr() {
			
			jsonFetch(
				"room.php", 
				"action=getRoomConfigMailaddr&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc",
				function(data){
			    	if (data["result"] == "OK") {
			    		var _buffer = "";
			    		for (var i in data["list_mailaddr"]) {
			    			var _ent = data["list_mailaddr"][i];
			    			var _webhookcopyjs = "javascript:clipcopyjs('"+_ent["webhook"]+"');";
			    			var _mailcopyjs = "javascript:clipcopyjs('"+_ent["addr_full"]+"');";
			    			var _deletejs = "javascript:deleteRoomConfigMailaddr('"+_ent["addr"]+"', '"+_ent["addr_full"]+"');";
			    			var _changejs = "changeRoomConfigMailaddr('"+_ent["addr"]+"', this.value);";
			    			_buffer += '<div style="margin-bottom:20px;">';
			    			_buffer += '	<div class="form-floating">';
			    			_buffer += '		<input type="text" onchange="'+_changejs+'" class="form-control" id="config_mailaddr_'+_ent["addr"]+'" value="'+safestr(_ent["name"])+'" maxlength="64" placeholder="アドレスを区別する名前（任意）">';
			    			_buffer += '		<label for="config_mailaddr_'+_ent["addr"]+'">'+_ent["addr_full"]+'</label>';
			    			_buffer += '	</div>';
			    			_buffer += '	<div class="flex-leftright" style="margin-top:3px;">';
			    			_buffer += '		<div>';
			    			_buffer += '			<div class="btn-group" role="group">';
			    			_buffer += '				<a href="'+_webhookcopyjs+'" class="btn btn-sm btn-outline-primary">Webhookのコピー</a> ';
			    			_buffer += '				<a href="'+_mailcopyjs+'" class="btn btn-sm btn-outline-primary">メールアドレスのコピー</a> ';
			    			_buffer += '			</div>';
			    			_buffer += '		</div>';
			    			_buffer += '		<div>';
			    			_buffer += '			<a href="'+_deletejs+'" class="btn btn-sm btn-outline-danger">削除</a>';
			    			_buffer += '		</div>';
			    			_buffer += '	</div>';
			    			_buffer += '</div>';
			    		}
			    		$("#area_config_mailaddr .maillist").html(_buffer).trigger("create");
			    	} else {
			    		showToast("システムエラーが発生しました。");
			    	}
				}
			);
		}
		function deleteRoomConfigMailaddr(_addr, _addr_full) {
			viewDialogConfirm({
				"title": "確認", 
				"content": "アドレス ("+_addr_full+") を削除してもよろしいですか？削除すると二度と使用できなくなります。"
				},
				function(){
					jsonFetch(
						"room.php", 
						"action=deleteRoomConfigMailaddr&hash=cwp573h6&addr="+encodeURIComponent(_addr)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
						function(data){
					    	if (data["result"] == "OK") {
					    		updateRoomConfigMailaddr();
					    	} else if (data["msg"]) {
					    		showToast(data["msg"]);
					    	} else {
					    		showToast("システムエラーが発生しました。");
					    	}
						}
					);
				},
				function(){
				});
		}
		function changeRoomConfigMailaddr(_addr, _name) {
				jsonFetch(
					"room.php", 
					"action=changeRoomConfigMailaddr&hash=cwp573h6&addr="+encodeURIComponent(_addr)+"&name="+encodeURIComponent(_name)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
					function(data){
				    	if (data["result"] == "OK") {
				    	} else if (data["msg"]) {
				    		showToast(data["msg"]);
				    	} else {
				    		showToast("システムエラーが発生しました。");
				    	}
					}
				);
		}
		
		function addRoomConfigMailaddr() {
			jsonFetch(
				"room.php", 
				"action=addRoomConfigMailaddr&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc",
				function(data){
			    	if (data["result"] == "OK") {
			    		updateRoomConfigMailaddr();
			    	} else if (data["msg"]) {
			    		showToast(data["msg"]);
			    	} else {
			    		showToast("システムエラーが発生しました。");
			    	}
				}
			);
		}

</script>

<div id="dialog_login_password_write" class="modal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">書き込みパスワードが必要です</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
	
				<div class="wrong_password alert alert-danger" role="alert" style="display:none;margin-bottom:10px;">
					パスワードが間違っています。
				</div>
	
				<div style="text-align:center;">
					<input class="form-control" id="login_password_write" type="text" value="" placeholder="書き込みパスワード">
				</div>
			</div>
			<div class="modal-footer">
				<button onclick="loginPasswordWrite();" type="button" class="btn btn-primary">ログイン</button>
			</div>
		</div>
	</div>
</div>

<div id="dialog_confirm" class="modal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="title modal-title">
					
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="content modal-body">
	
			</div>
			<div class="modal-footer">
				<button onclick="dialogConfirmOK();" type="button" class="btn-ok btn btn-primary">OK</button>
				<button onclick="dialogConfirmCancel();" type="button" class="btn-cancel btn btn-secondary">キャンセル</button>
			</div>
		</div>
	</div>
</div>
<script>
	var dialogConfirmCancelCallback = false;
	var dialogConfirmOKCallback = false;
	function viewDialogConfirm(_opt, _callback_ok, _callback_cancel) {
		dialogConfirmOKCallback = _callback_ok;
		dialogConfirmCancelCallback = _callback_cancel;
		
		if (_callback_ok) {
			$("#dialog_confirm .btn-ok").css("display", "block");
		} else {
			$("#dialog_confirm .btn-ok").css("display", "none");
		}
		
		if (_callback_cancel) {
			$("#dialog_confirm .btn-cancel").css("display", "block");
		} else {
			$("#dialog_confirm .btn-cancel").css("display", "none");
		}
		
		$("#dialog_confirm .title").html(_opt["title"]);
		$("#dialog_confirm .content").html(_opt["content"]);
		
		if (_opt["req-choose"]) {
			$("#dialog_confirm").data({"bs-backdrop": "static", "bs-keyboard": "false"});
		} else {
			$("#dialog_confirm").data({"bs-backdrop": "", "bs-keyboard": ""});
		}
		
		if (_opt["button-cancel"]) {
			$("#dialog_confirm .btn-cancel").text(_opt["button-cancel"]);
		} else {
			$("#dialog_confirm .btn-cancel").text("キャンセル");
		}
		
		if (_opt["button-ok"]) {
			$("#dialog_confirm .btn-ok").text(_opt["button-ok"]);
		} else {
			$("#dialog_confirm .btn-ok").text("OK");
		}
		
		$("#dialog_confirm").modal("show");
	}
		$(function(){
			document.getElementById('dialog_confirm').addEventListener('hide.bs.modal', function (event) {
				if (dialogConfirmCancelCallback) {
					dialogConfirmCancelCallback();
					dialogConfirmCancelCallback = false;
				}
			})
		});
		function dialogConfirmOK() {
			$("#dialog_confirm").modal("hide");
			
			if (dialogConfirmOKCallback) {
				dialogConfirmOKCallback();
				dialogConfirmOKCallback = false;
			}
		}
		function dialogConfirmCancel() {
			$("#dialog_confirm").modal("hide");
			
			if (dialogConfirmCancelCallback) {
				dialogConfirmCancelCallback();
				dialogConfirmCancelCallback = false;
			}
		}
</script>

<div id="dialog_offcanvas_start" class="offcanvas offcanvas-start" tabindex="-1">
	<div class="offcanvas-header">
		<h5 id="offcanvasTopLabel" class="title"></h5>
		<button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
	</div>
	<div class="content offcanvas-body">
		
	</div>
</div>
<script>
	function viewDialogOffcanvasLeft(_opt) {
		closeOffcanvas();
		
		$("#dialog_offcanvas_start .title").html(_opt["title"]);
		$("#dialog_offcanvas_start .content").html(_opt["content"]);

		$("#dialog_offcanvas_start").offcanvas("show");
	}
	
	function closeOffcanvas() {
		$(".offcanvas").offcanvas("hide");
	}
</script>
		
<script>
//画面表示
var visibleWindow = true;
window.addEventListener("blur", () => {
	visibleWindow = false;
    sendMessagePush({"action": "visibleWindow", "visible": false});
});

window.addEventListener("focus", () => {
	visibleWindow = true;
    sendMessagePush({"action": "visibleWindow", "visible": true});
    clearUnreadCount();
});

//未読数
var countUnread = 0;
function addUnreadCount(_cnt) {
	countUnread += _cnt;
	changeWindowTitle();
}
function clearUnreadCount() {
	countUnread = 0;
	changeWindowTitle();
}

var baseWindowTitle = "";
function changeWindowTitle(_title) {
	if (_title) {
		baseWindowTitle = ""+_title+" | chaat";
	} else if (_title !== undefined) {
		baseWindowTitle = "chaat";
	}
	var _newtitle = baseWindowTitle;
	if (countUnread > 0) {
		_newtitle = "("+countUnread+") "+_newtitle;
	}
	
	document.title = _newtitle;
}

var timeout_scroll = false;
$(function(){
	
	//画面リサイズ
	$(window).bind("load resize", function(e){
		console.log("resize: ", e);
		windowResize();
	});
	windowResize();
	
    $.fn.hasScrollBar = function() {
        return this.get(0).scrollHeight > this.height();
    }
	
	$(".chatlog_master").on("scroll", function(e) {
		//console.error("scroll!", e);
		
		clearTimeout(timeout_scroll);
		timeout_scroll = setTimeout(function(){
			checkChatlogScroll();
			timeout_scroll = false;
		}, 80);
	});
	//$(function(){
	//	setInterval(function(){
	//		checkChatlogScroll();
	//	}, 2000);
	//});

	//入力
	$("#chatinput").bind("focus", function(e) {
		if ($("#chatinput .placehold").length > 0) {
			$("#chatinput .placehold").remove();
		}
		
		$(".chatinput_left_mini").css("display", "");
		$(".chatinput_left_full").css("display", "");
		
		windowResize();
		setTimeout(windowResize, 100);
	});
	$("#chatinput").bind("blur", function(e) {
		if ($("#chatinput").text().split("\n").join("").split("\t").join("") == "") {
			updateChatinput('<div class="placehold" style="color:gray;user-select:none;pointer-events: none;">メッセージを入力...</div>');
		}
		SendChatProgress(false);
		
		windowResize();
		setTimeout(windowResize, 100);
	});
	$("#chatinput").bind("input", function(e) {
		
		var _imgs = $("#chatinput").find("img");
		if (_imgs.length > 0) {
			var _cnt = 0;
			for (var i=0; i<_imgs.length; i++) {
				console.log("img発見: ", _imgs.eq(i));
				addChatInputAppend({"type": "image", "src": _imgs.eq(i).attr("src")});
				_imgs.eq(i).remove();
				_cnt ++;
			}
		}
		
		windowResize();
	});
	$("#chatinput").bind("keydown", function(e) {
		return checkChatInput(e.originalEvent);
	});
	$(document).keypress(function(e){
		// エンターキーだったら無効にする
		if (e.key === 'Enter' && $(':focus').length <= 0) {
			$("#chatinput").focus();
			return false;
		}
	});
	
	init();

});

	function init() {
		initChatLog();
		reloadMuteList();
		
		refreshRoomConfig(function(){
			wsConnect();
		});
		
		setInterval(main, 1000);
	}
		var cache_fixed_message = false;
		var room_config = {};
		function refreshRoomConfig(_callback) {
			loadRoomConfig("", function(data){
				room_config = data;
				console.log("room_config:", room_config);
				
				//WS接続先
				hostaddr = data["sv"];
				hostport_ws = data["port"];
				
				//タイトル
				if (data["title"]) {
					changeWindowTitle(""+data["title"]);
					$(".room_title").text(""+data["title"]);
					$(".room_title").css("visibility", "visible");
				} else {
					changeWindowTitle("");
					$(".room_title").text("");
					$(".room_title").css("visibility", "hidden");
				}
				
				//固定されたメッセージ
				if (data["fixed_message"] && (!cache_fixed_message || (cache_fixed_message && cache_fixed_message["num"] != data["fixed_message"]["num"]))) {
					cache_fixed_message = data["fixed_message"];
					var _html = genChatItemHTML(data["fixed_message"]["num"], data["fixed_message"]["data"]);
					$(".area_chatlog_fixed .data").html(_html);
					
					if (!checkConfigArrayList("fixed_message_checked", "cwp573h6")) {
						$(".area_chatlog_fixed").css("display", "block");
					} else {
						closeFixedMessage(true);
					}
					updateCardLoader("fixed");
				} else if (!data["fixed_message"]) {
					cache_fixed_message = false;
					$(".area_chatlog_fixed").css("display", "none");
				}
				
				windowResize();
				
				if (_callback) {
					_callback(data);
				}
			});
		}

	function addChatInputAppend(_item) {
		console.log("addChatInputAppend: ", _item);
		
		if ($(".chatinput_append .appendview .appenditem").length >= 5) {
			showToast("同時に添付できる最大数は5個です。");
			return;
		}
		
		var _html = "";
		_html += "<div class='appenditem' data-type='"+safestr(_item["type"])+"' data-url='"+safestr(_item["url"])+"'>";
		_html += "	<div class='close divlink'><a href='javascript:void(0);' onclick='delChatInputAppend(this);'></a><div><img src='img/icon_close.png'></div></div>";
		if (_item["type"] == "link") {
			_html += "	<div class='cardloader' data-type='link' data-url='"+safestr(_item["url"])+"'><div class='spinner-border text-warning' role='status'></div></div>";
		} else {
			_html += "	<div><img src='"+safestr(_item["src"])+"' class='img'></div>";
		}
		_html += "</div>";
		$(".chatinput_append .appendview").append(_html);
		
		
		$(".chatinput_append").css("display", "block");
		
		updateCardLoader("append");
			
		windowResize();
	}
	function delChatInputAppend(_tar) {
		console.log("delChatInputAppend: ", $(_tar));
		
		$(_tar).parents('.appenditem').remove();
		
		if ($(".chatinput_append .appendview .appenditem").length <= 0) {
			$(".chatinput_append").css("display", "none");
		}
		
		windowResize();
	}

	function windowResize() {
		//console.log("height: "+window.innerHeight, window.outerHeight, $('#area_footer').children().height());
		
		$("#area_header").css("height", ""+$('#area_header').children().outerHeight(true)+"px");
		$("#area_footer").css("height", ""+$('#area_footer').children().outerHeight(true)+"px");
		
		$(".chatlog_master").css("height", ""+(window.innerHeight-($("#area_header").outerHeight(true) + $("#area_footer").outerHeight(true)))+"px");
		if (data_chatlog[chatlog_mode]["scroll_magnet_bottom"] && !timeout_scroll) {
			console.log("windowResize: ChatScrollLast call ("+timeout_scroll+")");
			ChatScrollLast(true);
		}
		
		$(".room_title_header").css("width", window.innerWidth - ($(".room_icon_header").width()+100));
		
		if (window.scrollY) {
			$(".master_body").css({"position": "absolute", "left": 0, "right": 0, "top": window.scrollY+"px", "bottom": 0});
		} else {
			$(".master_body").css({"top": ""});
		}
	}

	function checkChatlogScroll() {
		var _top = getChatlogScroll(chatlog_mode, "top", "percent");
		var _bottom = getChatlogScroll(chatlog_mode, "bottom", "percent");
		
		if (getChatlogScroll(chatlog_mode, "bottom", "px") <= 80 || _bottom >= 100) {
			data_chatlog[chatlog_mode]["scroll_magnet_bottom"] = true;
			$("#area_chatlog_"+chatlog_mode+"_master .scroll_magnet_bottom").css("display", "none");
			
			console.error("scroll_magnet_bottom: 外れていません", chatlog_mode, getChatlogScroll(chatlog_mode, "bottom", "px"), _bottom);
		} else {
			data_chatlog[chatlog_mode]["scroll_magnet_bottom"] = false;
			$("#area_chatlog_"+chatlog_mode+"_master .scroll_magnet_bottom").css("display", "block");
			
			console.error("scroll_magnet_bottom: 外れました", chatlog_mode, getChatlogScroll(chatlog_mode, "bottom", "px"), _bottom);
		}
		
		if (Math.abs(_top - _bottom) <= 80 || _top == 0) {
			if (_bottom >= 85 && data_chatlog[chatlog_mode]["over"]["new"]) { //かなり下までスクロールしている
				if (data_chatlog[chatlog_mode]["scroll_magnet_bottom"]) {
					fetchData({"mode": chatlog_mode, "type": "last", "clean": true});
				} else {
					fetchData({"mode": chatlog_mode, "type": "new"});
				}
				data_chatlog[chatlog_mode]["over"]["new"] = false;
			} else if ((getChatlogScroll(chatlog_mode, "top", "px") <= 500 || _top <= 5) && data_chatlog[chatlog_mode]["over"]["old"]) { //かなり上までスクロールしている
				if (!fetchLock) {
					fetchData({"mode": chatlog_mode, "type": "old"});
					data_chatlog[chatlog_mode]["over"]["old"] = false;
				}
			}
		}
	}
		function getChatlogScroll(_mode, _pos, _valtype) {
			var _maxScroll = getChatLogHeight(_mode);
			var _nowScroll = $("#area_chatlog_"+_mode+"_master").scrollTop();
			var _areaHeight = $("#area_chatlog_"+_mode+"_master").height();
			var _percent = 0;
			if (!$("#area_chatlog_"+_mode+"_master").hasScrollBar()) {
				if (_pos == "top") {
					if (_valtype == "percent") {
						return 0;
					} else {
						return 0;
					}
				} else {
					if (_valtype == "percent") {
						return 100;
					} else {
						return _maxScroll;
					}
				}
			}
			if (_valtype == "percent") {
				if (_pos == "top") {
					_percent = (_nowScroll / _maxScroll) * 100;
				} else {
					_percent = ((_nowScroll+_areaHeight) / _maxScroll) * 100;
				}
				return _percent;
			} else {
				if (_pos == "top") {
					return _nowScroll;
				} else {
					return _maxScroll - (_nowScroll+_areaHeight);
				}
			}
		}

	function appendInputCursor(_str) {
		var _sel = window.getSelection();
		if (!_sel) return false;
		
		console.log(_sel);
		
		let _range = _sel.getRangeAt(0);
		//var _newNode = document.createTextNode(_str);
		var _newNode = document.createElement("span");
		_newNode.innerHTML = _str;
		
		_range.deleteContents();
		_range.insertNode(_newNode);
		_range.collapse(true);
		_range.setStart(_newNode, _str.length);
		
		return true;
	}

	function checkChatInput(e) {
		if (!e) {
			e = window.event;
		}
		
		if (e.keyCode == 9) {
			//$("#chatinput").append("テスト");
			appendInputCursor("	");
			return false;
		}
		
		if (e.keyCode == 13) { //Enter
			if (e.shiftKey) { //Shift
				windowResize();
				return;
			}
			
							//チャット送信(PC)
				if (loadCookieConfig("config_post_enter", "") == "") {
					SendChat();
					return false;
				}
					}
		
		setTimeout(function(){SendChatProgress(true);}, 10);
	}
	var last_chatinput = "";
	function SendChat() {
		//書き込み権限確認
		if (!room_config["permission_write"]) {
			checkPermissionWrite(function(){
				if (room_config["permission_write"]) {
					SendChat();
				} else {
					showToast("書き込み権限がありません。");
				}
			});
			return;
		}
		
		//appendを見つけたら処理
		var _chatinput = $("#chatinput").html();
		
		if (_chatinput == '<div class="placehold" style="color:gray;user-select:none;pointer-events: none;">メッセージを入力...</div>') return;
		
		var promises = [];
		var _appends = $(".chatinput_append .appenditem");
		var _cnt = 0;
		var _found = false;
		if (_appends.length > 0) {
			for (var i=0; i<_appends.length; i++) {
				console.log("appendview: ", _appends.eq(i).attr("data-type"), _appends.eq(i));
				if (_appends.eq(i).attr("data-type") == "image") {
					var _src = _appends.eq(i).find(".img").attr("src");
					console.log("_src: ", _src);
					if (_src.indexOf("data:") === 0) {
						_cnt ++;
						promises.push(new Promise((r, reject) => {
							var _file = dataURLtoFile("screenshot"+_cnt, _src);
							uploadFile(
								[_file], 
							function(err, fdata){
								if (err) {
									r();
									return;
								}
								r({"type": "link", "url": fdata.url});
							});
						}));
					} else if (_src.indexOf("http://") === 0 || _src.indexOf("https://") === 0) {
						promises.push(new Promise((r, reject) => {
							r({"type": "link", "url": _src});
						}));
					}
				} else if (_appends.eq(i).attr("data-type") == "link") {
					var _src = _appends.eq(i).attr("data-url");
					promises.push(new Promise((r, reject) => {
						r({"type": "link", "url": _src});
					}));
				}
				
				_found = true;
				_appends.eq(i).remove();
			}
		}
		
		//var _sendchat = $("#chatinput").html();
		var _sendchat = "";
		$("#chatinput").contents().each(function(i, o){
			if ($(o).prop("tagName") == "DIV" || $(o).prop("tagName") == "P") {
				if (_sendchat) {
					_sendchat += "\n";
				}
			}
			_sendchat += $(o).text();
		});
		
		console.log("_sendchat: ", _sendchat);
		
		_sendchat = _sendchat.split("<br>").join("\n");
		
		//_sendchat = _sendchat.split("\t").join("");
		if (_sendchat.indexOf("\n") === 0) _sendchat = _sendchat.substr("\n".length);
		if (_sendchat.indexOf("\n") === _sendchat.length - "\n".length) _sendchat = _sendchat.substr(0, _sendchat.length - "\n".length);
		
		if (!_found && _sendchat == "") return false;
		last_chatinput = _chatinput;
		updateChatinput("");
		
		Promise.all(promises).then((results) => {
			var _senddata = {
				"type": "chat",
				"msg": _sendchat
			};
				
			//append追加
			for (var i=0; i<results.length; i++) {
				if (results[i]) {
					if (!_senddata["append"]) {
						_senddata["append"] = [];
					}
					_senddata["append"].push(results[i]);
				}
			}
			
			//モード追加
			if (chatinput_mode) {
				_senddata["mode"] = chatinput_mode;
			}
			
			SendChatNow(_senddata);
			
			setTimeout(function(){
				updateChatinput("");
				SendChatProgress(false);
				
				closeEmotion();
			}, 10);
		});
	}
		var cntRetry_SendChatNow = 0;
		function SendChatNow(_data) {
			if (!_data) return;
			
			//書き込み権限確認
			if (!room_config["permission_write"]) {
				checkPermissionWrite(function(){
					if (room_config["permission_write"]) {
						SendChatNow(_data);
					} else {
						showToast("書き込み権限がありません。");
					}
				});
				return;
			}
			
			SendChatProgress(false);
			
			var _profile = "";
			if ($("#user_id").val()) {
				_profile += "&profile_name="+encodeURIComponent($("#user_id").val());
			}
			if ($("#user_password").val()) {
				_profile += "&profile_trip="+encodeURIComponent($("#user_password").val());
			}
			if ($("#user_color").val()) {
				_profile += "&profile_color="+encodeURIComponent($("#user_color").val());
			}
			
		    $.ajax({
		        url:"room.php",
		        type:'POST',
		        data:"action=sendData&hash=cwp573h6"+_profile+"&data="+encodeURIComponent(JSON.stringify(_data))+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
		        dataType: "json"
		    }).done(function(data){
		    	if (data["result"] == "OK") {
					resetChatinputMode();
				    cntRetry_SendChatNow = 0;
				    return;
				} else if (data["reason"] == "write_permission" && cntRetry_SendChatNow <= 0) {
					cntRetry_SendChatNow ++;
					checkPermissionWrite(function(){
						SendChatNow(_data);
					});
					return;
		    	} else if (data["msg"]) {
		    		showToast(data["msg"]);
		    	} else {
		    		showToast("システムエラーが発生しました。再度お試しください。");
		    	}
		    	
		    	updateChatinput(last_chatinput);
	 	    }).fail(function(){
		    	showToast("ネットワークエラーが発生しました。再度お試しください。");
		    	
		    	updateChatinput(last_chatinput);
		    });
		}
	
	var timer_SendChatProgress = false;
	function SendChatProgress(_state) {
		var _message = "";
		if (_state) {
			if (parseInt(room_config["progress_write"]) == 1) {
				_message = $("#chatinput").text();
				if (_message.length > 128) {
					_message = _message.slice(128);
				}
			} else {
				if (timer_SendChatProgress) {
					return;
				}
				timer_SendChatProgress = setTimeout(function(){
					timer_SendChatProgress = false;
					SendChatProgress(true);
				}, 250);
			}
		} else {
			if (timer_SendChatProgress) {
				clearTimeout(timer_SendChatProgress);
				timer_SendChatProgress = false;
			}
		}
		
		SocketSend("@"+JSON.stringify({
	        type: "chat_progress",
	        state: _state,
	        message: _message
	    }));
	}
	
	function updateChatinput(_msg) {
		$("#chatinput").html(_msg);
		windowResize();
	}
	
	function showToast(_msg) {
		$("#area_toast .msg").html(_msg);
		$("#area_toast").toast('show');
	}
	
	var last_num = 0;
	var fetchLock = false;
	function fetchData(_query, _callback) {
		
		var fetchMode = "log";
		var fetchType = "last";
		var _addparam = "";
		if (_query) {
			if (_query["mode"]) {
				fetchMode = _query["mode"];
			}
			if (_query["type"]) {
				fetchType = _query["type"];
			}
			
			if (data_chatlog[fetchMode]["nums"].length > 0) {
				if (fetchType == "new") {
					sortDESC(data_chatlog[fetchMode]["nums"]);
					_query["num"] = data_chatlog[fetchMode]["nums"][0];
					
					$(".area_loader").css("display", "");
				} else if (fetchType == "old") {
					sortASC(data_chatlog[fetchMode]["nums"]);
					_query["num"] = data_chatlog[fetchMode]["nums"][0];
					
					$(".area_loader").css("display", "");
					
					//現在の最も若いNum
					if (!fetchLock) {
						fetchLock = _query["num"];
					}
				}
			}
			if (!_query["num"]) {
				if (fetchMode == "log" && fetchType == "last") {
					if (_query && _query["clean"]) {
						_query["num"] = "0";
					} else {
						_query["num"] = last_num;
					}
				} else {
					_query["num"] = "0";
				}
			}
			
			_addparam += "&mode="+encodeURIComponent(fetchMode)+"&type="+encodeURIComponent(fetchType)+"&num="+encodeURIComponent(_query["num"]);
			
			if (fetchMode == "search") {
				_addparam += "&q="+encodeURIComponent($("#search_q").val());
			}
		} else {
			_addparam += "&mode=log&type=last&num="+encodeURIComponent(last_num);
		}
		
	    $.ajax({
	        url:"room.php",
	        type:'POST',
	        data:"action=fetchData&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc"+_addparam,
	        dataType: "json"
	    }).done(function(data){
	    	var __fetchDataStartTime = (new Date()).getTime();
	    	
	    	if (data["result"] == "OK") {
	    		if (_query && _query["clean"]) {
	    			cleanChatLog(fetchMode);
	    		}
	    		
	    		if (_callback) {
	    			_callback(false, data);
	    			$(".area_loader").css("display", "none");
	    			return;
	    		}
	    		
	    		if (data["old_over"]) {
	    			data_chatlog[fetchMode]["over"]["old"] = true;
	    		}
	    		if (data["new_over"]) {
	    			data_chatlog[fetchMode]["over"]["new"] = true;
	    		}
			    
			    AddChatArray("batch-init", false, fetchMode, fetchType);
			    for (var i in data["data_list"]) {
			    	parseData(data["data_list"][i]["num"], data["data_list"][i]["data"], fetchMode, fetchType);
			    }
			    AddChatArray("batch-finish", false, fetchMode, fetchType);
			    
			    if (fetchType == "old") {
					//保存した最も若いNumにスクロール(iOSだけ)
					if (isSafari) {
						if (fetchLock) {
							$("#area_chatlog_"+fetchMode+"_master").scrollTop( $("#area_chatlog_"+fetchMode+"_master").scrollTop() + $("#area_chatlog_"+fetchMode+" .chatitem_"+fetchLock).position().top );
							setTimeout(function(){
								$("#area_chatlog_"+fetchMode+"_master").scrollTop( $("#area_chatlog_"+fetchMode+"_master").scrollTop() + $("#area_chatlog_"+fetchMode+" .chatitem_"+fetchLock).position().top );
								fetchLock = false;
							}, 500);
						}
					} else {
						fetchLock = false;
					}
			    }
			    
			    //読み込み完了
			    if (data_chatlog[fetchMode]["requestFirstScroll"]) {
			    	setTimeout(function(){
			    		ChatScrollLast();
			    		data_chatlog[fetchMode]["requestFirstScroll"] = false;
			    	}, 100);
			    }
			    $(".area_loader").css("display", "none");
			    
			    console.log("fetchData: parseData: proctime: "+((new Date()).getTime() - __fetchDataStartTime)+" ms");
			    
			    if (_query && _query["clean"]) {
			    	console.log("fetchData: clean: ChatScrollLast call");
			    	ChatScrollLast(true);
			    }
			    
			    return;
	    	} else {
	    		if (_callback) {
	    			_callback("システムエラーが発生しました。");
	    			fetchLock = false;
	    			return;
	    		}
	    	}
 	    }).fail(function(e){
	    	if (_callback) {
	    		_callback("ネットワークエラーが発生しました。");
	    		fetchLock = false;
	    		return;
	    	}
	    });
	}
	
		function parseData(num, data, fetchMode, fetchType) {
			num = parseInt(num);
			
			console.log("parseData: ", num, data, fetchMode, fetchType);
			
			//重複データをキャンセル
			if (data_chatlog[fetchMode]["logs"][num] && fetchType != "edit" && fetchType != "edit-only-fetched") return;
			
	  		try {
	  			if (!isObject(data)) {
	  				data = JSON.parse(data);
	  			}
	  			if (data["type"] == "chat") {
	  				
	  				if (fetchType == "last" || fetchType == "edit-only-fetched") {
	  					if (fetchType == "last") {
		  					if (visibleWindow) {
		  						sendMessagePush({"action": "addSkipDataId", "data_id": "cwp573h6--"+num});
		  					}
	  					}
	  					
	  					if (!data_chatlog[fetchMode]["requestFirstScroll"] && (!data["only"] || data["only-fetched"])) {
	  						
	  						//console.error("新規: ", data, fetchMode, fetchType);
	  						
		  					if (data["userid"] && data["userid"] != "4ab76") { //自分以外
		  						
		  						//新着サウンド
		  						var _c = loadCookieConfig("config_sound_newmessage", "");
		  						if (_c == "on" || (_c == "on-background" && !visibleWindow)) {
									playSound("newmessage.mp3");
								}
							}
							
							//新着読み上げ
							var _c = loadCookieConfig("config_softalk", "");
							if (_c == "on") {
								var _msg = "";
								if (loadCookieConfig("config_softalk_name", "") == "on") {
									var _tmp = data["name"].split("#");
									var _name = _tmp[0];
									if (_name.length > 10) {
										_name = ""+_name.substr(0,10);
									}
									_msg = _name + _msg;
								}
								_msg += " "+data["msg"];
								addSoftalkQueue(_msg);
							}
						}
		  				
		  				if (fetchType == "last") {
		  					if (data_chatlog[fetchMode]["over"]["new"]) {
		  						return; //過去にスクロールして最新をカットしている場合は新着を無視
		  					}
	  					}
	  				}
	  				
	  				AddChatArray("data", [{"num": num, "data": data}], fetchMode, fetchType);

				    if (fetchMode == "log" && (fetchType == "last" || fetchType == "edit-only-fetched")) {
				    	
			    		if (last_num < num && !last_item_hidden) {
			    			last_num = num;
			    			
							//最新読み込み
							console.log("parseData: ChatScrollLast call");
							ChatScrollLast(false, fetchMode);
							
							if (!visibleWindow && !data_chatlog[fetchMode]["requestFirstScroll"]) {
								addUnreadCount(1);
							}
							
							//新着通知
							if (!data_chatlog[fetchMode]["scroll_magnet_bottom"] && !data_chatlog[fetchMode]["requestFirstScroll"]) {
								$("#area_chatlog_"+fetchMode+"_master .scroll_magnet_bottom .inner").animate({
									borderColor: "#FF0000",
									backgroundColor: "rgba(255,0,0,0.2)"
								}, 300);
							}
			    		}
		    		}
	  				
	  			}
	  		} catch(e) {
	  			console.error("data parse error: ", e);
	  		}
		}
		
var softalk_buffer = [];
var timer_softalktimeout = false;
function addSoftalkQueue(_msg, _force) {
	var _c = loadCookieConfig("config_softalk", "");
	if (_c != "on" && !_force) {
		return;
	}
	
	if (_force) {
		softalk_buffer = [];
	}
	
	_msg = _msg.replace(/(<([^>]+)>)/ig,"");
	
	var _cutoff = loadCookieConfig("config_softalk_cutoff", "");
	var _cutoff_bytes = 52;
	if (_cutoff == "short") {
		_cutoff_bytes = 25;
	} else if (_cutoff == "long") {
		_cutoff_bytes = 104;
	} else if (_cutoff == "off") {
		_cutoff_bytes = 1024;
	}
	
	if (_msg.length > _cutoff_bytes) {
		_msg = ""+_msg.substr(0,_cutoff_bytes)+"、いかりゃく";
	}
	
	softalk_buffer.push(""+_msg);
}

	var dummyClickFlag = false;
	function dummyClickIfNeeded(_force) {
		if (dummyClickFlag) return;
		
		if (!_force) {
			var _c = loadCookieConfig("config_softalk", "");
			if (_c != "on") {
				return;
			}
		}
		
		document.addEventListener('click', dummyClick);
	}
	    function dummyClick() {
	    	//ダミー読み上げ
			var speechSynthesis = window.speechSynthesis;
			var utterance = new SpeechSynthesisUtterance('');
			speechSynthesis.speak(utterance);
				
			document.removeEventListener('click', dummyClick);
			dummyClickFlag = true;
	    }
    $(function(){
    	dummyClickIfNeeded();
    });

	var softalk_lock = false;
	var timeout_SoftalkCheck = false;
	function checkSoftalk() {
		if (!dummyClickFlag) {
			softalk_buffer = [];
			return;
		}
		if (softalk_lock) return;
		if (softalk_buffer.length <= 0) return;
		
		softalk_lock = true;
		
		var _tarfile = softalk_buffer.shift();
		if (softalk_native || softalk_voice) {
			//ネイティブ読み上げ機能
			var speech = new SpeechSynthesisUtterance(""+_tarfile);
			if (!softalk_voice) {
				nextSoftalk();
				return;
			}
			speech.onerror = function(e) {
				console.error("checkSoftalk: ", e);
				nextSoftalk();
			}
			speech.onend = function(e) {
				console.log("checkSoftalk(): speech.onend: ", e);
				nextSoftalk();
			}
			speech.voice = softalk_voice;
			speech.lang = "ja-JP";
			
			//var _pitch = parseFloat(""+GetConfig("softalk_pitch"));
			//if (_pitch) {
			//	speech.pitch = _pitch;
			//} else {
				speech.pitch = 1.2;
			//}
			
			var _rate = parseFloat(loadCookieConfig("config_softalk_speed", "1.2"));
			if (_rate) {
				speech.rate = _rate;
			} else {
				speech.rate  = 1.2;
			}
			
			var _volume = Number(loadCookieConfig("config_softalk_volume", "50"));
			if (_volume) {
				speech.volume = _volume / 100;
			} else {
				speech.volume  = 0.5;
			}
			
			//console.log("checkSoftalk: speechSynthesis: "+_pitch+" / "+_rate+" / "+_volume);
			
			speechSynthesis.cancel();
			speechSynthesis.speak(speech);
		} else {
			//ネットワーク読み上げ機能
			
			var _rate = parseFloat(loadCookieConfig("config_softalk_speed", "1.2"));
			if (!_rate) {
				_rate = 1.0;
			}
			
			var audio = new Audio();
			audio.src = "https://comment-fcs-cdn.erinn.biz/speechserver/?q="+encodeURIComponent(_tarfile)+"&rate="+_rate;
			
            audio.addEventListener("error",function(e){
				console.e("checkSoftalk():", e);
				audio = false;
				nextSoftalk();
            });
            
            audio.addEventListener("ended",function(e){
				console.log("checkSoftalk(): audio.onend: ", e);
				audio = false;
				nextSoftalk();
            });

			var _volume = Number(loadCookieConfig("config_softalk_volume", "50"));

			if (_volume) {
				audio.volume = parseFloat(parseFloat(_volume) / parseFloat(100.0));
			} else {
				audio.volume  = 0.5;
			}

			audio.play();
		}
		
		if (timeout_SoftalkCheck) clearTimeout(timeout_SoftalkCheck);
		timeout_SoftalkCheck = setTimeout(nextSoftalk, 1000*30);
	}
	
		function nextSoftalk() {
			softalk_lock = false;
			
			if (timeout_SoftalkCheck) clearTimeout(timeout_SoftalkCheck);
			timeout_SoftalkCheck = false;
		}
	
	var softalk_native = false;
	var softalk_voice = false;
	function getSoftalkVoice() {
		try {
			var _voicelist = speechSynthesis.getVoices();
			for (var i in _voicelist) {
				console.log("getvoice: ", _voicelist[i].name, _voicelist[i].lang);
				if ((_voicelist[i].name).indexOf("日本語") != -1) {
					softalk_voice = _voicelist[i];
					break;
				}
			}
			if (!softalk_voice) {
				for (var i in _voicelist) {
					if (_voicelist[i].lang.toLowerCase().indexOf("ja") === 0) {
						softalk_voice = _voicelist[i];
						break;
					}
				}
			}
		} catch(e) {
			console.log("getSoftalkVoice: "+e);
		}
		if (!softalk_voice) {
			setTimeout(getSoftalkVoice, 1000);
		}
		
		return softalk_voice;
	}
	//softalk_native = true;
	setInterval(checkSoftalk, 100);
	getSoftalkVoice();

	//接続
	var hostaddr = "";
	var hostport_ws = 0;
	var ws;
	var ws_init = false;
	var ws_timeout = 0;
	var ws_destory = false;
	var ws_connect = false;
	function wsConnect() {
		console.log("wsConnect()");
		
		if (ws_destory) return;
		if (ws_connect) return;
		
		ws_init = true;
		ws_timeout = 0;
		
		console.log("wsConnect(): WebSocket connect: "+hostaddr+":"+hostport_ws);
		
		ws = new WebSocket("wss://"+hostaddr+":"+hostport_ws);
		AddLog("...", "system");

		ws.onopen = function(){
			ws_connect = true;
			ws_timeout = 0;
			console.log("socket connect");
		    
		    AddLog("参加中...", "system");
		    
			SocketSend("@"+JSON.stringify({
	            "type": "join",
	            "room": "cwp573h6",
	            "cookie_token": "mG/5kC8XqwXDac0po5Yi2XYScuYfiXC6O5t2VJHzTxQQZfG7+INdAgHpCILsGLKd2EXii9sSwcnaLj85F/3lww==",
	            "name": "もやし猫@管理者だよ#dbec"
	        }));
	        	
		};

		//データ受信
		ws.onmessage = function(e){
			ws_timeout = 0;
			
			DataRecv(e.data);
		};

		ws.onclose = function(){
			console.log("WebSocket: onclose");
			
		    ws_connect = false;
		    wsDisconnectClean();
		    
		    AddLog("切断しました。再接続しています...", "error");
		    
		   	wsCloseAndRetry();
		};

		ws.onerror = function(){
			console.log("WebSocket: onerror");
		};
	}

	function wsDisconnectClean() {
		//buffer_userid = new Array();
		//buffer_myid = new Array();
	}

	var ws_retry = false;
	function wsCloseAndRetry() {
		if (ws_destory) {
			console.log("wsCloseAndRetry(): ws_destory=true");
			return;
		}
		
		console.log("wsCloseAndRetry(): ws_destory=false");
		
		ws_connect = false;
		if (ws) {
			try {
				ws.close();
			} catch(e) {
			}
		}
		ws = null;
		
		if (ws_retry) { clearTimeout(ws_retry); }
	    ws_retry = setTimeout(function(){
			refreshRoomConfig(function(){
				wsConnect();
			});
	    }, 1000);
	}

	function wsCheckTimeout() {
		if (ws_destory) {
			console.log("wsCheckTimeout(): ws_destory=true");
			return;
		}
		if (!ws_init) {
			console.log("wsCheckTimeout(): ws_init=false");
			return;
		}
		
		ws_timeout ++;
		if (ws_timeout >= 5) {
			console.log("wsCheckTimeout(): Timeout!");
			
			ws_timeout = 0;
			
			wsCloseAndRetry();
		} else {
			//console.log("wsCheckTimeout(): ws_timeout: "+ws_timeout+"s");
		}
	}
	setInterval(wsCheckTimeout, 1000);

		//データ受信実体
		var cnt_roommember = 0;
		var cnt_chat_progress = 0;
		var old_chat_progress_message = false;
		function DataRecv(msg) {
		    if (!msg) return;
		    
		    console.log("DataRecv: "+msg);
		    
		    if (msg.indexOf('@') > -1) {
		    	
		  	  	var recdata = JSON.parse(msg.substring(1,msg.length));
		  	  	if (recdata.type == "join_complete") {
		  	  		cnt_roommember = recdata.user;
		  	  		updateMemberStatus();
		  	  		fetchData();
		  	  		
		  	  		//pollingServer("join", {"type": "join", "cnt_user": cnt_roommember});
		  	  		
		  	  	} else if (recdata.type == "join_failed") {
		  	  		showToast("閲覧権限がありません。");
		  	  		if (recdata.reason == "banned") {
		  	  			location.href = "./";
		  	  		} else {
		  	  			setTimeout(function(){location.reload();}, getRandomInt(1000,6000));
		  	  		}
		  	  	} else if (recdata.type == "chat_progress") {
		  	  		cnt_chat_progress = recdata.cnt;
		  	  		updateMemberStatus();
		  	  		
		  	  		if (old_chat_progress_message != recdata.messages) {
			  	  		if (recdata.messages) {
			  	  			var _messages = "";
			  	  			for (var i in recdata.messages) {
			  	  				if (!recdata.messages[i]) continue;
			  	  				_messages += "<span style='padding-right:10px;'>"+recdata.messages[i]+"</span>";
			  	  			}
			  	  			if (_messages != "") {
			  	  				$(".area_chatlog_progress > .data").html(_messages);
			  	  				$(".area_chatlog_progress").css("display", "block");
			  	  				windowResize();
			  	  			} else {
			  	  				$(".area_chatlog_progress").css("display", "none");
			  	  				windowResize();
			  	  			}
			  	  		} else {
			  	  			$(".area_chatlog_progress > .data").html();
			  	  			windowResize();
			  	  		}
		  	  		}
		  	  		old_chat_progress_message = recdata.messages;
		  	  	} else if (recdata.type == "data") {
		  	  		parseData(recdata.num, recdata.data, "log", "last");
		  	  	} else if (recdata.type == "delete") {
		  	  		if (recdata.nums && recdata.nums.length >= 1) {
			  	  		for (var i=0; i<recdata.nums.length; i++) {
			  	  			$(".chatitem_"+recdata.nums[i]).remove();
			  	  			
							if (cache_fixed_message && cache_fixed_message["num"] == recdata.nums[i]) {
								cache_fixed_message = false;
								$(".area_chatlog_fixed").css("display", "none");
								windowResize();
							}
			  	  		}
		  	  		}
		  	  	} else if (recdata.type == "edit") {
		  	  		if (recdata.num && recdata.data) {
			  	  		parseData(recdata.num, recdata.data, "log", "edit");
		  	  		}
		  	  	} else if (recdata.type == "fixed") {
		  	  		refreshRoomConfig();
		  	  	} else if (recdata.type == "polling") {
		  	  		cnt_roommember = recdata.user;
		  	  		updateMemberStatus();
		  	  		
					SocketSend("@"+JSON.stringify({
				        type: "polling"
				    }));
				    	
				    //pollingServer("polling", {"type": "polling", "cnt_user": cnt_roommember}, 60*1000);
		  	  	} else if (recdata.type == "del_user") {
		  	  		cnt_roommember -= 1;
		  	  		updateMemberStatus();
		  	  	} else if (recdata.type == "join_user") {
		  	  		cnt_roommember += 1;
		  	  		updateMemberStatus();
		  	  		
		  	  		if (recdata.newuser == 1) {
			  	  		var _c = loadCookieConfig("config_sound_newuser", "");
						if (_c == "on" || (_c == "on-background" && !visibleWindow)) {
							playSound("newuser.mp3");
						}
					}
		  	  	} else if (recdata.type == "error") {
		  	  		showToast("システムエラーが発生しました。再度お試しください。");
		  	  		//if (recdata.num && history_sendmsg[""+recdata.num]) {
		  	  		//	updateChatinput(history_sendmsg[""+recdata.num]);
		  	  		//}
		  	  	} else if (recdata.type == "request_emotion_update") {
		  	  		emotion_cache = false;
		  	  	} else if (recdata.type == "vcam") {
		  	  		vcamKeepaliveUpdate(recdata.sender_id);
		  	  		
		  	  		if ($(".vcam_"+recdata.sender_id+"_master").length <= 0) {
			  	  		var _html = "";
			  	  		_html += "<div class='vcam_"+recdata.sender_id+"_master vcam_remote_master vcam_master' data-sender_id='"+recdata.sender_id+"' style='position:relative;height:100%;'>";
			  	  		_html += "	<video class='vcam_"+recdata.sender_id+"' style='height:100%;max-width:100%;min-width:280px;'></video>";
			  	  		_html += "	<div class='info'></div>";
			  	  		_html += "	<div class='control-master' style='display:none;'>";
			  	  		_html += "    <div class='control flex-right'>";
			  	  		_html += "      <div style='padding-top:11px;'><input class='volume' type='range' value='100' step='1' min='0' max='100' style='max-width:100px;min-width:80px;'></div>";
			  	  		_html += "      <div><img class='icon_mute vcam_icon' src='img/icon_mute.png'></div>";
			  	  		_html += "      <div><img class='icon_fullscreen vcam_icon' src='img/icon_fullscreen.png'></div>";
			  	  		_html += "      <div><img class='icon_pip vcam_icon' src='img/icon_popup.png'></div>";
			  	  		_html += "    </div>";
			  	  		_html += "  </div>";
			  	  		_html += "	<div class='unmute'><div>タップでミュート解除</div></div>";
			  	  		_html += "	<div class='audioonly' style='display:none;'><div><img src='img/icon_vmute.png' width='30'><div class='name'></div>音声のみ</div></div>";
			  	  		_html += "</div>";
						$("#area_chatlog_live_master .lives").append(_html);
						
						if (!recdata.status["video"]) {
							$(".vcam_"+recdata.sender_id+"_master .audioonly").css("display", "block");
						}
						$(".vcam_"+recdata.sender_id+"_master .unmute").bind("click", function(){
							vcamUnmuteFirst();
						});
						
						$(".vcam_"+recdata.sender_id+"_master .icon_mute").bind("click", function(e){
							var _sender_id = getSenderIdByEvent(e);
							vcamToggleMute(_sender_id);
						});
						
						$(".vcam_"+recdata.sender_id+"_master .icon_pip").bind("click", function(e){
							var _sender_id = getSenderIdByEvent(e);
							$(".vcam_"+_sender_id).get(0).requestPictureInPicture();
						});
						
						$(".vcam_"+recdata.sender_id+"_master .icon_fullscreen").bind("click", function(e){
							if (fullscreen) {
								cancelFullscreenFix();
								return;
							}
							
							var _sender_id = getSenderIdByEvent(e);
							requestFullscreenFix($(".vcam_"+_sender_id+"_master").get(0));
						});
						
						$(".vcam_"+recdata.sender_id+"_master .volume").bind("input", function(e){
							var _sender_id = getSenderIdByEvent(e);
							var _vol = e.target.value / 100;
							$(".vcam_"+_sender_id).get(0).volume = _vol;
							return false;
						});
						
						$(".vcam_"+recdata.sender_id+"_master").bind("click mouseover", function(e){
							vcamControlShow();
						});
						vcamControlShow();
						
						$(".area_chatlog_live").css("display", "block");
						
						closeFixedMessage();
						windowResize();
						
						//既に他があり他もすべてミュート中の場合はミュートで作成
						var _foundunmute = false;
						var _foundmute = false;
						for (var i in vcamKeepaliveBuffer) {
							if (i == recdata.sender_id) continue;
							if ($(".vcam_"+i).get(0).muted != true) {
								_foundunmute = true;
								break;
							} else {
								_foundmute = true;
							}
						}
						var _mute = false;
						if ((!_foundunmute && _foundmute && first_unmute) || manualallmute) {
							_mute = true;
						}
						
						vcamRecv(
							{"removeVideo": ".vcam_"+recdata.sender_id, "sender_id": recdata.sender_id, "mute": _mute}, 
							function(_res){
								console.log("vcamRecv: res: ", _res);
								
								playSound("enter.mp3");
								
								windowResize();
								setTimeout(function(){
									windowResize();
								}, 250);
								
								if (_res["mute"] && !_res["mute-manual"]) {
									$(".vcam_"+recdata.sender_id+"_master .unmute").css("display", "block");
								} else {
									$(".vcam_"+recdata.sender_id+"_master .unmute").remove();
									$(".vcam_"+recdata.sender_id+"_master .control-master").css("display", "block");
									first_unmute = true;
								}
								vcamUpdateMute(recdata.sender_id);
							},
							function(err){
								console.log("vcamRecv停止(error="+err+"): ", recdata.sender_id);
								$(".vcam_"+recdata.sender_id+"_master").remove();
								
								if (!err) {
									playSound("leave.mp3");
								}
							}
						);
					}
					
					var _html = "";
					_html += ""+safestr(recdata.name);
					if (recdata.status["audio"]) {
						_html += " <img src='img/icon_unmute.png' width='20'>";
					} else {
						_html += " <img src='img/icon_mute.png' width='20'>";
					}
					if (recdata.status["video"]) {
						$(".vcam_"+recdata.sender_id+"_master .audioonly").css("display", "none");
					} else {
						_html += " <img src='img/icon_vmute.png' width='20'>";
						$(".vcam_"+recdata.sender_id+"_master .audioonly").css("display", "block");
					}
					if ($(".vcam_"+recdata.sender_id+"_master .info").attr("data-html") != _html) {
						$(".vcam_"+recdata.sender_id+"_master .info").attr("data-html", _html);
						$(".vcam_"+recdata.sender_id+"_master .info").html(_html);
						$(".vcam_"+recdata.sender_id+"_master .name").html(safestr(recdata.name));
						windowResize();
					}
		  	  	}
		    	
		    }
		}
		
		var pollingServerInterval = {};
		function pollingServer(_type, _config, _interval) {
			if (_interval) {
				if (pollingServerInterval[_type]) {
					if ( (new Date()).getTime() < pollingServerInterval[_type] ) {
						console.log("pollingServer("+_type+"): Interval Skip");
						return;
					}
				} else {
					pollingServerInterval[_type] = (new Date()).getTime() + _interval;
				}
			}
			
			console.log("pollingServer("+_type+"): Exec");
			
			var _param = "action=pollingServer&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc";
			
			//if (_type == "join") {
			//	_param += "&type=join&cnt_user="+encodeURIComponent(_config["cnt_user"]);
			//} else if (_type == "polling") {
			//	_param += "&type=polling&cnt_user="+encodeURIComponent(_config["cnt_user"]);
			//} else if (_type == "vcam") {
			if (_type == "vcam") {
				_param += "&type=vcam&sender_id="+encodeURIComponent(_config["sender_id"])+"&name="+encodeURIComponent(_config["name"])+"&name_enc="+encodeURIComponent(_config["name_enc"])+"&status="+encodeURIComponent(JSON.stringify(_config["status"]));
			} else {
				return;
			}
			
		    $.ajax({
		        url:"room.php",
		        type:'POST',
		        data:_param,
		        dataType: "json"
		    }).done(function(data){
	 	    }).fail(function(e){
		    });
		}
		
			function getSenderIdByEvent(e) {
				var _sender_id = "";
				if ($(e.currentTarget).hasClass("vcam_master")) {
					_sender_id = $(e.currentTarget).attr("data-sender_id");
				} else {
					_sender_id = $(e.currentTarget).closest('.vcam_master').attr("data-sender_id");
				}
				return _sender_id;
			}
		
			function requestFullscreenFix(target) {
				fullscreen = target;
				if (target.webkitRequestFullscreen) {
					target.webkitRequestFullscreen(); //Chrome15+, Safari5.1+, Opera15+
				} else if (target.mozRequestFullScreen) {
					target.mozRequestFullScreen(); //FF10+
				} else if (target.msRequestFullscreen) {
					target.msRequestFullscreen(); //IE11+
				} else if (target.requestFullscreen) {
					target.requestFullscreen(); // HTML5 Fullscreen API仕様
				} else {
					return;
				}
			}
			function cancelFullscreenFix() {
				var target = fullscreen;
				if (target.webkitRequestFullscreen) {
					document.webkitCancelFullScreen(); //Chrome15+, Safari5.1+, Opera15+
				} else if (target.mozRequestFullScreen) {
					document.mozCancelFullScreen(); //FF10+
				} else if (target.msRequestFullscreen) {
					document.msExitFullscreen(); //IE11+
				} else if (target.requestFullscreen) {
					document.exitFullscreen(); // HTML5 Fullscreen API仕様
				} else {
					document.cancelFullScreen();
				}
			}
			var fullscreen = false;
			document.addEventListener("webkitfullscreenchange", handleFSevent, false);
			document.addEventListener("mozfullscreenchange", handleFSevent, false);
			document.addEventListener("MSFullscreenChange", handleFSevent, false);
			document.addEventListener("fullscreenchange", handleFSevent, false);
			function handleFSevent() {
				if (document.webkitFullscreenElement && document.webkitFullscreenElement !== null) {
					fullscreen = document.webkitFullscreenElement;
				} else if (document.mozFullScreenElement && document.mozFullScreenElement !== null) {
					fullscreen = document.mozFullScreenElement;
				} else if (document.msFullscreenElement && document.msFullscreenElement !== null) {
					fullscreen = document.msFullscreenElement;
				} else if (document.fullScreenElement && document.fullScreenElement !== null) {
					fullscreen = document.fullScreenElement;
				} else {
					fullscreen = false;
				}
			}
		
			var timeout_vcam_control = false;
			function vcamControlShow() {
				$(".vcam_remote_master .control").animate({
					opacity: 1.0
				}, 100 );
				$(".vcam_remote_master .info").animate({
					opacity: 1.0
				}, 100 );
					
					
				if (timeout_vcam_control) {
					clearTimeout(timeout_vcam_control);
				}
				timeout_vcam_control = setTimeout(function(){
					timeout_vcam_control = false;
					
					$(".vcam_remote_master .control").animate({
						opacity: 0.0
					}, 100 );
					$(".vcam_remote_master .info").animate({
						opacity: 0.0
					}, 100 );
						
				}, 3000);
			}
			
			var first_unmute = false;
			function vcamUnmuteFirst() {
				$(".vcam_remote_master .unmute").each(function(i, e){
					var _sender_id = $(e).closest('.vcam_master').attr("data-sender_id");
					
					$(".vcam_"+_sender_id+"").get(0).muted = false;
					first_unmute = true;
					
					$(".vcam_"+_sender_id+"_master .unmute").remove();
					$(".vcam_"+_sender_id+"_master .control-master").css("display", "block");
					
					vcamUpdateMute(_sender_id);
				});
			}
		
			function vcamToggleMute(_sender_id) {
				console.log("vcamToggleMute(): "+_sender_id);
				var _tar = $(".vcam_"+_sender_id).get(0);
				if (_tar.muted == true) {
					_tar.muted = false;
				} else {
					_tar.muted = true;
				}
				vcamUpdateMute(_sender_id);
			}
				function vcamUpdateMute(_sender_id) {
					if ($(".vcam_"+_sender_id).get(0).muted == true) {
						$(".vcam_"+_sender_id+"_master .icon_mute").attr("src", "img/icon_mute.png");
						$(".vcam_"+_sender_id+"_master .volume").css("display", "none");
					} else {
						$(".vcam_"+_sender_id+"_master .icon_mute").attr("src", "img/icon_unmute.png");
						$(".vcam_"+_sender_id+"_master .volume").css("display", "block");
					}
					
					var _foundunmute = false;
					for (var i in vcamKeepaliveBuffer) {
						if ($(".vcam_"+i).get(0).muted != true) {
							_foundunmute = true;
							break;
						}
					}
					if (_foundunmute) {
						$(".btn-allmute img").attr("src", "img/icon_unmute.png");
						manualallmute = false;
					} else {
						$(".btn-allmute img").attr("src", "img/icon_mute.png");
						manualallmute = true;
					}
				}
			
			var manualallmute = false;
			function toggleLiveAllMute() {
				var _foundunmute = false;
				var _found = false;
				for (var i in vcamKeepaliveBuffer) {
					_found = true;
					if ($(".vcam_"+i).get(0).muted != true) {
						_foundunmute = true;
						break;
					}
				}
				
				for (var i in vcamKeepaliveBuffer) {
					if (_foundunmute) {
						$(".vcam_"+i).get(0).muted = true;
					} else {
						$(".vcam_"+i).get(0).muted = false;
					}
					vcamUpdateMute(i);
				}
				if (!_found) {
					if (manualallmute) {
						manualallmute = false;
						$(".btn-allmute img").attr("src", "img/icon_unmute.png");
					} else {
						manualallmute = true;
						$(".btn-allmute img").attr("src", "img/icon_mute.png");
					}
				}
			}
		
			var vcamKeepaliveBuffer = {};
			function vcamKeepaliveUpdate(_sender_id) {
				vcamKeepaliveBuffer[_sender_id] = (new Date()).getTime();
			}
			
			function vcamKeepaliveCheck() {
				for (var i in vcamKeepaliveBuffer) {
					//if ((new Date()).getTime() - vcamKeepaliveBuffer[i] >= 1000*5) { //5secタイムアウト
					if ($(".vcam_"+i+"_master").length > 0) {
						vcamKeepaliveBuffer[i] = (new Date()).getTime();
						continue;
					}
					
					//ストリームが切れている(要素が削除済み)
					vcamRecvEnd(i);
					$(".vcam_"+i+"_master").remove();
				
					delete vcamKeepaliveBuffer[i];
					
					windowResize();
					break;
				}
				
				//なし
				if (Object.keys(vcamKeepaliveBuffer).length <= 0 && !vcamLocalID) {
					if ($(".area_chatlog_live").css("display") != "none") {
						$(".button_restore_live").css("display", "none");
						$(".area_chatlog_live").css("display", "none");
						windowResize();
					}
					return;
				}
				
				//あり
				if ($(".area_chatlog_live").css("display") == "none") {
					$(".button_restore_live").css("display", "block");
				} else {
					$(".button_restore_live").css("display", "none");
				}
			}
		
			function updateMemberStatus() {
				var _msg = ""+cnt_roommember+"人が参加中";
				if (cnt_chat_progress > 0) {
					_msg += ", "+cnt_chat_progress+"人が入力中...";
				} else {
					$(".area_chatlog_progress").css("display", "none");
					$(".area_chatlog_progress > .data").html();
				}
				
				if (owner) {
					_msg = "<a href='javascript:void(openMembers());'>"+_msg+"</a>";
				}
				
				AddLog(_msg, "system");
			}


	function SocketSend(_data) {
		ws.send(_data);
	}

	var data_chatlog = {
		"log": {},
		"pinned": {},
		"search": {}
	};
	var MAX_LOG = 500;
	
	function cleanChatLog(_mode) {
		data_chatlog[_mode] = {
			"over": {"old": false, "new": false},
			"scroll_magnet_bottom": true,
			"requestFirstScroll": true,
			"logs": {},
			"nums": []
		};
		
		$("#area_chatlog_"+_mode).html("");
	}
	function initChatLog() {
		cleanChatLog("log");
		cleanChatLog("pinned");
		cleanChatLog("search");
	}
	
	function AddChat(_num, _data, fetchMode, fetchType) {
		AddChatArray("data", [{"num": _num, "data": _data}], fetchMode, fetchType);
	}
	
		var AddChatArrayBuffer = {
			"batch-init": false,
			"scroll": {},
			"chat_item_html": ""
		};
		function AddChatArray(_seq, _datas, fetchMode, fetchType) {
			console.log("AddChatArray: seq: "+_seq, "batch: "+AddChatArrayBuffer["batch-init"], _datas, AddChatArrayBuffer);
			
			if (_seq == "batch-init" || !AddChatArrayBuffer["batch-init"]) {
				if (_seq == "batch-init") {
					AddChatArrayBuffer["batch-init"] = true;
				}
					
				AddChatArrayBuffer["scroll"] = {"type": "none"};
				if ((fetchType == "last" || fetchType == "edit-only-fetched") && getChatlogScroll(fetchMode, "bottom", "px") <= 80) {
					AddChatArrayBuffer["scroll"] = {"type": "last"};
				} else if (fetchType == "old" && getChatlogScroll(fetchMode, "top", "percent") <= 0) {
					$("#area_chatlog_"+fetchMode+"_master").scrollTop( 5 );
				}
				console.log("AddChatArray(): scroll: ", AddChatArrayBuffer["scroll"]);
			}

			if (_seq == "data") {
				for (var i=0; i<_datas.length; i++) {
					var _num = parseInt(_datas[i]["num"]);
					var _data = _datas[i]["data"];
					
					if (fetchType == "edit") {
						if (_data["only"] == "only-owner" && !_data["only-fetched"]) {
							_data["only-request-data"] = true;
						}
					}
					
					if (mute_userid && _data && _data["userid"] && !_datas[i]["me"]) {
						if (mute_userid[_data["userid"]] && mute_userid[_data["userid"]]["hash"] == "cwp573h6") continue;
					}
					
					var _html = genChatItemHTML(_num, _data);
					
					if (fetchType == "edit" || fetchType == "edit-only-fetched") {
						$(".chatitem_"+_num).replaceWith(_html);
					} else if ($("#area_chatlog_"+fetchMode+" .chatitem_"+_num).length >= 1) {
						$("#area_chatlog_"+fetchMode+" .chatitem_"+_num).replaceWith(_html);
					} else {
						if (fetchType == "old") {
							AddChatArrayBuffer["chat_item_html"] = _html + AddChatArrayBuffer["chat_item_html"];
						} else {
							AddChatArrayBuffer["chat_item_html"] = AddChatArrayBuffer["chat_item_html"] + _html;
						}
					}

					data_chatlog[fetchMode]["logs"][_num] = _data;
					if (data_chatlog[fetchMode]["nums"].indexOf(_num) == -1) {
						data_chatlog[fetchMode]["nums"].push(_num);
					}
				}
			}
			
			if (_seq == "batch-finish" || !AddChatArrayBuffer["batch-init"]) {
				console.log("AddChatArray: batch-finish: start");
				if (fetchType == "old") {
					$("#area_chatlog_"+fetchMode).prepend(AddChatArrayBuffer["chat_item_html"]);
				} else {
					$("#area_chatlog_"+fetchMode).append(AddChatArrayBuffer["chat_item_html"]);
				}
				
				AddChatArrayBuffer["chat_item_html"] = "";
				AddChatArrayBuffer["batch-init"] = false;
				
				shiftChatLog(fetchMode, fetchType);
				updateCardLoader(fetchMode);
				
				//新着
				if (AddChatArrayBuffer["scroll"]["type"] == "last") {
					console.log("batch-finish: ChatScrollLast call");
					ChatScrollLast(true, fetchMode);
				}
				
				console.log("AddChatArray: batch-finish: complete");
			}
		}
	
		function shiftChatLog(fetchMode, fetchType) {
			//最大件数を超えたら消込
			console.log("shiftChatLog(): chat_log.length: "+data_chatlog[fetchMode]["nums"].length);
			if (data_chatlog[fetchMode]["nums"].length >= MAX_LOG) {
				
				if (fetchType == "last" || fetchType == "new") {
					sortASC(data_chatlog[fetchMode]["nums"]);
				} else {
					sortDESC(data_chatlog[fetchMode]["nums"]);
				}
				
				var _last_delete_num = 0;
				for (var i=0; i<data_chatlog[fetchMode]["nums"].length - MAX_LOG; i++) {
					var _delete_num = data_chatlog[fetchMode]["nums"].shift();
					_last_delete_num = _delete_num;
					
					$("#area_chatlog_"+fetchMode+" .chatitem_"+_delete_num).remove();
					delete data_chatlog[fetchMode]["logs"][_delete_num];
				}
				
				if (fetchType == "last" || fetchType == "new") {
					//最新読み込みの場合は、古いものを消す
					data_chatlog[fetchMode]["over"]["old"] = true;
				} else {
					//過去読み込みの場合は、新しいものから消す
					data_chatlog[fetchMode]["over"]["new"] = true;
				}
			}
		}
	
		var last_item_hidden = false;
		function genChatItemHTML(_num, _data) {
			
			var _msg = safestr(_data["msg"]);
			
			if (!_data["append"]) {
				var _msg_urls = _msg.match(/https?:\/\/[-_.!~*\'()a-zA-Z0-9;\/?:\@&=+\$,%#]+/g);
				if (_msg_urls && _msg_urls.length > 0) {
					_data["append"] = [{"type": "link", "url": _msg_urls[0]}];
				}
			}
			
			_msg = markdown(_msg);
			_msg = _msg.split("\n").join("<br>");
			//_msg = _msg.autoLink({target: "_blank", rel: "nofollow"});
			_msg = Autolinker.link(_msg, {"newWindow": true, "phone": false, "email": false, "stripPrefix": false, "stripTrailingSlash": false, replaceFn : function( match ) {
		        const tag = match.buildTag();
		        tag.setAttr('rel', 'nofollow');

		        return tag;
		    }});
			
			var _addstyle = "";
			if (_data["color"]) {
				_addstyle = "background:rgba("+parseInt(_data["color"].slice(1, 3), 16)+","+parseInt(_data["color"].slice(3, 5), 16)+","+parseInt(_data["color"].slice(5, 7), 16)+",0.2);";
			}
			
			var _addclass = "";
			if (_data["userid"] == "4ab76") {
				_addclass += " me";
			}
			
			//WSから来た閲覧制限ありは全制限なので、適合者はsignle-fetchでデータ貰う
			last_item_hidden = false;
			if (_data["only"] == "only-owner") {
				if (_data["only-request-data"] && !_data["only-fetched"]) {
					_addclass += " wait-only";
					last_item_hidden = true;
					if (_data["userid"] == "4ab76" || owner) {
						fetchData({"type": "single", "num": _num}, function(err, data){
							if (data["data_list"] && data["data_list"][_num]) {
								data["data_list"][_num]["data"]["only-fetched"] = true;
								parseData(_num, data["data_list"][_num]["data"], "log", "edit-only-fetched");
								//ChatScrollLast(false, "log");
							}
						});
					}
				} else if (_data["only-hidden"]) {
					_addclass += " hidden-only";
					last_item_hidden = true;
				}
			}
			
			var _html = "";
			_html += "<div class='chatitem_"+_num+" chatitem "+_addclass+"' data-userid='"+_data["userid"]+"' data-bs-theme='light'>";
			_html += "<div class='bg' style='"+_addstyle+"'>";
			_html += "	<div class='menu divlink'><a href='javascript:openChatMenu(\""+_num+"\");'></a></div>";
			_html += "	<div class='head'><div class='name'>"+safestr(_data["name"])+"</div><div class='date'>"+_data["date"]+"</div></div>";
			if (_data["mode"]) {
				if (_data["mode"]["mode"] == "reply") {
					_html += "	<div class='divlink'>";
					_html += "		<a href='javascript:linkChatItem(\""+_data["mode"]["num"]+"\");'></a>";
					_html += "		<div class='reply line-1'><font class='reply-head'>返信 : </font>"+safestr(_data["mode"]["reply_data"]["msg"])+"</div>";
					_html += "	</div>";
				}
			}
			_html += "	<div class='msg tab'>"+_msg+"</div>";
			if (_data["append"]) {
				_html += "<div class='flex-list-wrap'>";
				for (var i=0; i<_data["append"].length; i++) {
					if (_data["append"][i]["type"] == "image" || _data["append"][i]["type"] == "link" || _data["append"][i]["type"] == "emotion") {
						
						var _delay = "1";
						if (AddChatArrayBuffer["batch-init"]) {
							_delay = "";
						}
						
						_html += "<div class='cardloader cardloader-"+_data["append"][i]["type"]+"' data-type='"+_data["append"][i]["type"]+"' data-url='"+safestr(_data["append"][i]["url"])+"' data-delay='"+_delay+"'><div class='spinner-border text-warning' role='status'></div></div>";
					}
				}
				_html += "</div>";
			}
			if (_data["func"]) {
				if (_data["func"] == "config_accesschecklist") {
					var _js = 'openRoomConfig("accesscheck");';
					_html += "	<div><a class='btn btn-outline-primary btn-sm' href='javascript:"+_js+"'>アクセス許可の選択</a></div>";
				}
			}
			_html += "	<div class='msg exloader'></div>";
			
			_html += "</div>";
			_html += "</div>";
			
			return _html;
			
		}
		
		var table_markdown = [
			{
				"mode": "global",
				"type": "block",
				"start_mark": "```", 
				"start_tag": "<div class='code'>", 
				"end_mark": "```", 
				"end_tag": "</div>",
				"cut_br": true
			},
			{
				"start_mark": "**", 
				"start_tag": "<b>", 
				"end_mark": "**", 
				"end_tag": "</b>"
			},
			/*
			{
				"start_mark": "*", 
				"start_tag": "<i>", 
				"end_mark": "*", 
				"end_tag": "</i>"
			},
			{
				"start_mark": "_", 
				"start_tag": "<i>", 
				"end_mark": "_", 
				"end_tag": "</i>"
			},
			*/
			{
				"start_mark": "__", 
				"start_tag": "<u>", 
				"end_mark": "__", 
				"end_tag": "</u>"
			},
			{
				"start_mark": "~~", 
				"start_tag": "<s>", 
				"end_mark": "~~", 
				"end_tag": "</s>"
			},
			{
				"start_mark": "||", 
				"start_tag": "<span class='spoiler'>", 
				"end_mark": "||", 
				"end_tag": "</span>"
			},
			{
				"start_mark": "`", 
				"start_tag": "<span class='code'>", 
				"end_mark": "`", 
				"end_tag": "</span>"
			},
			{
				"mode": "line",
				"type": "bq"
			}
		];
		function markdown(_str) {
			var _mdbuffer = [];
			for (var m in table_markdown) {
				if (table_markdown[m]["start_mark"] && _str.indexOf("\\"+table_markdown[m]["start_mark"]) != -1) {
					_str = _str.split("\\"+table_markdown[m]["start_mark"]).join("!!!!MDBUFFERID"+_mdbuffer.length+"!!!!");
					_mdbuffer.push({
						"before": "!!!!MDBUFFERID"+_mdbuffer.length+"!!!!",
						"after": ""+table_markdown[m]["start_mark"]
					});
				}
				
				if (table_markdown[m]["mode"]) {
					if (table_markdown[m]["mode"] == "line") {
						var _line = _str.split("\n");
						var _newstr = "";
						var _next_br_skip = false;
						for (var l in _line) {
							if (_newstr && !_next_br_skip) _newstr += "\n";
							if (table_markdown[m]["type"] == "bq") {
								if (_line[l].indexOf("&gt; ") != -1 && _line[l].indexOf("&gt;") === 0 && (_line[l].split("&gt;").join("")).indexOf(" ") === 0) {
									_line[l] = _line[l].slice(_line[l].indexOf("&gt; ")+"&gt; ".length);
									_line[l] = "<div class='bq'>"+_line[l]+"</div>";
									_next_br_skip = true;
								}
							}
							_newstr += _line[l];
						}
						_str = _newstr;
					} else if (table_markdown[m]["mode"] == "global") {
						if (table_markdown[m]["type"] == "block") {
							if (strcnt(_str, table_markdown[m]["start_mark"]) >= 2) {
								var _pre = _str.substr(0, _str.indexOf(table_markdown[m]["start_mark"]));
								var _mid_start = _str.indexOf(table_markdown[m]["start_mark"]);
								var _mid_tmp = _str.substr(_str.indexOf(table_markdown[m]["start_mark"])+table_markdown[m]["start_mark"].length);
								var _mid = _str.substr(_str.indexOf(table_markdown[m]["start_mark"]), table_markdown[m]["start_mark"].length+_mid_tmp.indexOf(table_markdown[m]["end_mark"])+table_markdown[m]["end_mark"].length);
								var _suf = _str.substr(_pre.length + _mid.length);
								
								var _after = table_markdown[m]["start_tag"] + _mid.slice(table_markdown[m]["start_mark"].length, _mid.length - table_markdown[m]["end_mark"].length) + table_markdown[m]["end_tag"];
								if (table_markdown[m]["cut_br"]) {
									_after = _after.replace(table_markdown[m]["start_tag"]+"\n", table_markdown[m]["start_tag"]);
									if (_suf.indexOf("<br>") === 0) {
										_suf = _suf.slice("<br>".length);
									}
								}
								
								_str = _pre + "!!!!MDBUFFERID"+_mdbuffer.length+"!!!!" + _suf;
								_mdbuffer.push({
									"before": "!!!!MDBUFFERID"+_mdbuffer.length+"!!!!",
									"after": _after
								});
							}
						}
					}
				} else {
					for (var i=0; i<100; i++) {
						if (strcnt(_str, table_markdown[m]["start_mark"]) >= 2) {
							_str = _str.replace(table_markdown[m]["start_mark"], table_markdown[m]["start_tag"]);
							if (table_markdown[m]["cut_firstbr"]) {
								_str = _str.replace(table_markdown[m]["start_tag"]+"\n", table_markdown[m]["start_tag"]);
							}
							_str = _str.replace(table_markdown[m]["end_mark"], table_markdown[m]["end_tag"]);
						} else {
							break;
						}
					}
				}
				
				//console.log("_mdbuffer: ", _mdbuffer);
				for (var i in _mdbuffer) {
					_str = _str.split(_mdbuffer[i]["before"]).join(_mdbuffer[i]["after"]);
				}
			}
			return _str;
		}
		
		function linkChatItem(_num) {
			if ($("#area_chatlog_"+chatlog_mode+" .chatitem_"+_num).length > 0) {
				scrollChatItem(_num);
			} else {
				fetchData({"type": "single", "num": _num}, function(err, data){
					if (err) {
						showToast(err);
						return;
					}
					
					console.log(data["data_list"][_num]);
					
					if (data["data_list"] && data["data_list"][_num]) {
						var _html = genChatItemHTML(_num, data["data_list"][_num]["data"]);
						viewDialogOffcanvasLeft({"title": "返信先", "content": _html});
					} else {
						showToast("既に削除されています。");
					}
				});
			}
		}
			function scrollChatItem(_num) {
				$("#area_chatlog_"+chatlog_mode+" .chatitem_"+_num).stop().animate({
					"borderColor": "#FF0000"
				}, 50, function(){
					$("#area_chatlog_"+chatlog_mode+" .chatitem_"+_num).stop().animate({
						"borderColor": "#eff3f4"
					}, 1000, function(){
						
					});
				});
				
				$("#area_chatlog_"+chatlog_mode+"_master").animate({scrollTop: $("#area_chatlog_"+chatlog_mode+"_master").scrollTop() + ($("#area_chatlog_"+chatlog_mode+" .chatitem_"+_num).position().top - $(window).height() / 4)}, 100);
			}
		
		//cardloader inview
		const observer_inview = new IntersectionObserver(
			function(events){
				events.forEach( (e) => {
					if (e.isIntersecting) {
						if ($(e.target).hasClass("inView")) return;
						
						var _parentMode = $(e.target).closest(".area_chatlog");
						if (!_parentMode || !_parentMode.get(0)) return;
						var _mode = _parentMode.get(0).id.split("area_chatlog_").join("");
					
						e.target.classList.add('inView');
						e.target.classList.remove('outView');
						procCardLoader(_mode, e.target);
					} else {
						if ($(e.target).hasClass("outView")) return;
						
						e.target.classList.remove('inView');
						e.target.classList.add('outView');
					}
				});
			}, 
			{
				threshold: [0,1]
			}
		);
		
		var cacheCardLoader = [];
		function updateCardLoader(_mode) {
			console.log("updateCardLoader: ", _mode);
			
			var _parent = "#area_chatlog_"+_mode+"_master";
			if (_mode == "append") {
				_parent = ".chatinput_append .appendview";
			}
			
			$(""+_parent+" .cardloader").each(function(i, o){
				if (_mode != "append" && _mode != "fixed") {
					if (!$(o).hasClass("inView")) {
						if (!$(o).hasClass("outView")) {
							observer_inview.observe($(o).get(0));
						}
						return;
					}
				}
				
				procCardLoader(_mode, o);
			});
			
			$(""+_parent+" .exloader").each(function(i, o){
				if ($(o).parent().height() >= 500) {
					//$(o).parent().find(".msg .tab").css("height", "auto");
					$(o).addClass("exbutton");
					$(o).bind("click", function(e){
						console.error($(this).parent().find(".tab"));
						$(this).parent().find(".tab").css("max-height", "100%");
						$(this).css("display", "none");
					});
				} else {
					
				}
				$(o).removeClass("exloader");
			});
		}
			function procCardLoader(_mode, o) {
				if ($(o).hasClass("cardloader-checked")) return;
				
				console.log("cardloader: ", $(o).attr("data-type"), $(o).attr("data-url"));
				$(o).addClass("cardloader-checked");
					
				var _scroll = true;
				if (_mode == "append") {
					_scroll = false;
				} else if (_mode == "fixed") {
					_scroll = false;
				}
				
				var _type = $(o).attr("data-type");
				
				getCardLoader($(o).attr("data-url"), $(o).attr("data-delay"), function(data){
					if (!data) return;
					
					var _imgadd = "";
					var _imgonerror = '$(this).attr("src", "img/icon_upload.png?v1");';
					
					var _image = true;
					if (!data.image) {
						_image = false;
						data.image = "img/icon_upload.png?v1";
					}
					if (!data.title) data.title = data.url;
					
					var _url = data.url.toLowerCase();
					var _imgonly = false;
					if (isImagePath(_url)) {
						_imgonly = true;
					} else if (data.description) {
						var _description = data.description.toLowerCase();
						if (isImagePath(_description)) {
							_imgonly = true;
						}
					}
					
		    		var _html = "";
		    		_html += "<div class='cardloader-container divlink'>";
		    		if (_type != "emotion") {
		    			_html += "<a href='"+safestr(data.url)+"' target='_blank' rel='nofollow'></a>";
		    		}
		    		_html += "<div class=''><div><img src='"+safestr(data.image)+"' onerror='"+_imgonerror+"' "+_imgadd+" class='image' /></div></div>";
		    		if (_type != "emotion" && ((!_imgonly || !_image) && (data.title || data.description))) {
		    			_html += "<div class='underarea'>";
		    			if (data.title) {
		    				_html += "<div class='title'>"+safestr(data.title)+"</div>";
		    			}
		    			if (data.description) {
		    				_html += "<div class='description'>"+safestr(data.description)+"</div>";
		    			}
		    			_html += "</div>";
		    		}
		    		_html += "</div>";
		    		$(o).html(_html);
		    		
		    		if (_scroll) {
		    			console.log("getCardLoader: ChatScrollLast call");
		    			ChatScrollLast(false, _mode);
		    		}
		    		
		    		
		    		
				    return;
				});
				
			}
			
				function isImagePath(_url) {
					if (_url.indexOf(".gif") != -1 ||_url.indexOf(".png") != -1 || _url.indexOf(".jpeg") != -1 || _url.indexOf(".jpg") != -1 || _url.indexOf(".webm") != -1) {
						return true;
					}
					return false;
				}
		
			function getCardLoader(_url, _delay, _callback) {
				for (var i in cacheCardLoader) {
					if (cacheCardLoader[i] && cacheCardLoader[i].url == _url) {
						_callback(cacheCardLoader[i]);
						return;
					}
				}
				
				var _delaymax = 500;
				if (!_delay) {
					_delaymax = 1;
				}
				
				setTimeout(function(){
				    $.ajax({
				        url:"cards.php?url="+encodeURIComponent(_url),
				        type:'GET',
				        dataType: "json"
				    }).done(function(data){
				    	if (data["result"] == "OK") {
				    		cacheCardLoader.push(data);
				    		_callback(data);
						    return;
						} else if (data["url"]) {
							data["title"] = data["url"];
				    		cacheCardLoader.push(data);
				    		_callback(data);
						    return;
				    	} else {
				    		_callback();
				    		return;
				    	}
			 	    }).fail(function(){
			 	    	_callback();
			 	    	return;
				    });
			    }, getRandomInt(1, _delaymax));
			}
		
		var chatmenu_num = false;
		var chatmenu_data = false;
		function openChatMenu(_num) {
			closeOffcanvas();
				
			chatmenu_num = _num;
			fetchData({"type": "single", "num": _num}, function(err, data){
				if (err) {
					showToast(err);
					return;
				}
				
				if (data["data_list"] && data["data_list"][_num]) {
					chatmenu_data = data["data_list"][_num];
					var _me = chatmenu_data["me"];
					
					if (chatmenu_data["time_tol_msg"]) {
						$("#dialog_chatmenu .area_tol_msg").html(chatmenu_data["time_tol_msg"]).css("display", "block");
					} else {
						$("#dialog_chatmenu .area_tol_msg").css("display", "none");
					}
					
					if (chatmenu_data["pinned"]) {
						$("#dialog_chatmenu .pinned_on").css("display", "none");
						$("#dialog_chatmenu .pinned_off").css("display", "block");
					} else {
						$("#dialog_chatmenu .pinned_off").css("display", "none");
						$("#dialog_chatmenu .pinned_on").css("display", "block");
					}
					
					if (chatmenu_data["fixed"]) {
						$("#dialog_chatmenu .fixed_on").css("display", "none");
						$("#dialog_chatmenu .fixed_off").css("display", "block");
					} else {
						$("#dialog_chatmenu .fixed_off").css("display", "none");
						$("#dialog_chatmenu .fixed_on").css("display", "block");
					}
					
					if (owner) {
						$("#dialog_chatmenu .include-owner").css("display", "block");
					} else {
						$("#dialog_chatmenu .include-owner").css("display", "none");
					}
					
					if (owner || _me) {
						$("#dialog_chatmenu .include-owner-or-me").css("display", "block");
					} else {
						$("#dialog_chatmenu .include-owner-or-me").css("display", "none");
					}
					
					if (_me) {
						$("#dialog_chatmenu .include-me").css("display", "block");
						$("#dialog_chatmenu .exclude-me").css("display", "none");
					} else {
						$("#dialog_chatmenu .include-me").css("display", "none");
						$("#dialog_chatmenu .exclude-me").css("display", "block");
					}
					
					if (chatmenu_data["data"] && chatmenu_data["data"]["subtype"] && chatmenu_data["data"]["subtype"]["mode"] == "autoreply") {
						$("#dialog_chatmenu .chatmenu-button-ban").css("display", "none");
						$("#dialog_chatmenu .chatmenu-button-autoreply").css("display", "block");
					} else {
						$("#dialog_chatmenu .chatmenu-button-autoreply").css("display", "none");
					}
					
					$("#dialog_chatmenu").offcanvas("show");
				} else {
					showToast("メッセージを取得できませんでした。");
				}
			});
		}
		
			function chatmenuReply() {
				$("#dialog_chatmenu").offcanvas("hide");
				var _num = chatmenu_num;
				
				resetChatinputMode();
				
				chatinput_mode = {
					"mode": "reply",
					"num": _num,
					"reply_data": chatmenu_data["data"]
				};
				
				$(".chatinput_mode .modeview").html("<a href='javascript:linkChatItem(\""+_num+"\");'>"+safestr(chatmenu_data["data"]["name"])+"</a>さんに返信");
				$(".chatinput_mode").css("display", "block");
				
				windowResize();
				
				$("#chatinput").focus();
			}
			
			function chatmenuEdit() {
				if (!owner && room_config["edit_permission"] == "only-owner") {
					showToast("このルームでは、オーナーによって編集機能が停止されています。");
					return;
				}
				
				$("#dialog_chatmenu").offcanvas("hide");
				var _num = chatmenu_num;
				
				resetChatinputMode();
				
				chatinput_mode = {
					"mode": "edit",
					"num": _num,
					//"edit_data": chatmenu_data["data"]
				};
					
				$("#chatinput").html(safestr(chatmenu_data["data"]["msg"]));
				
				$(".chatinput_mode .modeview").html("<a href='javascript:linkChatItem(\""+_num+"\");'>メッセージを編集中</a>");
				$(".chatinput_mode").css("display", "block");
				
				if (chatmenu_data["data"]["append"]) {
					for (var i=0; i<chatmenu_data["data"]["append"].length; i++) {
						addChatInputAppend(chatmenu_data["data"]["append"][i]);
					}
				}
				
				windowResize();
				
				$("#chatinput").focus();
			}
			
			function chatmenuCopy() {
				$("#dialog_chatmenu").offcanvas("hide");
				var _num = chatmenu_num;
				
				clipcopyjs(chatmenu_data["data"]["msg"]);
				showToast("コピーしました。");
			}
				
			function chatmenuDelete() {
				jsonFetch(
					"room.php", 
					"action=deleteData&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&num="+encodeURIComponent(chatmenu_num),
					function(data){
			    		$("#dialog_chatmenu").offcanvas("hide");
			    		$(".chatitem_"+chatmenu_num).remove();
						showToast("削除しました。");
					}
				);
			}
			function chatmenuBAN(_force) {
				if (!_force) {
					viewDialogConfirm({
						"title": "確認", 
						"content": "このユーザーをBANしますか？ 過去の書き込みがすべて削除され、新たな書き込みがブロックされます。"
						},
						function(){
							chatmenuBAN(true);
						},
						function(){
						});
					return
				}
				
				jsonFetch(
					"room.php", 
					"action=banUser&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&num="+encodeURIComponent(chatmenu_num),
					function(data){
						$("#dialog_chatmenu").offcanvas("hide");
						showToast("BANしました。");
					}
				);
			}
			function chatmenuMute(_force) {
				if (!_force) {
					viewDialogConfirm({
						"title": "確認", 
						"content": "このユーザーをミュートしますか？ あなたの画面上だけで、このユーザーの書き込みがすべて非表示になります。"
						},
						function(){
							chatmenuMute(true);
						},
						function(){
						});
					return
				}
				
				if (chatmenu_data && chatmenu_data["data"]["userid"]) {
					var _target_userid = chatmenu_data["data"]["userid"];
					
					if (_target_userid == "4ab76") {
						showToast("自分はミュートできません。");
						return;
					}

					if (!mute_userid[_target_userid]) {
						mute_userid[_target_userid] = {"name": chatmenu_data["data"]["name"], "time": Math.round((new Date()).getTime() / 1000), "hash": "cwp573h6"};
						setConf("mute_userid", JSON.stringify(mute_userid));
						reloadMuteList();
					}
					
					$(".chatitem").each(function(i, o){
						if (_target_userid == $(o).data("userid")) {
							$(o).remove();
						}
					});
					
					$("#dialog_chatmenu").offcanvas("hide");
				} else {
					showToast("このメッセージはミュートできません。");
				}
			}
			
			function chatmenuAutoreplyDisable(_force) {
				if (!_force) {
					viewDialogConfirm({
						"title": "確認", 
						"content": "このAIアシスタントを無効化しますか？"
						},
						function(){
							chatmenuAutoreplyDisable(true);
						},
						function(){
						});
					return
				}
				
				jsonFetch(
					"room.php", 
					"action=disableAutoreply&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&num="+encodeURIComponent(chatmenu_num),
					function(data){
						$("#dialog_chatmenu").offcanvas("hide");
						showToast("無効化しました。");
					}
				);
			}
			
			function chatmenuPinned(_force) {
				jsonFetch(
					"room.php", 
					"action=pinnedData&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&num="+encodeURIComponent(chatmenu_num)+"&force="+encodeURIComponent(_force), 
					function(data){
						$("#dialog_chatmenu").offcanvas("hide");
						
						if (_force == "off") {
							$("#area_chatlog_pinned .chatitem_"+chatmenu_num).remove();
						}
						
						if (data["msg"]) {
							showToast(data["msg"]);
						}
					}
				);
			}
			
			function chatmenuFixed(_force) {
				jsonFetch(
					"room.php", 
					"action=fixedData&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc&num="+encodeURIComponent(chatmenu_num)+"&force="+encodeURIComponent(_force), 
					function(data){
						$("#dialog_chatmenu").offcanvas("hide");
						
						if (_force == "off") {
							//$("#area_chatlog_pinned .chatitem_"+chatmenu_num).remove();
						}
						
						if (data["msg"]) {
							showToast(data["msg"]);
						}
					}
				);
			}
	
	function getChatLogHeight(_mode) {
		return document.getElementById("area_chatlog_"+_mode+"_master").scrollHeight;
	}
	function ChatScrollLast(_force, _mode) {
		console.log("ChatScrollLast: ", _force, _mode, data_chatlog[_mode]);
		if (!_mode) _mode = chatlog_mode;
		
		if (!_force && !data_chatlog[_mode]["requestFirstScroll"] && timeout_scroll) return;
		
		if (_force || data_chatlog[_mode]["requestFirstScroll"] || data_chatlog[_mode]["scroll_magnet_bottom"]) {
			
			console.log("ChatScrollLast: reasons: ", _force, data_chatlog[_mode]["requestFirstScroll"], data_chatlog[_mode]["scroll_magnet_bottom"]);
			
			$("#area_chatlog_"+_mode+"_master").scrollTop( getChatLogHeight(_mode) + $("#area_chatlog_"+_mode+"_master").height() );
			
			$("#area_chatlog_"+_mode+"_master .scroll_magnet_bottom").css({"display": "none"});
			$("#area_chatlog_"+_mode+"_master .scroll_magnet_bottom .inner").css({"border-color": "#eff3f4", "background-color": "rgba(160,160,160,0.2)"});
			
			if (_force) {
				data_chatlog[_mode]["scroll_magnet_bottom"] = true;
			}
		}
	}

	function AddLog(_msg) {
		$("#area_status").html(_msg);
	}
	
	var checkPermissionWriteCallbackSuccess = false;
	function checkPermissionWrite(_callback_success) {
		loadRoomConfig("", function(data){
			if (room_config["permission_write"]) {
				_callback_success();
				return;
			}
			
			checkPermissionWriteCallbackSuccess = _callback_success;
			$("#dialog_login_password_write .wrong_password").css("display", "none");
			$("#dialog_login_password_write").modal("show");
		});
	}
		function loginPasswordWrite() {
			loadRoomConfig("login-write", function(data){
				if (room_config["permission_write"]) {
					$("#dialog_login_password_write").modal("hide");
					if (checkPermissionWriteCallbackSuccess) {
						checkPermissionWriteCallbackSuccess();
						checkPermissionWriteCallbackSuccess = false;
					}
					return;
				}
				
				$("#dialog_login_password_write .wrong_password").css("display", "block");
				$("#dialog_login_password_write").modal("show");
			});
		}
	
	var room_config = {};
	var owner = false;
	function loadRoomConfig(_mode, _callback) {
		var _query = "&hash=cwp573h6&action=getRoomConfig&csrf_token_check=77a6556db546d525b7b4682783e342dc";
		
		if (_mode == "login-owner") {
			_query += "&login_password_owner="+encodeURIComponent($("#login_password_owner").val());
		}
		if (_mode == "login-write") {
			_query += "&login_password_write="+encodeURIComponent($("#login_password_write").val());
		}
		
	    $.ajax({
	        url: "room.php",
	        type: 'POST',
	        dataType: "json",
	        data: _query
	    }).done(function(data){
	    	if (data["result"] == "OK") {
	    		room_config = data;
	    		if (data["owner"]) {
	    			owner = true;
	    		} else {
	    			owner = false;
	    		}
	    		_callback(data);
			    return;
	    	} else {
	    		showToast("エラーが発生しました。再度お試しください。");
	    		_callback(false);
	    	}
 	    }).fail(function(){
 	    	showToast("ネットワークエラーが発生しました。再度お試しください。");
 	    	_callback(false);
	    });
	}
	
		function openRoomConfig(_mode) {
			if (_mode == undefined) {
				$("#dialog_configselect").offcanvas("show");
				return;
			}
			
			$("#dialog_configselect").offcanvas("hide");
			
			loadRoomConfig(_mode, function(data){
	    		$(".dialog_config_inner").css("display", "none");
	    		if (data["owner"]) {
	    			$("#config_title").val(data["title"]);
	    			
	    			$("#config_access_permission").val(data["access_permission"]);
	    			$("#config_password_access").val(data["password_access"]);
	    			
	    			$("#config_password_owner").val(data["password_owner"]);
	    			$("#config_write_permission").val(data["write_permission"]);
	    			$("#config_read_permission").val(data["read_permission"]);
	    			$("#config_edit_permission").val(data["edit_permission"]);
	    			
	    			$("#config_password_write").val(data["password_write"]);
	    			
	    			$("#config_tol_write").val(data["tol_write"]);
	    			$("#config_tol_room").val(data["tol_room"]);
	    			if (data["tol_room_msg"]) {
	    				$(".dialog_config_inner .area_tol_room_msg").html(data["tol_room_msg"]).css("display", "block");
	    			} else {
	    				$(".dialog_config_inner .area_tol_room_msg").css("display", "none");
	    			}
	    			
	    			$("#config_progress_write").val(data["progress_write"]);
	    			
	    			var _accesschecklist = "";
	    			for (var i=0; i<data["list_access"].length; i++) {
	    				var _new_style = "display:none;";
	    				var _old_style = "display:block;";
	    				var _allow = "";
	    				var _deny = "";
	    				if (data["list_access"][i]["access"] == "req") {
	    					_new_style = "display:block;";
	    					_old_style = "display:none;";
	    				} else if (data["list_access"][i]["access"] == "allow") {
	    					_allow = "selected";
	    				} else if (data["list_access"][i]["access"] == "deny") {
	    					_deny = "selected";
	    				}
	    				_accesschecklist += '<div id="accesscheck_'+i+'" class="card" style="margin-bottom:5px;">';
	    				_accesschecklist += '	<div class="card-body">';
	    				_accesschecklist += '		<div class="flex-leftright">';
	    				_accesschecklist += '			<div><b>'+safestr(data["list_access"][i]["name"])+'</b><br>'+data["list_access"][i]["date"]+'</div>';
	    				_accesschecklist += '			<div class="new" style="'+_new_style+'"><a href="javascript:accesscheckRoomConfig('+i+', \''+data["list_access"][i]["id_enc"]+'\', 1);" class="btn btn-outline-primary">許可</a> <a href="javascript:accesscheckRoomConfig('+i+', \''+data["list_access"][i]["id_enc"]+'\', -1);" class="btn btn-outline-danger">拒否</a></div>';
	    				_accesschecklist += '			<div class="old" style="'+_old_style+'"><select class="form-control old_value" onchange="accesscheckRoomConfig('+i+', \''+data["list_access"][i]["id_enc"]+'\', this.value);"><option value="1" '+_allow+'>許可</option><option value="-1" '+_deny+'>拒否</option></select></div>';
	    				_accesschecklist += '		</div>';
	    				_accesschecklist += '	</div>';
	    				_accesschecklist += '</div>';
	    			}
	    			if (_accesschecklist) {
	    				$("#area_config_accesschecklist .content").html(_accesschecklist);
	    			} else {
	    				$("#area_config_accesschecklist .content").html("<div class='nodata'>リストがありません。</div>");
	    			}
	    			
	    			var _banlist = "";
	    			for (var i=0; i<data["list_ban"].length; i++) {
	    				_banlist += '<div id="banlist_'+i+'" class="card" style="margin-bottom:5px;">';
	    				_banlist += '	<div class="card-body">';
	    				_banlist += '		<div class="flex-leftright">';
	    				_banlist += '			<div><b>'+safestr(data["list_ban"][i]["name"])+'</b><br>'+data["list_ban"][i]["date"]+'</div>';
	    				_banlist += '			<div><a href="javascript:unbanRoomConfig('+i+', \''+data["list_ban"][i]["id_enc"]+'\');" class="btn btn-outline-secondary">解除</a></div>';
	    				_banlist += '		</div>';
	    				_banlist += '	</div>';
	    				_banlist += '</div>';
	    			}
	    			if (_banlist) {
	    				$("#area_config_banlist .content").html(_banlist);
	    			} else {
	    				$("#area_config_banlist .content").html("<div class='nodata'>リストがありません。</div>");
	    			}
	    			
	    			updateRoomConfigView();
	    			
	    			$("#area_config_basic").css("display", "block");
	    			
	    			if (_mode == "accesscheck") {
	    				openRoomConfigAccessCheckList();
	    			}
	    		} else {
	    			if (_mode == "login-owner") {
	    				showToast("オーナーパスワードが間違っています。");
	    			}
	    			
	    			$("#area_config_login").css("display", "block");
	    		}
	    		$("#dialog_config").offcanvas("show");
			});
		}
		
			function saveRoomConfig() {
				if (!owner) return true;
				
				var _query = "&hash=cwp573h6&action=saveRoomConfig&csrf_token_check=77a6556db546d525b7b4682783e342dc";
				_query += "&config_title="+encodeURIComponent($("#config_title").val());
				
				_query += "&config_password_owner="+encodeURIComponent($("#config_password_owner").val());
				
				_query += "&config_access_permission="+encodeURIComponent($("#config_access_permission").val());
				_query += "&config_password_access="+encodeURIComponent($("#config_password_access").val());
				
				_query += "&config_write_permission="+encodeURIComponent($("#config_write_permission").val());
				_query += "&config_password_write="+encodeURIComponent($("#config_password_write").val());
				
				_query += "&config_read_permission="+encodeURIComponent($("#config_read_permission").val());
				_query += "&config_edit_permission="+encodeURIComponent($("#config_edit_permission").val());
				
				_query += "&config_tol_write="+encodeURIComponent($("#config_tol_write").val());
				_query += "&config_tol_room="+encodeURIComponent($("#config_tol_room").val());
				
				_query += "&config_progress_write="+encodeURIComponent($("#config_progress_write").val());
				
				jsonFetch(
					"room.php", 
					_query,
					function(data){
			    		//$(".room_title").text(""+$("#config_title").val());
			    		$("#dialog_config").offcanvas("hide");
			    		
			    		refreshRoomConfig(function(){
			    		});
			    		
					}
				);
			}
			
			function deleteRoom(_force) {
				if (!_force) {
					viewDialogConfirm({
						"title": "確認", 
						"content": "このルームを削除してもよろしいですか？削除したルームは復旧できません。"
						},
						function(){
							deleteRoom(true);
						},
						function(){
						});
					return
				}
				
			    $.ajax({
			        url:"room.php",
			        type:'POST',
			        data:"action=deleteRoom&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc",
			        dataType: "json"
			    }).done(function(data){
			    	if (data["result"] == "OK") {
			    		location.reload();
					    return;
			    	} else if (data["msg"]) {
			    		showToast(data["msg"]);
			    	} else {
			    		showToast("システムエラーが発生しました。再度お試しください。");
			    	}
		 	    }).fail(function(){
			    	showToast("ネットワークエラーが発生しました。再度お試しください。");
			    });
			}
	
	function openUserConfig(_mode) {
		$("#dialog_configselect").offcanvas("hide");
		
		$("#config_sound_newuser").val(loadCookieConfig("config_sound_newuser", ""));
		$("#config_sound_newmessage").val(loadCookieConfig("config_sound_newmessage", ""));
		
		$("#config_post_enter").val(loadCookieConfig("config_post_enter", ""));
		
		$("#config_softalk").val(loadCookieConfig("config_softalk", ""));
		$("#config_softalk_name").val(loadCookieConfig("config_softalk_name", ""));
		$("#config_softalk_cutoff").val(loadCookieConfig("config_softalk_cutoff", ""));
		$("#config_softalk_speed").val(loadCookieConfig("config_softalk_speed", "1.2"));
		$("#config_softalk_volume").val(loadCookieConfig("config_softalk_volume", "50"));
		
		$(".dialog_configuser_inner").css("display", "none");
		$("#area_configuser_basic").css("display", "block");
		
		$("#dialog_configuser").offcanvas("show");
		
		updateUserConfigView();
	}
		function saveUserConfig() {
			saveCookieConfig("config_sound_newuser", $("#config_sound_newuser").val());
			saveCookieConfig("config_sound_newmessage", $("#config_sound_newmessage").val());
			
			saveCookieConfig("config_post_enter", $("#config_post_enter").val());
			
			saveCookieConfig("config_softalk", $("#config_softalk").val());
			saveCookieConfig("config_softalk_name", $("#config_softalk_name").val());
			saveCookieConfig("config_softalk_cutoff", $("#config_softalk_cutoff").val());
			saveCookieConfig("config_softalk_speed", $("#config_softalk_speed").val());
			saveCookieConfig("config_softalk_volume", $("#config_softalk_volume").val());
			
			dummyClickIfNeeded();
		}
		
	var cookieConfig = false;
	function loadCookieConfig(_key, _default) {
		if (!cookieConfig) {
			var _tmp = cookie.get("cookie_chaat_config");
			try {
				cookieConfig = JSON.parse(_tmp);
			} catch(e) {
				cookieConfig = false;
			}
			if (!cookieConfig) {
				cookieConfig = {};
			}
		}
		if (!_key) return "";
		
		var _val = cookieConfig[_key];
		if (_val == undefined) {
			return _default
		}
		
		return _val;
	}
		
	function saveCookieConfig(_key, _value) {
		if (!cookieConfig) {
			loadCookieConfig();
		}
		cookieConfig[_key] = _value;
		
		cookie.set("cookie_chaat_config", JSON.stringify(cookieConfig));
	}
	
	var chatlog_mode = "log";
	function changeChatlogMode(_mode) {
		$(".chatlog_master").css("display", "none");
		
		if (chatlog_mode == _mode) {
			$(".icon-"+_mode).removeClass("icon-toggle-on");
			$("#area_chatlog_log_master").css("display", "block");
			chatlog_mode = "log";
			return;
		}
		
		$(".icon-"+chatlog_mode).removeClass("icon-toggle-on");
		
		chatlog_mode = _mode;
		
		$(".icon-"+chatlog_mode).addClass("icon-toggle-on");
		$("#area_chatlog_"+chatlog_mode+"_master").css("display", "block");
		
		if (chatlog_mode != "search") {
			fetchData({"mode": chatlog_mode});
		}
	}
	function openPinned() {
		changeChatlogMode("pinned");
	}
	
	function openSearch() {
		//changeChatlogMode("search");
		//$("#dialog_search").offcanvas("show");
		if ($(".area_search_box").css("display") == "block") {
			$("#search_q").val("");
			$(".area_search_box").css("display", "none");
			
			if (chatlog_mode == "search") {
				changeChatlogMode("log");
			}
			
			windowResize();
			return;
		}
		
		$(".area_search_box").css("display", "block");
		windowResize();
	}
		$(function(){
			var timeout_search_q = false;
			$("#search_q").bind("keydown", function(e){
				if (timeout_search_q) {
					clearTimeout(timeout_search_q);
				}
				timeout_search_q = setTimeout(function(){
					timeout_search_q = false;
					
					if (chatlog_mode != "search") {
						changeChatlogMode("search");
					}
					if ($("#search_q").val() != "") {
						fetchData({"mode": "search", "clean": true});
					}
				}, 150);
			});
		});
	
	var time_lastfetch = (new Date()).getTime();
	function main() {
		//1秒～20秒に1回
		
		var _fetchTimeout = 5;
		if (ws_connect) { //WS接続中は15秒に1回
			_fetchTimeout = 15;
			
			//vcamLocalID
		    vcamPolling();
		    vcamKeepaliveCheck();
		}
		if ((new Date()).getTime() - time_lastfetch >= _fetchTimeout*1000) {
			time_lastfetch = (new Date()).getTime();
			fetchData({"mode": "log"});
		}
	
	}
</script>

<script>
	//アップローダー
	function finishUpload(_url) {
		addChatInputAppend({"type": "link", "url": _url});
	}
	function uploadCancelAlt() {
		$("#area_toast_upload").toast('hide');
	}
	function updateUploadStatusAlt(_percent, _message) {
		//showToast(_message);
		
		$(".area_fileupload").css("display", "block");
		
		if (_message) {
			$("#area_toast_upload .msg").html(_message);
		}
		if (_percent && _percent !== false) {
			$("#area_toast_upload .uploadprogress").css("width", ""+_percent+"%");
		}
		
		if ($("#area_toast_upload").css("display") == "none") {
			$("#button_uploadcancel").bind("click", function(e){
				uploadCancel();
			});
			$("#area_toast_upload").toast('show');
		}
		
	}
	function viewUploadErrorAlt(_code, _message) {
		if (_message) {
			showToast(_message);
		} else {
			showToast("アップロード中にエラーが発生しました: "+_code+"");
		}
	}
	
	

</script>

<script>
	//プッシュ通知
	
	var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
	function openPush() {
		if (getStatusPush() == "enable") {
			//WebPushが許可されている
			checkPushHash(function(res){
				if (res) {
					if (res["push"] == "on") {
						disablePushHash(function(){
							if (res && res["result"] == "OK") {
								showToast("プッシュ通知をオフにしました。");
							}
						});
					} else if (res["push"] == "off") {
						enablePushHash(function(){
							if (res && res["result"] == "OK") {
								showToast("プッシュ通知をオンにしました。");
							}
						});
					}
				}
			});
		} else {
			//WebPushが許可されていない
			enablePush(function(status, data){
				if (status == "error") {
					if (isSafari) {
						showToast("iOS/iPadOS環境では、「ホーム画面に追加」してホーム画面から開くとプッシュ通知をオンにできます。");
					} else {
						showToast("プッシュ通知の設定中にエラーが発生しました。");
					}
				} else if (status == "denied") {
					showToast("プッシュ通知が拒否されました。");
				} else if (status == "enable") {
					registWebPushToken(data, function(res){
						if (res && res["result"] == "OK") {
							enablePushHash(function(res){
								if (res && res["result"] == "OK") {
									showToast("プッシュ通知をオンにしました。");
								}
							});
						}
					});
				}
			});
		}
	}
	
		function checkPushHash(_callback) {
			$.ajax({
			    url: "_push_server.php",
			    type: "POST",
			    data: "action=checkPushHash&platform=WebPush&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc"
			}).done(function(res){
				if (_callback) {
					_callback(res);
				}
				if (res) {
					if (res["push"] == "on") {
						push_enable = true;
					} else if (res["push"] == "off") {
						push_enable = false;
					}
					updatePushIcon();
				}
			}).fail(function(){
				if (_callback) {
					_callback(false);
				}
			});
		}
		
			var push_enable = false;
			function updatePushIcon() {
				if (push_enable && push_data) {
					$(".icon-bell").addClass("icon-toggle-on");
				} else {
					$(".icon-bell").removeClass("icon-toggle-on");
				}
			}
		
		function enablePushHash(_callback) {
			$.ajax({
			    url: "_push_server.php",
			    type: "POST",
			    data: "action=enablePushHash&platform=WebPush&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc"
			}).done(function(res){
				if (_callback) {
					_callback(res);
				}
				if (res && res["result"] == "OK") {
					push_enable = true;
					updatePushIcon();
				}
			}).fail(function(){
				if (_callback) {
					_callback(false);
				}
			});
		}
	
	
		function disablePushHash(_callback) {
			$.ajax({
			    url: "_push_server.php",
			    type: "POST",
			    data: "action=disablePushHash&platform=WebPush&hash=cwp573h6&csrf_token_check=77a6556db546d525b7b4682783e342dc"
			}).done(function(res){
				if (_callback) {
					_callback(res);
				}
				if (res && res["result"] == "OK") {
					push_enable = false;
					updatePushIcon();
				}
			}).fail(function(){
				if (_callback) {
					_callback(false);
				}
			});
		}
	
		function registWebPushToken(data, _callback) {
			$.ajax({
			    url: "_push_server.php",
			    type: "POST",
			    data: "action=registWebPushToken&platform=WebPush&csrf_token_check=77a6556db546d525b7b4682783e342dc&endpoint="+encodeURIComponent(data["endpoint"])+"&key="+encodeURIComponent(data["key"])+"&auth="+encodeURIComponent(data["auth"])+"&contentEncoding="+encodeURIComponent(data["contentEncoding"])
			}).done(function(res){
				if (_callback) {
					_callback(res);
				}
			}).fail(function(){
				if (_callback) {
					_callback(false);
				}
			});
		}
	
	var push_data = false;
	$(function(){
		statusPush(function(status, data){
			if (status == "disable") {
				push_data = false;
				push_enable = false;
				updatePushIcon();
			} else if (status == "enable") {
				push_data = data;
				registWebPushToken(data, function(res){
					checkPushHash();
				});
			}
		});
		
		document.addEventListener("visibilitychange", (e) => {
			if (document.visibilityState === "hidden") {
				window_display_status = false;
			} else {
				window_display_status = true;
				sendMessagePush({"action": "clear", "id": "cwp573h6"});
			}
		});
	});
</script>

<div id="dialog_confirm" class="modal" tabindex="-1">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="title modal-title">
					
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="content modal-body">
	
			</div>
			<div class="modal-footer">
				<button onclick="dialogConfirmOK();" type="button" class="btn-ok btn btn-primary">OK</button>
				<button onclick="dialogConfirmCancel();" type="button" class="btn-cancel btn btn-secondary">キャンセル</button>
			</div>
		</div>
	</div>
</div>
<script>
	var dialogConfirmCancelCallback = false;
	var dialogConfirmOKCallback = false;
	function viewDialogConfirm(_opt, _callback_ok, _callback_cancel) {
		dialogConfirmOKCallback = _callback_ok;
		dialogConfirmCancelCallback = _callback_cancel;
		
		if (_callback_ok) {
			$("#dialog_confirm .btn-ok").css("display", "block");
		} else {
			$("#dialog_confirm .btn-ok").css("display", "none");
		}
		
		if (_callback_cancel) {
			$("#dialog_confirm .btn-cancel").css("display", "block");
		} else {
			$("#dialog_confirm .btn-cancel").css("display", "none");
		}
		
		$("#dialog_confirm .title").html(_opt["title"]);
		$("#dialog_confirm .content").html(_opt["content"]);
		
		if (_opt["req-choose"]) {
			$("#dialog_confirm").data({"bs-backdrop": "static", "bs-keyboard": "false"});
		} else {
			$("#dialog_confirm").data({"bs-backdrop": "", "bs-keyboard": ""});
		}
		
		if (_opt["button-cancel"]) {
			$("#dialog_confirm .btn-cancel").text(_opt["button-cancel"]);
		} else {
			$("#dialog_confirm .btn-cancel").text("キャンセル");
		}
		
		if (_opt["button-ok"]) {
			$("#dialog_confirm .btn-ok").text(_opt["button-ok"]);
		} else {
			$("#dialog_confirm .btn-ok").text("OK");
		}
		
		$("#dialog_confirm").modal("show");
	}
		$(function(){
			document.getElementById('dialog_confirm').addEventListener('hide.bs.modal', function (event) {
				if (dialogConfirmCancelCallback) {
					dialogConfirmCancelCallback();
					dialogConfirmCancelCallback = false;
				}
			})
		});
		function dialogConfirmOK() {
			$("#dialog_confirm").modal("hide");
			
			if (dialogConfirmOKCallback) {
				dialogConfirmOKCallback();
				dialogConfirmOKCallback = false;
			}
		}
		function dialogConfirmCancel() {
			$("#dialog_confirm").modal("hide");
			
			if (dialogConfirmCancelCallback) {
				dialogConfirmCancelCallback();
				dialogConfirmCancelCallback = false;
			}
		}
</script>



<div id="dialog_login" class="modal fade" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title title" id="staticBackdropLabel">ログイン</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="contents" style="padding:20px;">
    	
			      
      		<div style="margin-bottom:10px;">
				<script type="text/javascript" src="https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js"></script>

				<div class="flex-center">
					<div id="appleid-signin" data-color="black" data-border="true" data-type="sign in" style="height:30px;width:185px;cursor:pointer;"></div>
					<script>
					AppleID.auth.init({
					clientId : 'lu.kuku.auth',
					redirectURI : 'https://auth.kuku.lu/callback.apple.php',
					state : '{"service":"chaat","hash":"cwp573h6","back":"\/cwp573h6"}',
					scope: 'email'
					});
					</script>
			    </div>
			</div>
						
      		<div style="margin-bottom:10px;">
				<script src="https://accounts.google.com/gsi/client" async defer></script>
				<div id="g_id_onload"
				data-client_id="669712644646-oumsbv0udjcgl8oa2c06rma5mrfq7sus.apps.googleusercontent.com"
				data-callback="onGoogleLogin"
				data-auto_prompt="false">
				</div>

				<div class="flex-center">
						<div class="g_id_signin" data-type="standard" data-logo_alignment="center" data-width="185" data-size="medium"></div>
						<script>
						function onGoogleLogin(googleUser) {
							var _token = googleUser.credential;
							location.href = "https://auth.kuku.lu/callback.google.php?auth_service=chaat&token="+encodeURIComponent(_token)+"&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D";
						}
						</script>
			    </div>
			</div>
			
			<div style="margin-bottom:10px;">
				<div class="flex-center">
					<div class="linkidbox">
						<a href="https://auth.kuku.lu/request.php?auth_service=chaat&auth_provider=discord&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D" style="text-decoration: none;"><div style="text-align:center;width:185px;background-color:rgb(86,98,246);color:white;padding:5px;border-radius:5px;"><img src="img/icon-app-discord.png?v1" width="16" border="0"> Discord でログイン</div></a>
					</div>
			    </div>
		    </div>
		    	
			<div class="flex-center">
				<div style="width:185px;text-align:center;">
					<a href="https://auth.kuku.lu/request.php?auth_service=chaat&auth_provider=twitter&twitterauth_manual=1&auth_state=%7B%22service%22%3A%22chaat%22%2C%22hash%22%3A%22cwp573h6%22%2C%22back%22%3A%22%5C%2Fcwp573h6%22%7D" style="text-decoration: none;"><div style="background-color:#1da1f2;color:white;padding:5px;border-radius:5px;"><img src="img/icon-app-twitter.png" width="16" border="0"> Twitter でログイン</div></a>
				</div>
			</div>

      </div>
    </div>
  </div>
</div>
<script>
	$(function(){
		var dialog_login = document.getElementById('dialog_login');
		dialog_login.addEventListener('hide.bs.modal', function (e) {
		});
		
	});

	function openLogin() {
		$("#dialog_login").modal("show");
	}
</script>
	
<div id="dialog_menu" class="offcanvas offcanvas-start" tabindex="-1">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">
    	    		<a href="./"><img src="img/minilogo.png" style="width:80px;" border="0"></a>
   		    </h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
	    
	    			<div style="margin-bottom:30px;">
			  
				<div class="card">
				  <ul class="list-group list-group-flush">
					  <li class="list-group-item divlink divlink_hover">
						<a href="./"></a>
						<div class="flex-leftright">
							<div>トップページ</div>
							<div>
								<div class="flex-right">
									<div>
									</div>

									<div class="menu-rightallowbox divlink">
									</div>
								</div>
							<div>
						</div>
				      </li>
					  <li class="list-group-item divlink divlink_hover">
					  	<a href="/?action=createRoom"></a>
						<div class="flex-leftright">
							<div>新規ルーム作成</div>
							<div>
								<div class="flex-right">
									<div>
									</div>

									<div class="menu-rightallowbox divlink">
									</div>
								</div>
							<div>
					    </div>
				      </li>
				  </ul>
				</div>
			  
			</div>
		      	  
		<div style="margin-bottom:30px;">
			
		    				<h6>
					履歴
				</h6>
						
			<div class="area_history">
			</div>
		</div>
			
		<div style="margin-bottom:30px;">
			<h6>
				アカウント
			</h6>
		
											<div class="alert alert-warning" role="alert">
					連携ID(google)でログイン中
				</div>
				
										<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>もやし猫@管理者だよ#dbec</div>
									<div>
																					<a href="" class="btn btn-outline-secondary" style="pointer-events:none;">使用中</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@管理者かもよ#dbec</div>
									<div>
																					<a href="javascript:switchID('TFUmNkm2PRZILYMrT3j4jbUciBmM44CK1GBifB2E0pPGsngVmqrqvmiV%2FpUspHhYwgwX7iiUwXaM9IsW7KBRjQ%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>もやし猫＠管理者かもね#dbec</div>
									<div>
																					<a href="javascript:switchID('0dhsOzioz47S5IVAdDBcx9iX8un%2BVC5RbzARV2CeDZDV7OTrQWvjybdJqOe6vYBloQYylab1iqQJPmt2vFt27A%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@もやしだよ#dbec</div>
									<div>
																					<a href="javascript:switchID('0x3tZo8XgkHkNJhU35cKr9FHbeTtmlbQi%2FTqq1WVL1iF76j8G8u4Es7iLWDhIdOi8CrtippYiwPYjFP3eVTDGg%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
												<div id="" class="card" style="margin-bottom:5px;">
							<div class="card-body">
								<div class="flex-leftright">
									<div>syosinni@管理者らしき者#dbec</div>
									<div>
																					<a href="javascript:switchID('%2BwCRKB91U4srPFMLOdayi%2BV5ozH4G%2BOCSdP89WlTpPIzamJfFotP3hBmH%2Blwc%2BVBvx6VxwRWLhbZzuiTBphXuw%3D%3D');" class="btn btn-secondary">切り替え</a>
																			</div>
								</div>
							</div>
						</div>
										
				<div style="margin-top:10px;">
				    <div class="flex-right">
						<div><a class="btn btn-sm btn-outline-danger" href="javascript:confirmLogout();">連携解除</a></div>
				    </div>
			    </div>
					    	
	    </div>
      	  
  </div>
</div>
<script>
	$(function(){
		var dialog_menu = document.getElementById('dialog_menu');
		dialog_menu.addEventListener('hide.bs.offcanvas', function () {
			
		});
	});
	
	var cache_history = false;
	function openMenu() {
		jsonFetch(
			"api_server.php", 
			"&action=getHistory&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
			function(data){
				cache_history = data;
				
				var _buffer = "";
				for (var i in data["history"]) {
					var _item = data["history"][i];
					
					_buffer += '<li class="list-group-item divlink divlink_hover">';
					_buffer += '	<a href="/'+_item["hash"]+'"></a>';
					_buffer += '	<div class="flex-leftright">';
					_buffer += '		<div style="position:relative;width:100%;">';
					if (_item["new"]) {
						_buffer += '			<div style="position:absolute;width:10px;height:10px;border-radius:5px;background:red;opacity:0.6;top:0;bottom:0;margin:auto;right:0;"></div>';
					}
					_buffer += '			<div class="line-1" style="padding-right:10px;">'+safestr(_item["title"])+'</div>';
					_buffer += '		</div>';
					_buffer += '		<div>';
					_buffer += '			<div class="flex-right">';
					_buffer += '				<div></div>';
					_buffer += '				<div class="menu-rightallowbox divlink"></div>';
					_buffer += '			</div>';
					_buffer += '		<div>';
					_buffer += '	</div>';
					_buffer += '</li>';
					
				}
				
				if (_buffer) {
					_buffer = '<div class="card"><ul class="list-group list-group-flush">' + _buffer + '</ul></div>';
					
					_buffer += '<div class="flex-right" style="margin-top:10px;">';
					_buffer += '	<div><a class="btn btn-sm btn-outline-danger" href="javascript:openHistoryDelete();">削除</a></div>';
					_buffer += '</div>';
				} else {
					_buffer = '<div style="padding-top:5px;">記録なし</div>';
				}
				
				$(".area_history").html(_buffer);
				$("#dialog_menu").offcanvas("show");
			}
		);
		
	}
		function openHistoryDelete() {
			var _buffer = "";
			for (var i in cache_history["history"]) {
				var _item = cache_history["history"][i];
				var _js = "deleteHistory('"+_item["hash"]+"');";
				
				_buffer += '<li class="list_history_'+_item["hash"]+' list-group-item">';
				_buffer += '	<div class="flex-leftright">';
				_buffer += '		<div style="position:relative;width:100%;">';
				_buffer += '			<div class="line-1" style="padding-right:10px;">'+safestr(_item["title"])+'</div>';
				_buffer += '		</div>';
				_buffer += '		<div>';
				_buffer += '			<div class="flex-right" style="padding:5px;">';
				_buffer += '				<div><a class="btn btn-close" href="javascript:'+_js+'"></a></div>';
				_buffer += '			</div>';
				_buffer += '		<div>';
				_buffer += '	</div>';
				_buffer += '</li>';
				
			}
			
			if (!_buffer) return;
			
			_buffer = '<div class="card"><ul class="list-group list-group-flush">' + _buffer + '</ul></div>';
			
			_buffer += '<div class="flex-right" style="margin-top:10px;">';
			_buffer += '	<div><a class="btn btn-primary" href="javascript:openMenu();">完了</a></div>';
			_buffer += '</div>';
			
			$(".area_history").html(_buffer);
		}
			function deleteHistory(_hash) {
				jsonFetch(
					"api_server.php", 
					"&action=deleteHistory&hash="+encodeURIComponent(_hash)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc", 
					function(data){
						$(".list_history_"+_hash).remove();
					}
				);
			}
	
	function switchID(_login_token) {
		jsonFetch(
			"./api_server.php", 
			"action=switchID&login_token="+encodeURIComponent(_login_token)+"&csrf_token_check=77a6556db546d525b7b4682783e342dc",
			function(data){
		    	if (data["result"] == "OK") {
		    		location.reload();
		    	} else {
		    		showToast("システムエラーが発生しました。");
		    	}
			}
		);
	}
	
	function confirmLogout(_force) {
		if (!_force) {
			viewDialogConfirm({
				"title": "確認", 
				"content": "連携を解除してもよろしいですか？"
				},
				function(){
					confirmLogout(true);
				},
				function(){
				});
			return
		}
		
		jsonFetch(
			"./api_server.php", 
			"action=unlinkID&csrf_token_check=77a6556db546d525b7b4682783e342dc",
			function(data){
		    	if (data["result"] == "OK") {
		    		location.reload();
		    	} else {
		    		showToast("システムエラーが発生しました。");
		    	}
			}
		);
	}
</script>
</body>
</html>
